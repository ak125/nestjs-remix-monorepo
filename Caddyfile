# üöÄ Configuration Caddy pour NestJS + Remix Monorepo
# Date: 21 octobre 2025
# Production-ready reverse proxy avec redirections SEO

# ===== CONFIGURATION GLOBALE =====
{
    # Email pour certificats Let's Encrypt (remplacez par le v√¥tre)
    email admin@your-domain.com
    
    # Options de performance
    admin off
    auto_https on
    
    # Logs globaux
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 10
            roll_keep_for 720h
        }
        format json
        level INFO
    }
}

# ===== SITE PRINCIPAL =====
# Remplacez "your-domain.com" par votre nom de domaine
your-domain.com {
    
    # ===== REDIRECTIONS 301 PI√àCES AUTO =====
    # Ces r√®gles seront g√©n√©r√©es automatiquement via le script
    # generate-caddy-config.sh et ins√©r√©es ici
    
    # Exemple de redirection manuelle (√† supprimer apr√®s g√©n√©ration auto)
    # redir /pieces/ancien-slug/* /pieces/nouveau-slug/{uri} 301
    
    # ===== ASSETS STATIQUES AVEC CACHE =====
    # Cache agressif pour assets avec hash (build)
    @hashed path /build/*
    
    handle @hashed {
        header Cache-Control "public, max-age=31536000, immutable"
        reverse_proxy monorepo_prod:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # Cache mod√©r√© pour autres assets statiques
    @static path *.css *.js *.png *.jpg *.jpeg *.gif *.svg *.woff *.woff2 *.ttf *.eot *.ico *.webp *.avif /public/* /assets/*
    
    handle @static {
        header Cache-Control "public, max-age=86400"
        reverse_proxy monorepo_prod:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # ===== TOUTES LES AUTRES ROUTES (API + FRONTEND) =====
    # Le monorepo g√®re tout : NestJS backend + Remix frontend
    reverse_proxy monorepo_prod:3000 {
        # En-t√™tes de proxy
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        
        # Health checks au format Caddy v2
        health_checks {
            active {
                path /health
                interval 30s
                timeout 5s
                expect_status 2xx
            }
        }
        
        # Timeouts adapt√©s (API + SSR)
        transport http {
            dial_timeout 10s
            response_header_timeout 60s
            read_buffer_size 4096
        }
    }
    
    # ===== GESTION DES ERREURS =====
    handle_errors {
        @404 {
            expression {http.error.status_code} == 404
        }
        @500 {
            expression {http.error.status_code} >= 500
        }
        
        # Redirection personnalis√©e pour 404
        redir @404 /404 302
        
        # Page d'erreur pour 500+
        respond @500 "Une erreur est survenue. Veuillez r√©essayer plus tard." 500
    }
    
    # ===== HEADERS DE S√âCURIT√â =====
    header {
        # S√©curit√© basique
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # HSTS (d√©sactiv√© en dev, activer en prod)
        # Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # CSP (√† adapter selon vos besoins)
        # Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
        
        # Permissions Policy
        Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
        
        # Retirer les headers qui r√©v√®lent des infos serveur
        -Server
        -X-Powered-By
    }
    
    # ===== COMPRESSION =====
    encode gzip zstd
    
    # ===== LOGGING SP√âCIFIQUE AU DOMAINE =====
    log {
        output file /var/log/caddy/your-domain.log {
            roll_size 50mb
            roll_keep 5
        }
        format json {
            time_format "2006-01-02T15:04:05Z07:00"
            message_key "message"
        }
        level INFO
    }
}

# ===== REDIRECTION WWW VERS APEX =====
www.your-domain.com {
    redir https://your-domain.com{uri} permanent
}

# ===== CONFIGURATION LOCALE (D√âVELOPPEMENT) =====
# D√©commentez pour tester en local
# localhost:80, localhost:443 {
#     reverse_proxy localhost:3000
# }
