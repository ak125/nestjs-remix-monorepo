#!/bin/bash

# ========================================
# TESTS CURL AVANC√âS - MODULE PAIEMENTS LEGACY
# ========================================
# Tests complets pour l'API des paiements bas√©e sur les vraies tables legacy
# Tables utilis√©es: ___xtr_order, ic_postback

API_BASE="http://localhost:3000"
API_PAYMENTS="${API_BASE}/api/payments"

# Couleurs pour les logs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fonction d'affichage
log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

log_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

log_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# Fonction pour tester une r√©ponse
test_response() {
    local response="$1"
    local expected_status="$2"
    local test_name="$3"
    
    echo "----------------------------------------"
    log_info "TEST: $test_name"
    
    # Extraire le code de statut HTTP
    status_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | head -n -1)
    
    echo "Status Code: $status_code"
    echo "Response Body:"
    echo "$body" | jq '.' 2>/dev/null || echo "$body"
    
    if [ "$status_code" -eq "$expected_status" ]; then
        log_success "Test r√©ussi - Status $status_code"
    else
        log_error "Test √©chou√© - Attendu $expected_status, re√ßu $status_code"
    fi
    echo ""
}

# V√©rifier que le serveur est d√©marr√©
check_server() {
    log_info "V√©rification de la disponibilit√© du serveur..."
    response=$(curl -s -w "\n%{http_code}" "$API_BASE/health" 2>/dev/null || echo -e "\n000")
    status_code=$(echo "$response" | tail -n1)
    
    if [ "$status_code" -eq 000 ]; then
        log_error "Serveur non accessible sur $API_BASE"
        log_info "Assurez-vous que le serveur NestJS est d√©marr√© avec: npm run dev"
        exit 1
    else
        log_success "Serveur accessible (Status: $status_code)"
    fi
}

echo "========================================"
echo "üöÄ TESTS CURL - MODULE PAIEMENTS LEGACY"
echo "========================================"
echo "Base URL: $API_BASE"
echo "Endpoints test√©s: /api/payments/*"
echo "Tables legacy: ___xtr_order, ic_postback"
echo "========================================"

check_server

# ========================================
# 1. TEST DES STATISTIQUES
# ========================================
log_info "üìä SECTION 1: Tests des statistiques"

response=$(curl -s -w "\n%{http_code}" \
    -H "Content-Type: application/json" \
    "$API_PAYMENTS/stats")
test_response "$response" 200 "R√©cup√©ration des statistiques de paiement"

# ========================================
# 2. CR√âATION D'UN NOUVEAU PAIEMENT
# ========================================
log_info "üí≥ SECTION 2: Cr√©ation de paiements"

# Test avec donn√©es valides
response=$(curl -s -w "\n%{http_code}" \
    -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "ord_cst_id": "81500",
        "ord_total_ttc": "125.50",
        "ord_currency": "EUR",
        "payment_gateway": "STRIPE",
        "return_url": "https://example.com/success",
        "cancel_url": "https://example.com/cancel",
        "callback_url": "https://example.com/callback",
        "payment_metadata": {
            "product_type": "test",
            "campaign": "curl_test"
        }
    }' \
    "$API_PAYMENTS")
test_response "$response" 201 "Cr√©ation d'un paiement valide"

# Extraire l'ID du paiement cr√©√© pour les tests suivants
if [ $? -eq 0 ]; then
    CREATED_ORDER_ID=$(echo "$response" | head -n -1 | jq -r '.ord_id // empty' 2>/dev/null)
    if [ -n "$CREATED_ORDER_ID" ] && [ "$CREATED_ORDER_ID" != "null" ]; then
        log_success "Paiement cr√©√© avec ID: $CREATED_ORDER_ID"
    fi
fi

# Test avec donn√©es invalides - montant manquant
response=$(curl -s -w "\n%{http_code}" \
    -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "ord_cst_id": "81500",
        "payment_gateway": "STRIPE"
    }' \
    "$API_PAYMENTS")
test_response "$response" 400 "Cr√©ation avec donn√©es manquantes (doit √©chouer)"

# Test avec gateway invalide
response=$(curl -s -w "\n%{http_code}" \
    -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "ord_cst_id": "81500",
        "ord_total_ttc": "99.99",
        "payment_gateway": "GATEWAY_INEXISTANTE"
    }' \
    "$API_PAYMENTS")
test_response "$response" 400 "Cr√©ation avec gateway invalide (doit √©chouer)"

# ========================================
# 3. TESTS DE R√âCUP√âRATION DE STATUT
# ========================================
log_info "üîç SECTION 3: R√©cup√©ration de statuts"

# Test avec une commande existante (utiliser un ID de la vraie table)
response=$(curl -s -w "\n%{http_code}" \
    -H "Content-Type: application/json" \
    "$API_PAYMENTS/280001/status")
test_response "$response" 200 "R√©cup√©ration du statut d'une commande existante"

# Test avec ID nouvellement cr√©√© (si disponible)
if [ -n "$CREATED_ORDER_ID" ]; then
    response=$(curl -s -w "\n%{http_code}" \
        -H "Content-Type: application/json" \
        "$API_PAYMENTS/${CREATED_ORDER_ID}/status")
    test_response "$response" 200 "R√©cup√©ration du statut du paiement cr√©√©"
fi

# Test avec ID inexistant
response=$(curl -s -w "\n%{http_code}" \
    -H "Content-Type: application/json" \
    "$API_PAYMENTS/999999/status")
test_response "$response" 404 "R√©cup√©ration d'un paiement inexistant (doit √©chouer)"

# ========================================
# 4. INITIATION DE PAIEMENT
# ========================================
log_info "üöÄ SECTION 4: Initiation de paiements"

# Test d'initiation avec une commande existante
if [ -n "$CREATED_ORDER_ID" ]; then
    response=$(curl -s -w "\n%{http_code}" \
        -X POST \
        -H "Content-Type: application/json" \
        -d '{
            "payment_gateway": "CYBERPLUS",
            "return_url": "https://example.com/success",
            "cancel_url": "https://example.com/cancel",
            "callback_url": "https://example.com/callback"
        }' \
        "$API_PAYMENTS/${CREATED_ORDER_ID}/initiate")
    test_response "$response" 200 "Initiation du paiement cr√©√©"
fi

# Test d'initiation avec commande existante de la vraie table
response=$(curl -s -w "\n%{http_code}" \
    -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "payment_gateway": "STRIPE",
        "return_url": "https://example.com/success",
        "cancel_url": "https://example.com/cancel"
    }' \
    "$API_PAYMENTS/280001/initiate")
test_response "$response" 200 "Initiation avec commande legacy existante"

# Test d'initiation avec commande inexistante
response=$(curl -s -w "\n%{http_code}" \
    -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "payment_gateway": "PAYPAL"
    }' \
    "$API_PAYMENTS/999999/initiate")
test_response "$response" 404 "Initiation avec commande inexistante (doit √©chouer)"

# ========================================
# 5. TESTS DE CALLBACKS
# ========================================
log_info "üîî SECTION 5: Tests des callbacks de paiement"

# Callback CYBERPLUS succ√®s
response=$(curl -s -w "\n%{http_code}" \
    -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "transactionId": "TXN_' $(date +%s) '",
        "orderId": "280001",
        "amount": "17.49",
        "currency": "EUR",
        "status": "SUCCESS",
        "gateway_response": {
            "response_code": "00",
            "auth_code": "123456"
        }
    }' \
    "$API_PAYMENTS/callback/cyberplus")
test_response "$response" 200 "Callback CYBERPLUS succ√®s"

# Callback STRIPE succ√®s
response=$(curl -s -w "\n%{http_code}" \
    -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "transactionId": "pi_test_' $(date +%s) '",
        "orderId": "280002",
        "amount": "196.13",
        "currency": "EUR",
        "status": "PAID",
        "gateway_response": {
            "payment_intent": "pi_test_example",
            "charge_id": "ch_test_example"
        }
    }' \
    "$API_PAYMENTS/callback/stripe")
test_response "$response" 200 "Callback STRIPE succ√®s"

# Callback PAYPAL avec √©chec
response=$(curl -s -w "\n%{http_code}" \
    -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "transactionId": "PAYPAL_' $(date +%s) '",
        "orderId": "280003",
        "amount": "105.91",
        "currency": "EUR",
        "status": "FAILED",
        "gateway_response": {
            "error_code": "INSUFFICIENT_FUNDS",
            "error_message": "Insufficient funds in account"
        }
    }' \
    "$API_PAYMENTS/callback/paypal")
test_response "$response" 200 "Callback PAYPAL √©chec"

# Callback avec donn√©es invalides
response=$(curl -s -w "\n%{http_code}" \
    -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "invalid_field": "invalid_value"
    }' \
    "$API_PAYMENTS/callback/stripe")
test_response "$response" 400 "Callback avec donn√©es invalides (doit √©chouer)"

# ========================================
# 6. TESTS AVANC√âS - RECHERCHE PAR TRANSACTION
# ========================================
log_info "üîé SECTION 6: Recherche avanc√©e"

# Test de recherche par ID de transaction (si on en a cr√©√© un)
SAMPLE_TXN_ID="TXN_$(date +%s)"
response=$(curl -s -w "\n%{http_code}" \
    -H "Content-Type: application/json" \
    "$API_PAYMENTS/transaction/${SAMPLE_TXN_ID}")
test_response "$response" 404 "Recherche par transaction inexistante"

# ========================================
# 7. TESTS DE CALLBACKS HISTORY
# ========================================
log_info "üìú SECTION 7: Historique des callbacks"

# R√©cup√©ration des callbacks pour une commande
response=$(curl -s -w "\n%{http_code}" \
    -H "Content-Type: application/json" \
    "$API_PAYMENTS/280001/callbacks")
test_response "$response" 200 "R√©cup√©ration de l'historique des callbacks"

# ========================================
# 8. TESTS DE STRESS ET EDGE CASES
# ========================================
log_info "‚ö° SECTION 8: Tests de stress et cas limites"

# Test avec tr√®s gros montant
response=$(curl -s -w "\n%{http_code}" \
    -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "ord_cst_id": "81500",
        "ord_total_ttc": "999999.99",
        "ord_currency": "EUR",
        "payment_gateway": "BANK_TRANSFER"
    }' \
    "$API_PAYMENTS")
test_response "$response" 201 "Cr√©ation avec montant √©lev√©"

# Test avec montant n√©gatif (doit √©chouer)
response=$(curl -s -w "\n%{http_code}" \
    -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "ord_cst_id": "81500",
        "ord_total_ttc": "-50.00",
        "payment_gateway": "STRIPE"
    }' \
    "$API_PAYMENTS")
test_response "$response" 400 "Cr√©ation avec montant n√©gatif (doit √©chouer)"

# Test avec caract√®res sp√©ciaux dans les m√©tadonn√©es
response=$(curl -s -w "\n%{http_code}" \
    -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "ord_cst_id": "81500",
        "ord_total_ttc": "25.00",
        "payment_gateway": "CYBERPLUS",
        "payment_metadata": {
            "description": "Paiement avec √©mojis üöÄüí≥‚úÖ",
            "special_chars": "√†√©√®√π@#$%^&*()",
            "unicode": "ÊµãËØï —Ç–µ—Å—Ç „ÉÜ„Çπ„Éà"
        }
    }' \
    "$API_PAYMENTS")
test_response "$response" 201 "Cr√©ation avec caract√®res sp√©ciaux"

# ========================================
# 9. TESTS DE PERFORMANCE - REQU√äTES MULTIPLES
# ========================================
log_info "üèÉ SECTION 9: Tests de performance"

log_info "Test de 5 requ√™tes statistiques simultan√©es..."
for i in {1..5}; do
    curl -s "$API_PAYMENTS/stats" > /dev/null &
done
wait
log_success "Requ√™tes simultan√©es termin√©es"

# ========================================
# 10. V√âRIFICATION FINALE DES DONN√âES
# ========================================
log_info "üîÑ SECTION 10: V√©rification finale"

# V√©rifier que les stats ont √©t√© mises √† jour
response=$(curl -s -w "\n%{http_code}" \
    -H "Content-Type: application/json" \
    "$API_PAYMENTS/stats")
test_response "$response" 200 "V√©rification finale des statistiques"

# Afficher un r√©sum√© des donn√©es
log_info "Extraction des m√©triques finales..."
final_stats=$(echo "$response" | head -n -1 | jq '.' 2>/dev/null)
if [ $? -eq 0 ]; then
    echo "üìä STATISTIQUES FINALES:"
    echo "$final_stats"
fi

echo ""
echo "========================================"
log_success "TESTS CURL TERMIN√âS !"
echo "========================================"
log_info "üéØ Tous les endpoints de l'API payments ont √©t√© test√©s"
log_info "üìã V√©rifiez les logs ci-dessus pour les d√©tails"
log_info "üîß En cas d'erreurs, v√©rifiez que le serveur NestJS est d√©marr√©"
log_info "üíæ Les donn√©es sont persist√©es dans les tables legacy PostgreSQL"
echo "========================================"
