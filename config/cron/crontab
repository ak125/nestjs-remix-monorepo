# ðŸ“… SUPERCRONIC CRONTAB - SYSTÃˆME UNIFIÃ‰ V2
# Format: minute hour day month weekday command
# Container: docker-compose.worker.yml (Supercronic + BullMQ)

# =====================================================
# ðŸ—ºï¸ SITEMAPS - StratÃ©gie V2 optimale
# =====================================================
# Architecture:
# - Delta quotidien: dÃ©tecte les URLs modifiÃ©es (Redis hashes)
# - Streaming hebdo: gÃ©nÃ¨re .xml.gz compressÃ©s pour gros volumes
# - Cleanup: nettoie les deltas > 30 jours
# - Ping Google: notification aprÃ¨s gÃ©nÃ©ration

# 1. GÃ©nÃ©ration delta quotidienne (3h) - URLs modifiÃ©es uniquement
0 3 * * * curl -s -X POST http://localhost:3000/sitemap-v2/delta/generate >> /logs/sitemap-delta.log 2>&1

# 2. Streaming complet hebdomadaire (dimanche 2h) - RegÃ©nÃ©ration totale
0 2 * * 0 curl -s -X POST "http://localhost:3000/sitemap-v2/streaming/generate?type=all" >> /logs/sitemap-streaming.log 2>&1

# 3. Cleanup deltas expirÃ©s (4h) - Nettoie Redis
0 4 * * * curl -s -X POST http://localhost:3000/sitemap-v2/delta/cleanup >> /logs/sitemap-cleanup.log 2>&1

# 4. Ping Google aprÃ¨s gÃ©nÃ©ration (3h15)
15 3 * * * curl -s "https://www.google.com/ping?sitemap=https://www.automecanik.com/sitemap.xml"

# =====================================================
# ðŸ“Š SEO LINK TRACKING (Maillage interne)
# =====================================================

# SEO - AgrÃ©gation mÃ©triques quotidiennes (2h30)
30 2 * * * curl -s -X POST http://localhost:3000/api/seo/aggregate >> /logs/seo-aggregate.log 2>&1

# SEO - Nettoyage donnÃ©es > 90 jours (lundis 3h30)
30 3 * * 1 curl -s -X POST "http://localhost:3000/api/seo/cleanup?daysToKeep=90" >> /logs/seo-cleanup.log 2>&1

# =====================================================
# ðŸ”§ MAINTENANCE SYSTÃˆME
# =====================================================

# Cache - Nettoyage Redis (5h)
0 5 * * * node /app/backend/dist/scripts/cleanup-redis-cache.js >> /logs/redis-cleanup.log 2>&1

# Monitoring - VÃ©rification santÃ© systÃ¨me (toutes les heures)
0 * * * * curl -sf http://localhost:3000/health || echo "[$(date)] Health check failed" >> /logs/health.log

# BullMQ - Stats quotidiennes (6h)
0 6 * * * node /app/backend/dist/scripts/bullmq-stats.js >> /logs/bullmq-stats.log 2>&1

# Backup - Dump Redis (1h)
0 1 * * * redis-cli --rdb /backups/redis-$(date +\%Y\%m\%d).rdb 2>&1

# Logs - Rotation (dimanches 23h)
0 23 * * 0 find /logs -name "*.log" -mtime +7 -delete
