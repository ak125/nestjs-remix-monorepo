# üöÄ Configuration Caddy pour NestJS + Remix Monorepo
# Date: 21 octobre 2025
# Production-ready reverse proxy avec redirections SEO

# ===== CONFIGURATION GLOBALE =====
{
    # Email pour certificats Let's Encrypt (remplacez par le v√¥tre)
    email admin@automecanik.fr
    
    # Options de performance
    admin off
    auto_https on
    
    # Logs globaux (format optimis√© pour Vector)
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 10
            roll_keep_for 720h
        }
        format json {
            time_format "iso8601"
            message_key "msg"
            level_key "level"
            name_key "logger"
        }
        level INFO
    }
}

# ===== SITE PRINCIPAL =====
# Configuration pour automecanik.fr
automecanik.fr {
    
    # ===== REDIRECTIONS 301 PI√àCES AUTO =====
    # Ces r√®gles seront g√©n√©r√©es automatiquement via le script
    # generate-caddy-config.sh et ins√©r√©es ici
    
    # Exemple de redirection manuelle (√† supprimer apr√®s g√©n√©ration auto)
    # redir /pieces/ancien-slug/* /pieces/nouveau-slug/{uri} 301
    
    # ===== REDIRECTIONS 301 IMAGES SUPABASE (SEO) =====
    # Pr√©serve les anciennes URLs publiques pour le SEO et liens externes
    # Redirige vers Supabase Storage avec code 301 permanent
    
    # Images produits: /rack/{folder}/{filename} ‚Üí Supabase rack-images bucket
    @rack_images path_regexp rack_path ^/rack/(.+)$
    redir @rack_images https://cxpojprgwgubzjyqzmoq.supabase.co/storage/v1/object/public/rack-images/{re.rack_path.1} 301
    
    # Images uploads: /upload/* ‚Üí Supabase uploads bucket
    # Couvre 8 formats: gammes, familles, constructeurs, √©quipementiers, blog, favicon, etc.
    @upload_images path_regexp upload_path ^/upload/(.+)$
    redir @upload_images https://cxpojprgwgubzjyqzmoq.supabase.co/storage/v1/object/public/uploads/{re.upload_path.1} 301
    
    # ===== ASSETS STATIQUES AVEC CACHE =====
    # Cache agressif pour assets avec hash (build)
    @hashed path /build/*
    
    handle @hashed {
        header Cache-Control "public, max-age=31536000, immutable"
        reverse_proxy monorepo_prod:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # Cache mod√©r√© pour autres assets statiques
    @static path *.css *.js *.png *.jpg *.jpeg *.gif *.svg *.woff *.woff2 *.ttf *.eot *.ico *.webp *.avif /public/* /assets/*
    
    handle @static {
        header Cache-Control "public, max-age=86400"
        reverse_proxy monorepo_prod:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # ===== CACHE INTELLIGENT POUR PAGES PUBLIQUES =====
    # Cache uniquement pour les visiteurs anonymes (sans cookie de session)
    # Les utilisateurs connect√©s passent directement au backend
    
    @public_cached {
        # Seulement les requ√™tes GET/HEAD
        method GET HEAD
        
        # Exclure les routes API
        not path /api/*
        not path /admin/*
        not path /auth/*
        not path /cart/*
        not path /checkout/*
        not path /account/*
        
        # Exclure si cookie de session pr√©sent
        not header_regexp Cookie (?i)(connect\.sid|session)
    }
    
    # Pages publiques cach√©es avec TTL adapt√©
    handle @public_cached {
        # Page d'accueil : cache court (60s)
        @homepage path /
        header @homepage Cache-Control "public, max-age=60, stale-while-revalidate=120"
        
        # Pages produits et pi√®ces : cache moyen (5min)
        @products path_regexp ^/(products|pieces|catalog|vehicule)/
        header @products Cache-Control "public, max-age=300, stale-while-revalidate=600"
        
        # Pages blog et guides : cache long (30min)
        @content path_regexp ^/(blog|guides|articles|conseils)/
        header @content Cache-Control "public, max-age=1800, stale-while-revalidate=3600"
        
        # Pages de recherche : cache tr√®s court (30s)
        @search path /search
        header @search Cache-Control "public, max-age=30, stale-while-revalidate=60"
        
        # Autres pages publiques : cache par d√©faut (2min)
        header Cache-Control "public, max-age=120, stale-while-revalidate=240"
        
        # Headers de variance pour cache correct
        header Vary "Accept-Encoding, Cookie"
        
        reverse_proxy monorepo_prod:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # ===== TOUTES LES AUTRES ROUTES (API + FRONTEND) =====
    # Routes priv√©es et authentifi√©es - JAMAIS de cache
    @private {
        path /api/* /admin/* /auth/* /cart/* /checkout/* /account/*
    }
    
    handle @private {
        header Cache-Control "private, no-cache, no-store, must-revalidate"
        header Pragma "no-cache"
        header Expires "0"
        
        reverse_proxy monorepo_prod:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # Fallback pour toutes les autres routes
    # Fallback pour toutes les autres routes
    # Le monorepo g√®re tout : NestJS backend + Remix frontend
    reverse_proxy monorepo_prod:3000 {
        # En-t√™tes de proxy
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        
        # Health checks au format Caddy v2
        health_checks {
            active {
                path /health
                interval 30s
                timeout 5s
                expect_status 2xx
            }
        }
        
        # Timeouts adapt√©s (API + SSR)
        transport http {
            dial_timeout 10s
            response_header_timeout 60s
            read_buffer_size 4096
        }
    }
    
    # ===== GESTION DES ERREURS =====
    handle_errors {
        @404 {
            expression {http.error.status_code} == 404
        }
        @500 {
            expression {http.error.status_code} >= 500
        }
        
        # Redirection personnalis√©e pour 404
        redir @404 /404 302
        
        # Page d'erreur pour 500+
        respond @500 "Une erreur est survenue. Veuillez r√©essayer plus tard." 500
    }
    
    # ===== HEADERS DE S√âCURIT√â =====
    header {
        # S√©curit√© basique
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # HSTS (d√©sactiv√© en dev, activer en prod)
        # Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # CSP (√† adapter selon vos besoins)
        # Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
        
        # Permissions Policy
        Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
        
        # Retirer les headers qui r√©v√®lent des infos serveur
        -Server
        -X-Powered-By
    }
    
    # ===== COMPRESSION =====
    encode gzip zstd
    
    # ===== LOGGING SP√âCIFIQUE AU DOMAINE (format optimis√© pour Vector) =====
    log {
        output file /var/log/caddy/automecanik.log {
            roll_size 50mb
            roll_keep 5
        }
        format json {
            time_format "iso8601"
            message_key "msg"
            level_key "level"
            name_key "logger"
        }
        level INFO
    }
}

# ===== REDIRECTION WWW VERS APEX =====
www.automecanik.fr {
    redir https://automecanik.fr{uri} permanent
}

# ===== CONFIGURATION LOCALE (D√âVELOPPEMENT) =====
# D√©commentez pour tester en local
# localhost:80, localhost:443 {
#     reverse_proxy localhost:3000
# }
