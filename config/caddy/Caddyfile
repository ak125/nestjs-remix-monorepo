# Configuration Caddy pour NestJS + Remix Monorepo
# Date: 12 decembre 2025
# Production-ready reverse proxy avec Cloudflare + redirections SEO

# ===== CONFIGURATION GLOBALE =====
{
    email admin@automecanik.com
    admin off

    # ðŸ›¡ï¸ Trust Cloudflare IPs pour obtenir la vraie IP client
    servers {
        trusted_proxies static 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22 2400:cb00::/32 2606:4700::/32 2803:f800::/32 2405:b500::/32 2405:8100::/32 2a06:98c0::/29 2c0f:f248::/32
    }
    
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 10
            roll_keep_for 720h
        }
        format json {
            time_format "iso8601"
            message_key "msg"
            level_key "level"
            name_key "logger"
        }
        level INFO
    }
}

# ===== REDIRECTION .FR VERS .COM =====
automecanik.fr, www.automecanik.fr {
    redir https://www.automecanik.com{uri} permanent
}

# ===== SITE PRINCIPAL .COM =====
automecanik.com, www.automecanik.com {
    
    # Redirection apex vers www
    @apex host automecanik.com
    redir @apex https://www.automecanik.com{uri} permanent

    # ===== IMGPROXY - TRANSFORMATION IMAGES GRATUITE =====
    # Route: /imgproxy/{processing_options}/plain/{source_url}@{format}
    # Exemple: /imgproxy/rs:fit:800/q:80/plain/https://supabase.co/.../image.jpg@webp
    # Documentation: https://docs.imgproxy.net/generating_the_url
    @imgproxy path /imgproxy/*
    handle @imgproxy {
        # Cache 1 an (Cloudflare edge + navigateur)
        header Cache-Control "public, max-age=31536000, immutable"
        header Vary "Accept"

        # Strip /imgproxy prefix avant envoi Ã  imgproxy
        uri strip_prefix /imgproxy

        reverse_proxy imgproxy:8080 {
            header_up Host imgproxy
            header_down -Server
        }
    }

    # ===== BLOQUER TRANSFORMATIONS (410 Gone pour dÃ©indexation rapide) =====
    # Retourne 410 pour les URLs avec params de transformation
    # Permet Ã  Googlebot de dÃ©sindexer rapidement les anciennes URLs
    @img_transform {
        path /img/*
        query width=*
    }
    @img_transform_quality {
        path /img/*
        query quality=*
    }
    handle @img_transform {
        respond "Gone" 410
    }
    handle @img_transform_quality {
        respond "Gone" 410
    }

    # ===== PROXY IMAGES BRUTES (fallback, cache 1 an) =====
    # Route: /img/{bucket}/{path} â†’ Supabase /storage/v1/object/public/{bucket}/{path}
    # UtilisÃ© pour images sans transformation ou fallback
    @img_proxy path_regexp img_path ^/img/(.+)$
    handle @img_proxy {
        # Headers de cache (Ã©crase le Cache-Control 1h de Supabase)
        header Cache-Control "public, max-age=31536000, immutable"
        header Vary "Accept"

        # Images brutes sans transformation ($0)
        rewrite * /storage/v1/object/public/{re.img_path.1}

        reverse_proxy https://cxpojprgwgubzjyqzmoq.supabase.co {
            header_up Host cxpojprgwgubzjyqzmoq.supabase.co
            header_down -Cache-Control
        }
    }

    # ===== REDIRECTIONS LEGACY IMAGES (SEO 301) =====
    # URLs historiques stockÃ©es en base â†’ imgproxy (WebP optimisÃ©)
    # PrÃ©serve le PageRank via 301 permanent + images optimisÃ©es

    # /rack/{folder}/{file} â†’ imgproxy WebP (800px, q85)
    @rack_legacy path_regexp rack_path ^/rack/(.+)$
    redir @rack_legacy /imgproxy/rs:fit:800/q:85/plain/https://cxpojprgwgubzjyqzmoq.supabase.co/storage/v1/object/public/rack-images/{re.rack_path.1}@webp permanent

    # /upload/{path} â†’ imgproxy WebP (800px, q85)
    @upload_legacy path_regexp upload_path ^/upload/(.+)$
    redir @upload_legacy /imgproxy/rs:fit:800/q:85/plain/https://cxpojprgwgubzjyqzmoq.supabase.co/storage/v1/object/public/uploads/{re.upload_path.1}@webp permanent

    # ===== SITEMAPS V10 (par temperature + unifie) =====
    # Servis directement depuis /var/www/sitemaps (volume persistant)
    # Inclut: sitemap.xml (index), hot/, new/, stable/, cold/
    @sitemaps path /sitemap*.xml /sitemaps/*
    handle @sitemaps {
        root * /var/www/sitemaps
        header Content-Type "application/xml; charset=utf-8"
        header Cache-Control "public, max-age=3600"
        file_server
    }

    # ===== CRAWL HUBS (HTML pour Googlebot) =====
    # Redirect index crawl â†’ page plan du site propre
    @crawl_index path /__crawl__/index.html
    handle @crawl_index {
        redir /plan-du-site 301
    }

    # Pages de liens internes pour faciliter le crawl Google
    @crawl_hubs path /__crawl__/*
    handle @crawl_hubs {
        root * /var/www/crawl-hubs
        uri strip_prefix /__crawl__

        # SEO Headers - index pour permettre l'indexation des hubs
        header X-Robots-Tag "index, follow"
        header Content-Language "fr"
        header Vary "Accept-Encoding"

        # Cache par dÃ©faut (1h)
        header Cache-Control "public, max-age=3600"

        file_server
    }

    # ===== ASSETS STATIQUES AVEC CACHE =====
    @hashed path /build/*
    handle @hashed {
        header Cache-Control "public, max-age=31536000, immutable"
        reverse_proxy monorepo_prod:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    @static path *.css *.js *.png *.jpg *.jpeg *.gif *.svg *.woff *.woff2 *.ttf *.eot *.ico *.webp *.avif /public/* /assets/*
    handle @static {
        header Cache-Control "public, max-age=86400"
        reverse_proxy monorepo_prod:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # ===== BOT PROTECTION LAYER 2 =====
    # Backup geo-block si Cloudflare bypass (CF-IPCountry header)
    @blocked_country header CF-IPCountry CN
    handle @blocked_country {
        respond "Access Denied" 403
    }

    # Bloquer acces direct (bypass Cloudflare = pas de CF-IPCountry)
    # localhost/loopback autorisÃ© pour health checks CI/CD (self-hosted runner)
    @direct_access {
        not header CF-IPCountry *
        not remote_ip 127.0.0.1 ::1 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22
        not path /health
    }
    handle @direct_access {
        respond "Direct access not allowed" 403
    }

    # ===== CACHE INTELLIGENT POUR PAGES PUBLIQUES =====
    @public_cached {
        method GET HEAD
        not path /api/*
        not path /admin/*
        not path /auth/*
        not path /cart/*
        not path /checkout/*
        not path /account/*
        not header_regexp Cookie (?i)(connect\.sid|session)
    }
    
    handle @public_cached {
        @homepage path /
        header @homepage Cache-Control "public, max-age=60, stale-while-revalidate=120"
        
        # ðŸš€ TTFB Optimization: CDN cache 24h pour pages produit
        @products path_regexp ^/(products|pieces|catalog|vehicule)/
        header @products Cache-Control "public, max-age=300, s-maxage=86400, stale-while-revalidate=3600"
        
        @content path_regexp ^/(blog-pieces-auto|blog|guides|articles|conseils)/
        header @content Cache-Control "public, max-age=1800, stale-while-revalidate=3600"
        
        @search path /search
        header @search Cache-Control "public, max-age=30, stale-while-revalidate=60"
        
        header Cache-Control "public, max-age=120, stale-while-revalidate=240"
        header Vary "Accept-Encoding, Cookie"
        
        reverse_proxy monorepo_prod:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # ===== API CACHEABLE (LCP Optimization) =====
    @api_cacheable {
        path /api/catalog/batch-loader/*
        method GET
    }
    handle @api_cacheable {
        # Laisser le backend dÃ©finir Cache-Control (public, max-age=900)
        reverse_proxy monorepo_prod:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }

    # ===== ROUTES PRIVEES =====
    @private {
        path /api/* /admin/* /auth/* /cart/* /checkout/* /account/*
        not path /api/catalog/batch-loader/*
    }
    handle @private {
        # Headers anti-cache pour navigateur
        header Cache-Control "private, no-cache, no-store, must-revalidate"
        header Pragma "no-cache"
        header Expires "0"
        # Headers anti-cache pour Cloudflare CDN
        header CDN-Cache-Control "no-store"
        header Cloudflare-CDN-Cache-Control "no-store"

        reverse_proxy monorepo_prod:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # ===== FALLBACK =====
    reverse_proxy monorepo_prod:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}

        # Health checks Caddy 2
        health_uri /health
        health_interval 30s
        health_timeout 5s
        health_status 2xx

        transport http {
            dial_timeout 30s
            response_header_timeout 60s
        }
    }
    
    # ===== GESTION DES ERREURS =====
    handle_errors {
        @404 expression {http.error.status_code} == 404
        @500 expression {http.error.status_code} >= 500
        redir @404 /404 302
        respond @500 "Une erreur est survenue. Veuillez reessayer plus tard." 500
    }
    
    # ===== HEADERS DE SECURITE =====
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
        -Server
        -X-Powered-By
    }
    
    encode gzip zstd
    
    log {
        output file /var/log/caddy/automecanik.log {
            roll_size 50mb
            roll_keep 5
        }
        format json {
            time_format "iso8601"
            message_key "msg"
            level_key "level"
            name_key "logger"
        }
        level INFO
    }
}
