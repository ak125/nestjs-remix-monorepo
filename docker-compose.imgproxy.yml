# imgproxy - Service de transformation d'images gratuit
# Documentation: https://docs.imgproxy.net/
#
# Usage:
#   docker compose -f docker-compose.imgproxy.yml up -d
#
# URL Format (imgproxy):
#   /rs:fit:{width}:{height}/q:{quality}/plain/{source_url}@webp
#
# Exemple:
#   http://localhost:8080/rs:fit:800:600/q:80/plain/https://cxpojprgwgubzjyqzmoq.supabase.co/storage/v1/object/public/rack-images/260/6216001.JPG@webp

services:
  imgproxy:
    image: darthsim/imgproxy:latest
    container_name: imgproxy
    environment:
      # Bind address
      IMGPROXY_BIND: ":8080"

      # Security: Only allow Supabase as source
      IMGPROXY_ALLOWED_SOURCES: "https://cxpojprgwgubzjyqzmoq.supabase.co/"

      # WebP/AVIF auto-detection basÃ© sur Accept header (options modernes)
      IMGPROXY_AUTO_WEBP: "true"
      IMGPROXY_AUTO_AVIF: "true"
      IMGPROXY_ENFORCE_WEBP: "false"  # Respecter le format demandÃ©

      # QualitÃ© par dÃ©faut
      IMGPROXY_QUALITY: "80"
      IMGPROXY_AVIF_QUALITY: "75"
      IMGPROXY_WEBP_QUALITY: "80"

      # Limites de rÃ©solution (protection contre abus)
      IMGPROXY_MAX_SRC_RESOLUTION: "50"  # 50 megapixels max
      IMGPROXY_MAX_ANIMATION_FRAMES: "1"  # Pas de GIFs animÃ©s

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸš€ CACHE MÃ‰MOIRE - AmÃ©lioration performance +30-50%
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Cache en mÃ©moire (pas besoin de Redis)
      IMGPROXY_RESULT_CACHE_SIZE: "256"      # 256 images transformÃ©es en cache
      IMGPROXY_SOURCE_CACHE_SIZE: "128"      # 128 images sources en cache

      # Cache headers pour navigateur/CDN (Cloudflare cache 1 an)
      IMGPROXY_CACHE_CONTROL_PASSTHROUGH: "false"
      IMGPROXY_TTL: "31536000"               # 1 an en secondes
      IMGPROXY_SET_CANONICAL_HEADER: "true"

      # Performance
      IMGPROXY_CONCURRENCY: "4"
      IMGPROXY_MAX_CLIENTS: "100"
      IMGPROXY_DOWNLOAD_TIMEOUT: "10"
      IMGPROXY_READ_REQUEST_TIMEOUT: "10"  # Remplace IMGPROXY_READ_TIMEOUT
      IMGPROXY_WRITE_RESPONSE_TIMEOUT: "10"  # Remplace IMGPROXY_WRITE_TIMEOUT

      # Logging
      IMGPROXY_LOG_LEVEL: "warn"
      IMGPROXY_LOG_FORMAT: "json"

      # DÃ©sactiver signature en dev (activer en prod avec IMGPROXY_KEY/SALT)
      IMGPROXY_ALLOW_INSECURE_URLS: "true"

    ports:
      - "8081:8080"
    networks:
      - automecanik-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1'
    healthcheck:
      test: ["CMD", "imgproxy", "health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  automecanik-prod:
    external: true
