version: '3.8'

services:
  # ==============================================================================
  # Vector - Log Router & Enrichment
  # ==============================================================================
  vector:
    image: timberio/vector:0.39.0-alpine
    container_name: vector-seo-pipeline
    restart: unless-stopped
    
    command: ["--config", "/etc/vector/vector.toml"]
    
    env_file:
      - .env.vector
    
    volumes:
      # Configuration Vector
      - ./vector.toml:/etc/vector/vector.toml:ro
      
      # Logs Caddy (read-only)
      - /var/log/caddy:/var/log/caddy:ro
      
      # Logs test (read-only)
      - ./logs:/workspaces/nestjs-remix-monorepo/logs:ro
      
      # Data directory pour checkpoints
      - vector-data:/var/lib/vector
    
    environment:
      # Configuration via env vars
      NODE_ENV: ${NODE_ENV:-production}
      LOKI_URL: ${LOKI_URL:-http://loki:3100}
      MEILISEARCH_HOST: ${MEILISEARCH_HOST:-http://meilisearch:7700}
      MEILISEARCH_API_KEY: ${MEILISEARCH_API_KEY:-masterKey}
      
      # Vector config
      VECTOR_LOG: info
      VECTOR_THREADS: 4
    
    ports:
      # API Vector (monitoring)
      - "8686:8686"
      
      # Prometheus exporter
      - "9598:9598"
    
    networks:
      - seo-pipeline
    
    depends_on:
      - loki
      - meilisearch
    
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8686/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

  # ==============================================================================
  # Loki - Log Aggregation & Time-Series Storage
  # ==============================================================================
  loki:
    image: grafana/loki:2.9.8
    container_name: loki-logs
    restart: unless-stopped
    
    ports:
      - "3100:3100"
    
    volumes:
      - ./loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    
    command: -config.file=/etc/loki/local-config.yaml
    
    networks:
      - seo-pipeline
    
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==============================================================================
  # Grafana - Dashboards & Visualization
  # ==============================================================================
  grafana:
    image: grafana/grafana:10.4.2
    container_name: grafana-dashboards
    restart: unless-stopped
    
    ports:
      - "3001:3000"
    
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: grafana-piechart-panel
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-http://localhost:3001}
      GF_AUTH_ANONYMOUS_ENABLED: "false"
    
    networks:
      - seo-pipeline
    
    depends_on:
      - loki

  # ==============================================================================
  # Meilisearch - Full-Text Search Engine (SEO logs)
  # ==============================================================================
  meilisearch:
    image: getmeili/meilisearch:v1.8.3
    container_name: meilisearch-seo
    restart: unless-stopped
    
    ports:
      - "7700:7700"
    
    volumes:
      - meilisearch-data:/meili_data
    
    environment:
      MEILI_MASTER_KEY: ${MEILISEARCH_API_KEY:-masterKey}
      MEILI_ENV: ${NODE_ENV:-production}
      MEILI_NO_ANALYTICS: "true"
      MEILI_HTTP_ADDR: "0.0.0.0:7700"
      MEILI_DB_PATH: "/meili_data/data.ms"
      MEILI_LOG_LEVEL: INFO
    
    networks:
      - seo-pipeline
    
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:7700/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==============================================================================
  # Prometheus - Metrics Collection (optionnel)
  # ==============================================================================
  prometheus:
    image: prom/prometheus:v2.52.0
    container_name: prometheus-metrics
    restart: unless-stopped
    
    ports:
      - "9090:9090"
    
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    
    networks:
      - seo-pipeline

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  vector-data:
    driver: local
  loki-data:
    driver: local
  grafana-data:
    driver: local
  meilisearch-data:
    driver: local
  prometheus-data:
    driver: local

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  seo-pipeline:
    driver: bridge
