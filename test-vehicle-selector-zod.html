<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test VehicleSelector avec Validation Zod</title>
    <script src="https://unpkg.com/zod@3.22.4/lib/index.umd.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .title {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .test-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .section-title {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .api-test {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .test-result {
            background: #282c34;
            color: #abb2bf;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .warning { border-left: 4px solid #ffc107; }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .validation-log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .zod-schema {
            background: #f1f3f4;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">üß™ Test VehicleSelector avec Validation Zod</h1>
        
        <!-- Section 1: Test des APIs Backend -->
        <div class="test-section">
            <h2 class="section-title">üîå Test des APIs Backend</h2>
            
            <div class="api-test">
                <h3>üìã Test API Marques</h3>
                <button onclick="testBrandsAPI()">Tester /api/vehicles/brands</button>
                <div id="brands-result" class="test-result"></div>
            </div>
            
            <div class="api-test">
                <h3>üìÖ Test API Ann√©es (Renault ID: 140)</h3>
                <button onclick="testYearsAPI()">Tester /api/vehicles/brands/140/years</button>
                <div id="years-result" class="test-result"></div>
            </div>
            
            <div class="api-test">
                <h3>üöó Test API Mod√®les (Renault 2020)</h3>
                <button onclick="testModelsAPI()">Tester /api/vehicles/brands/140/models?year=2020</button>
                <div id="models-result" class="test-result"></div>
            </div>
            
            <div class="api-test">
                <h3>‚öôÔ∏è Test API Types (Captur I 2020)</h3>
                <button onclick="testTypesAPI()">Tester /api/vehicles/models/140001/types?year=2020</button>
                <div id="types-result" class="test-result"></div>
            </div>
        </div>
        
        <!-- Section 2: Test des Sch√©mas Zod -->
        <div class="test-section">
            <h2 class="section-title">üîç Test des Sch√©mas de Validation Zod</h2>
            
            <div class="zod-schema">
                <h3>üìã Sch√©ma VehicleBrand</h3>
                <pre>const VehicleBrandSchema = z.object({
  marque_id: z.number(),
  marque_name: z.string().min(1, "Le nom de la marque est requis"),
  marque_slug: z.string().optional(),
  is_featured: z.boolean().optional(),
  products_count: z.number().optional(),
});</pre>
            </div>
            
            <button onclick="testZodValidation()">üß™ Tester Validation Zod</button>
            <div id="zod-validation-log" class="validation-log"></div>
        </div>
        
        <!-- Section 3: Test du Flow Complet -->
        <div class="test-section">
            <h2 class="section-title">üéØ Test du Flow Complet VehicleSelector</h2>
            
            <button onclick="testCompleteFlow()">üöÄ Tester Flow Complet Marque ‚Üí Ann√©e ‚Üí Mod√®le ‚Üí Type</button>
            <div id="complete-flow-log" class="validation-log"></div>
        </div>
        
        <!-- Section 4: Tests de Performance -->
        <div class="test-section">
            <h2 class="section-title">‚ö° Tests de Performance</h2>
            
            <button onclick="testPerformance()">üìä Tester Performance des APIs</button>
            <div id="performance-log" class="validation-log"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api/vehicles';
        
        // Configuration Zod globale
        const z = window.Zod;
        
        // Sch√©mas Zod (identiques au VehicleSelector)
        const VehicleBrandSchema = z.object({
            marque_id: z.number(),
            marque_name: z.string().min(1, "Le nom de la marque est requis"),
            marque_alias: z.string().optional(),
            is_featured: z.boolean().optional(),
            products_count: z.number().optional(),
        });

        const VehicleModelSchema = z.object({
            modele_id: z.number(),
            modele_name: z.string().min(1, "Le nom du mod√®le est requis"),
            modele_alias: z.string().optional(),
            modele_marque_id: z.number(),
        });

        const VehicleTypeSchema = z.object({
            type_id: z.union([z.number(), z.string()]),
            type_name: z.string().optional(),
            type_alias: z.string().optional(),
            type_fuel: z.string().optional(),
            type_power_ps: z.string().optional(),
            type_liter: z.string().optional(),
            modele_id: z.union([z.number(), z.string()]).optional(),
        });

        // Fonction utilitaire pour logger
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const typeColor = {
                'info': '#61dafb',
                'success': '#98fb98',
                'error': '#ff6b6b',
                'warning': '#ffd93d'
            };
            
            element.innerHTML += `<span style="color: ${typeColor[type] || '#d4d4d4'}">[${timestamp}]</span> ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        // Test API Marques
        async function testBrandsAPI() {
            const resultDiv = document.getElementById('brands-result');
            resultDiv.innerHTML = 'üîÑ Test en cours...\n';
            
            try {
                const startTime = performance.now();
                const response = await fetch(`${API_BASE}/brands`);
                const endTime = performance.now();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const duration = (endTime - startTime).toFixed(2);
                
                resultDiv.innerHTML = `‚úÖ Succ√®s (${duration}ms)\n`;
                resultDiv.innerHTML += `üìä ${data.data?.length || 0} marques trouv√©es\n\n`;
                resultDiv.innerHTML += `üîç Exemples:\n`;
                resultDiv.innerHTML += JSON.stringify(data.data?.slice(0, 3) || [], null, 2);
                resultDiv.className = 'test-result success';
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Erreur: ${error.message}`;
                resultDiv.className = 'test-result error';
            }
        }

        // Test API Ann√©es
        async function testYearsAPI() {
            const resultDiv = document.getElementById('years-result');
            resultDiv.innerHTML = 'üîÑ Test en cours...\n';
            
            try {
                const startTime = performance.now();
                const response = await fetch(`${API_BASE}/brands/140/years`);
                const endTime = performance.now();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const duration = (endTime - startTime).toFixed(2);
                
                resultDiv.innerHTML = `‚úÖ Succ√®s (${duration}ms)\n`;
                resultDiv.innerHTML += `üìä ${data.data?.length || 0} ann√©es trouv√©es\n\n`;
                resultDiv.innerHTML += `üîç Ann√©es r√©centes:\n`;
                resultDiv.innerHTML += JSON.stringify(data.data?.slice(0, 5) || [], null, 2);
                resultDiv.className = 'test-result success';
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Erreur: ${error.message}`;
                resultDiv.className = 'test-result error';
            }
        }

        // Test API Mod√®les
        async function testModelsAPI() {
            const resultDiv = document.getElementById('models-result');
            resultDiv.innerHTML = 'üîÑ Test en cours...\n';
            
            try {
                const startTime = performance.now();
                const response = await fetch(`${API_BASE}/brands/140/models?year=2020`);
                const endTime = performance.now();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const duration = (endTime - startTime).toFixed(2);
                
                resultDiv.innerHTML = `‚úÖ Succ√®s (${duration}ms)\n`;
                resultDiv.innerHTML += `üìä ${data.data?.length || 0} mod√®les trouv√©s\n\n`;
                resultDiv.innerHTML += `üîç Exemples:\n`;
                resultDiv.innerHTML += JSON.stringify(data.data?.slice(0, 3) || [], null, 2);
                resultDiv.className = 'test-result success';
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Erreur: ${error.message}`;
                resultDiv.className = 'test-result error';
            }
        }

        // Test API Types
        async function testTypesAPI() {
            const resultDiv = document.getElementById('types-result');
            resultDiv.innerHTML = 'üîÑ Test en cours...\n';
            
            try {
                const startTime = performance.now();
                const response = await fetch(`${API_BASE}/models/140001/types?year=2020`);
                const endTime = performance.now();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const duration = (endTime - startTime).toFixed(2);
                
                resultDiv.innerHTML = `‚úÖ Succ√®s (${duration}ms)\n`;
                resultDiv.innerHTML += `üìä ${data.data?.length || 0} types trouv√©s\n\n`;
                resultDiv.innerHTML += `üîç Exemples:\n`;
                resultDiv.innerHTML += JSON.stringify(data.data?.slice(0, 3) || [], null, 2);
                resultDiv.className = 'test-result success';
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Erreur: ${error.message}`;
                resultDiv.className = 'test-result error';
            }
        }

        // Test Validation Zod
        async function testZodValidation() {
            log('zod-validation-log', 'üß™ D√©but des tests de validation Zod', 'info');
            
            try {
                // Test donn√©es valides
                const validBrand = {
                    marque_id: 140,
                    marque_name: "RENAULT",
                    marque_alias: "renault",
                    is_featured: true
                };
                
                const brandResult = VehicleBrandSchema.parse(validBrand);
                log('zod-validation-log', '‚úÖ Validation marque r√©ussie: ' + JSON.stringify(brandResult), 'success');
                
                // Test donn√©es invalides
                try {
                    const invalidBrand = {
                        marque_id: "invalid", // Erreur: doit √™tre un nombre
                        marque_name: ""       // Erreur: ne peut pas √™tre vide
                    };
                    VehicleBrandSchema.parse(invalidBrand);
                } catch (zodError) {
                    log('zod-validation-log', '‚ùå Validation √©chou√©e (attendu): ' + zodError.message, 'warning');
                }
                
                // Test mod√®le valide
                const validModel = {
                    modele_id: 140001,
                    modele_name: "CAPTUR I",
                    modele_marque_id: 140
                };
                
                const modelResult = VehicleModelSchema.parse(validModel);
                log('zod-validation-log', '‚úÖ Validation mod√®le r√©ussie: ' + JSON.stringify(modelResult), 'success');
                
                log('zod-validation-log', 'üéâ Tests de validation Zod termin√©s avec succ√®s!', 'success');
                
            } catch (error) {
                log('zod-validation-log', 'üí• Erreur critique: ' + error.message, 'error');
            }
        }

        // Test Flow Complet
        async function testCompleteFlow() {
            log('complete-flow-log', 'üöÄ D√©but du test de flow complet VehicleSelector', 'info');
            
            try {
                // √âtape 1: Charger les marques
                log('complete-flow-log', 'üìã Chargement des marques...', 'info');
                const brandsResponse = await fetch(`${API_BASE}/brands`);
                const brandsData = await brandsResponse.json();
                
                if (brandsData.data && brandsData.data.length > 0) {
                    log('complete-flow-log', `‚úÖ ${brandsData.data.length} marques charg√©es`, 'success');
                    
                    // √âtape 2: S√©lectionner Renault et valider avec Zod
                    const renault = brandsData.data.find(b => b.marque_name === 'RENAULT');
                    if (renault) {
                        VehicleBrandSchema.parse(renault);
                        log('complete-flow-log', '‚úÖ Marque Renault valid√©e avec Zod', 'success');
                        
                        // √âtape 3: Charger les ann√©es
                        log('complete-flow-log', 'üìÖ Chargement des ann√©es pour Renault...', 'info');
                        const yearsResponse = await fetch(`${API_BASE}/brands/${renault.marque_id}/years`);
                        const yearsData = await yearsResponse.json();
                        
                        if (yearsData.data && yearsData.data.length > 0) {
                            log('complete-flow-log', `‚úÖ ${yearsData.data.length} ann√©es trouv√©es`, 'success');
                            
                            // √âtape 4: S√©lectionner 2020 et charger les mod√®les
                            const year2020 = yearsData.data.find(y => y.year === 2020);
                            if (year2020) {
                                log('complete-flow-log', 'üìÖ Ann√©e 2020 s√©lectionn√©e', 'info');
                                
                                const modelsResponse = await fetch(`${API_BASE}/brands/${renault.marque_id}/models?year=2020`);
                                const modelsData = await modelsResponse.json();
                                
                                if (modelsData.data && modelsData.data.length > 0) {
                                    log('complete-flow-log', `‚úÖ ${modelsData.data.length} mod√®les trouv√©s pour 2020`, 'success');
                                    
                                    // √âtape 5: S√©lectionner Captur et valider
                                    const captur = modelsData.data.find(m => m.modele_name.includes('CAPTUR'));
                                    if (captur) {
                                        VehicleModelSchema.parse(captur);
                                        log('complete-flow-log', '‚úÖ Mod√®le Captur valid√© avec Zod', 'success');
                                        
                                        // √âtape 6: Charger les types/motorisations
                                        const typesResponse = await fetch(`${API_BASE}/models/${captur.modele_id}/types?year=2020`);
                                        const typesData = await typesResponse.json();
                                        
                                        if (typesData.data && typesData.data.length > 0) {
                                            log('complete-flow-log', `‚úÖ ${typesData.data.length} motorisations trouv√©es`, 'success');
                                            
                                            // Valider le premier type
                                            const firstType = typesData.data[0];
                                            VehicleTypeSchema.parse(firstType);
                                            log('complete-flow-log', '‚úÖ Motorisation valid√©e avec Zod', 'success');
                                            
                                            log('complete-flow-log', 'üéâ FLOW COMPLET R√âUSSI! Renault Captur 2020 ' + firstType.type_name, 'success');
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                log('complete-flow-log', 'üí• Erreur dans le flow: ' + error.message, 'error');
            }
        }

        // Test Performance
        async function testPerformance() {
            log('performance-log', '‚ö° D√©but des tests de performance', 'info');
            
            const tests = [
                { name: 'Marques', url: `${API_BASE}/brands` },
                { name: 'Ann√©es Renault', url: `${API_BASE}/brands/140/years` },
                { name: 'Mod√®les Renault 2020', url: `${API_BASE}/brands/140/models?year=2020` },
                { name: 'Types Captur 2020', url: `${API_BASE}/models/140001/types?year=2020` }
            ];
            
            for (const test of tests) {
                try {
                    const startTime = performance.now();
                    const response = await fetch(test.url);
                    const endTime = performance.now();
                    const duration = (endTime - startTime).toFixed(2);
                    
                    if (response.ok) {
                        const data = await response.json();
                        const count = data.data?.length || 0;
                        log('performance-log', `‚úÖ ${test.name}: ${duration}ms (${count} √©l√©ments)`, 'success');
                    } else {
                        log('performance-log', `‚ùå ${test.name}: Erreur HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log('performance-log', `üí• ${test.name}: ${error.message}`, 'error');
                }
            }
            
            log('performance-log', 'üìä Tests de performance termin√©s', 'info');
        }
    </script>
</body>
</html>