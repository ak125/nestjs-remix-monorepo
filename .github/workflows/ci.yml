name: ğŸš€ Deploy
on:
  push:
    branches:
      - main
      - dev
  pull_request: {}

permissions:
  actions: write
  contents: read

jobs:
  lint:
    name: â¬£ ESLint
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Application
        run: npm run build

      - name: ğŸ”¬ Lint
        run: npm run lint

  typecheck:
    name: Ê¦ TypeScript
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Application
        run: npm run build

      - name: ğŸ” Type check
        run: npm run typecheck --if-present

  build:
    name: ğŸ³ build
    uses: ./.github/workflows/build.yml
    secrets: inherit

  deploy:
    name: ğŸš€ Deploy
    runs-on: [self-hosted, Linux, X64]
    needs: [build, lint, typecheck]
    # needs: [build]
    # only build/deploy main branch on pushes
    # if: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') && github.event_name == 'push' }}
    if: ${{ (github.ref == 'refs/heads/main') && github.event_name == 'push' }}
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4.1.1
      
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      #   - name: ğŸš€ Run Docker Compose on Staging
      #     if: ${{ github.ref == 'refs/heads/dev' }}
      #     env:
      #       NODE_ENV: staging
      #     run: |
      #       docker pull massdoc/nestjs-remix-monorepo:latest
      #       docker compose -f docker-compose.staging.yaml up -d
      #       docker system prune --all --volumes --force

      - name: Setup Node.js for sitemap generation
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸš€ Run Docker Compose on Production
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          set -e

          echo "ğŸ“¦ Pull de l'image Docker..."
          docker pull massdoc/nestjs-remix-monorepo:production

          PROD_DIR=~/production

          echo "ğŸ“ CrÃ©ation des dossiers..."
          mkdir -p $PROD_DIR/config/caddy
          mkdir -p $PROD_DIR/public/sitemaps
          mkdir -p $PROD_DIR/logs/caddy

          echo "ğŸ”„ Synchronisation depuis Git..."
          cp -v $GITHUB_WORKSPACE/docker-compose.prod.yml $PROD_DIR/
          cp -v $GITHUB_WORKSPACE/docker-compose.caddy.yml $PROD_DIR/
          cp -v $GITHUB_WORKSPACE/config/caddy/Caddyfile $PROD_DIR/config/caddy/
          touch $PROD_DIR/config/caddy/caddy-pieces-redirects.conf

          echo "âœ… Fichiers synchronisÃ©s:"
          ls -la $PROD_DIR/*.yml

          cd $PROD_DIR

          echo "ğŸŒ Configuration rÃ©seau..."
          docker network create automecanik-prod 2>/dev/null || true

          echo "ğŸ›‘ ArrÃªt des anciens conteneurs..."
          docker stop nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true
          docker rm nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true

          echo "ğŸš€ DÃ©marrage des conteneurs..."
          docker compose -f docker-compose.prod.yml -f docker-compose.caddy.yml up -d

          echo "â³ Attente du dÃ©marrage (20s)..."
          sleep 20

          echo "ğŸ” VÃ©rification des conteneurs..."
          docker ps | grep nestjs-remix || { echo "âŒ Conteneurs non trouvÃ©s!"; exit 1; }

          echo "ğŸ¥ Health check..."
          curl -sf http://localhost:3000/health || { echo "âŒ Health check failed!"; exit 1; }

          echo "ğŸ§¹ Nettoyage des images..."
          docker image prune -f

          echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s!"

      - name: ğŸ—ºï¸ Generate static sitemaps (si nÃ©cessaire)
        if: ${{ github.ref == 'refs/heads/main' }}
        run: |
          PROD_DIR=~/production
          SITEMAP_FILE="$PROD_DIR/public/sitemaps/sitemap.xml"
          MAX_AGE_DAYS=7

          # VÃ©rifier si les sitemaps existent et sont rÃ©cents
          if [ -f "$SITEMAP_FILE" ]; then
            FILE_AGE=$(( ($(date +%s) - $(stat -c %Y "$SITEMAP_FILE")) / 86400 ))
            if [ $FILE_AGE -lt $MAX_AGE_DAYS ]; then
              echo "âœ… Sitemaps rÃ©cents ($FILE_AGE jours) - gÃ©nÃ©ration ignorÃ©e"
              ls -la $PROD_DIR/public/sitemaps/
              exit 0
            fi
            echo "âš ï¸ Sitemaps anciens ($FILE_AGE jours) - rÃ©gÃ©nÃ©ration nÃ©cessaire..."
          else
            echo "ğŸ“ Sitemaps absents - gÃ©nÃ©ration initiale..."
          fi

          # Charger les variables d'environnement depuis le .env de production
          if [ -f "$PROD_DIR/.env" ]; then
            echo "ğŸ“‚ Chargement des variables depuis $PROD_DIR/.env"
            set -a
            source $PROD_DIR/.env
            set +a
          fi

          echo "ğŸ“¦ Installation des dÃ©pendances backend..."
          cd $GITHUB_WORKSPACE/backend
          npm install --include=dev

          echo "ğŸ—ºï¸ GÃ©nÃ©ration des sitemaps statiques (714k URLs)..."
          mkdir -p $PROD_DIR/public/sitemaps
          export OUTPUT_DIR="$PROD_DIR/public/sitemaps"
          npx ts-node scripts/generate-sitemaps.ts

          echo "âœ… Sitemaps gÃ©nÃ©rÃ©s dans $PROD_DIR/public/sitemaps/"
          ls -la $PROD_DIR/public/sitemaps/

          echo "ğŸ”„ Rechargement de Caddy..."
          docker exec nestjs-remix-caddy caddy reload --config /etc/caddy/Caddyfile || docker restart nestjs-remix-caddy
