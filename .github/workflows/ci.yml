name: üöÄ Deploy
on:
  push:
    branches:
      - main
      - dev
  pull_request: {}

permissions:
  actions: write
  contents: read

jobs:
  lint:
    name: ‚¨£ ESLint
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Application
        run: npm run build

      - name: üî¨ Lint
        run: npm run lint

  typecheck:
    name:  ¶ TypeScript
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Application
        run: npm run build

      - name: üîé Type check
        run: npm run typecheck --if-present

  build:
    name: üê≥ build
    uses: ./.github/workflows/build.yml
    secrets: inherit

  deploy:
    name: üöÄ Deploy
    runs-on: [self-hosted, Linux, X64]
    needs: [build, lint, typecheck]
    # needs: [build]
    # only build/deploy main branch on pushes
    # if: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') && github.event_name == 'push' }}
    if: ${{ (github.ref == 'refs/heads/main') && github.event_name == 'push' }}
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true

    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4.1.1
      
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      #   - name: üöÄ Run Docker Compose on Staging
      #     if: ${{ github.ref == 'refs/heads/dev' }}
      #     env:
      #       NODE_ENV: staging
      #     run: |
      #       docker pull massdoc/nestjs-remix-monorepo:latest
      #       docker compose -f docker-compose.staging.yaml up -d
      #       docker system prune --all --volumes --force

      - name: Setup Node.js for sitemap generation
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üöÄ Run Docker Compose on Production
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          docker pull massdoc/nestjs-remix-monorepo:production

          # Dossier de production sur le serveur
          PROD_DIR="/home/deploy/app"

          # Synchroniser les fichiers docker-compose depuis Git
          cp $GITHUB_WORKSPACE/docker-compose.prod.yml $PROD_DIR/
          cp $GITHUB_WORKSPACE/docker-compose.caddy.yml $PROD_DIR/
          mkdir -p $PROD_DIR/config
          cp -r $GITHUB_WORKSPACE/config/caddy $PROD_DIR/config/

          # Cr√©er le dossier pour les sitemaps
          mkdir -p $PROD_DIR/public/sitemaps

          cd $PROD_DIR

          # Cr√©er le r√©seau externe s'il n'existe pas
          docker network create automecanik-prod 2>/dev/null || true

          # Arr√™ter et supprimer les anciens conteneurs s'ils existent
          docker stop nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true
          docker rm nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true

          # D√©marrer avec la nouvelle config (avec USE_UNIFIED_RPC=true)
          docker compose -f docker-compose.prod.yml -f docker-compose.caddy.yml up -d

          # Attendre le d√©marrage
          sleep 15

          # V√©rifier que USE_UNIFIED_RPC est bien pass√©
          echo "üîç V√©rification des variables d'environnement:"
          docker exec nestjs-remix-monorepo-prod env | grep -E "UNIFIED|RPC" || echo "‚ö†Ô∏è Variables RPC non trouv√©es"

          # Nettoyer les images (sans --volumes pour pr√©server les donn√©es)
          docker image prune -f

      - name: üó∫Ô∏è Generate static sitemaps (si n√©cessaire)
        if: ${{ github.ref == 'refs/heads/main' }}
        run: |
          PROD_DIR="/home/deploy/app"
          SITEMAP_FILE="$PROD_DIR/public/sitemaps/sitemap.xml"
          MAX_AGE_DAYS=7

          # V√©rifier si les sitemaps existent et sont r√©cents
          if [ -f "$SITEMAP_FILE" ]; then
            FILE_AGE=$(( ($(date +%s) - $(stat -c %Y "$SITEMAP_FILE")) / 86400 ))
            if [ $FILE_AGE -lt $MAX_AGE_DAYS ]; then
              echo "‚úÖ Sitemaps r√©cents ($FILE_AGE jours) - g√©n√©ration ignor√©e"
              ls -la $PROD_DIR/public/sitemaps/
              exit 0
            fi
            echo "‚ö†Ô∏è Sitemaps anciens ($FILE_AGE jours) - r√©g√©n√©ration n√©cessaire..."
          else
            echo "üìù Sitemaps absents - g√©n√©ration initiale..."
          fi

          # Charger les variables d'environnement depuis le .env de production
          if [ -f "$PROD_DIR/.env" ]; then
            echo "üìÇ Chargement des variables depuis $PROD_DIR/.env"
            set -a
            source $PROD_DIR/.env
            set +a
          fi

          echo "üì¶ Installation des d√©pendances backend..."
          cd $GITHUB_WORKSPACE/backend
          npm install --include=dev

          echo "üó∫Ô∏è G√©n√©ration des sitemaps statiques (714k URLs)..."
          mkdir -p $PROD_DIR/public/sitemaps
          export OUTPUT_DIR="$PROD_DIR/public/sitemaps"
          npx ts-node scripts/generate-sitemaps.ts

          echo "‚úÖ Sitemaps g√©n√©r√©s dans $PROD_DIR/public/sitemaps/"
          ls -la $PROD_DIR/public/sitemaps/

          echo "üîÑ Rechargement de Caddy..."
          docker exec nestjs-remix-caddy caddy reload --config /etc/caddy/Caddyfile || docker restart nestjs-remix-caddy
