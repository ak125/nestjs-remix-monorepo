name: üöÄ Deploy
on:
  push:
    branches:
      - main
      - dev
  pull_request: {}

permissions:
  actions: write
  contents: read

jobs:
  lint:
    name: ‚¨£ ESLint
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Application
        run: npm run build

      - name: üî¨ Lint
        run: npm run lint

  typecheck:
    name:  ¶ TypeScript
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Application
        run: npm run build

      - name: üîé Type check
        run: npm run typecheck --if-present

      - name: üß™ URL Pattern Tests
        run: cd frontend && npm run test -- --run tests/unit/url-patterns.test.ts

  build:
    name: üê≥ build
    uses: ./.github/workflows/build.yml
    secrets: inherit

  deploy:
    name: üöÄ Deploy
    runs-on: [self-hosted, Linux, X64]
    needs: [build, lint, typecheck]
    # needs: [build]
    # only build/deploy main branch on pushes
    # if: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') && github.event_name == 'push' }}
    if: ${{ (github.ref == 'refs/heads/main') && github.event_name == 'push' }}
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true

    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4.1.1
      
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      #   - name: üöÄ Run Docker Compose on Staging
      #     if: ${{ github.ref == 'refs/heads/dev' }}
      #     env:
      #       NODE_ENV: staging
      #     run: |
      #       docker pull massdoc/nestjs-remix-monorepo:latest
      #       docker compose -f docker-compose.staging.yaml up -d
      #       docker system prune --all --volumes --force

      - name: Setup Node.js for sitemap generation
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üöÄ Run Docker Compose on Production
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          docker pull massdoc/nestjs-remix-monorepo:production

          PROD_DIR=~/production

          # Cr√©er les dossiers
          mkdir -p $PROD_DIR/config/caddy

          # Sync depuis Git (rm avant cp pour √©viter permission denied)
          rm -f $PROD_DIR/docker-compose.prod.yml
          rm -f $PROD_DIR/docker-compose.caddy.yml
          rm -f $PROD_DIR/config/caddy/Caddyfile
          cp $GITHUB_WORKSPACE/docker-compose.prod.yml $PROD_DIR/
          cp $GITHUB_WORKSPACE/docker-compose.caddy.yml $PROD_DIR/
          cp $GITHUB_WORKSPACE/config/caddy/Caddyfile $PROD_DIR/config/caddy/

          cd $PROD_DIR

          # Cr√©er le r√©seau externe s'il n'existe pas
          docker network create automecanik-prod 2>/dev/null || true

          # Arr√™ter et supprimer les anciens conteneurs s'ils existent
          docker stop nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true
          docker rm nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true

          # D√©marrer avec la nouvelle config
          docker compose -f docker-compose.prod.yml -f docker-compose.caddy.yml up -d

          # Attendre le d√©marrage
          sleep 15

          # V√©rifier que les conteneurs tournent
          docker ps | grep nestjs-remix || echo "‚ö†Ô∏è Conteneurs non trouv√©s"

          # Nettoyer les images
          docker image prune -f

      - name: üó∫Ô∏è Generate static sitemaps (si n√©cessaire)
        if: ${{ github.ref == 'refs/heads/main' }}
        run: |
          PROD_DIR=~/production
          SITEMAP_FILE="$PROD_DIR/public/sitemaps/sitemap.xml"
          MAX_AGE_DAYS=7

          # V√©rifier si les sitemaps existent et sont r√©cents
          if [ -f "$SITEMAP_FILE" ]; then
            FILE_AGE=$(( ($(date +%s) - $(stat -c %Y "$SITEMAP_FILE")) / 86400 ))
            if [ $FILE_AGE -lt $MAX_AGE_DAYS ]; then
              echo "‚úÖ Sitemaps r√©cents ($FILE_AGE jours) - g√©n√©ration ignor√©e"
              ls -la $PROD_DIR/public/sitemaps/
              exit 0
            fi
            echo "‚ö†Ô∏è Sitemaps anciens ($FILE_AGE jours) - r√©g√©n√©ration n√©cessaire..."
          else
            echo "üìù Sitemaps absents - g√©n√©ration initiale..."
          fi

          # Charger les variables d'environnement depuis le .env de production
          if [ -f "$PROD_DIR/.env" ]; then
            echo "üìÇ Chargement des variables depuis $PROD_DIR/.env"
            set -a
            source $PROD_DIR/.env
            set +a
          fi

          echo "üì¶ Installation des d√©pendances backend..."
          cd $GITHUB_WORKSPACE/backend
          npm install --include=dev

          echo "üó∫Ô∏è G√©n√©ration des sitemaps statiques (714k URLs)..."
          mkdir -p $PROD_DIR/public/sitemaps
          export OUTPUT_DIR="$PROD_DIR/public/sitemaps"
          npx ts-node scripts/generate-sitemaps.ts

          echo "‚úÖ Sitemaps g√©n√©r√©s dans $PROD_DIR/public/sitemaps/"
          ls -la $PROD_DIR/public/sitemaps/

          echo "üîÑ Rechargement de Caddy..."
          docker exec nestjs-remix-caddy caddy reload --config /etc/caddy/Caddyfile || docker restart nestjs-remix-caddy

  # ============================================
  # POST-DEPLOYMENT VALIDATION
  # ============================================
  validate:
    name: ‚úÖ Validate URLs
    runs-on: ubuntu-latest
    needs: [deploy]
    if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Validate critical URLs
        run: |
          echo "üîç Validating production URLs..."

          BASE_URL="https://www.automecanik.com"
          FAILED=0

          # URLs critiques qui doivent retourner 200
          URLS=(
            "/"
            "/health"
            "/search?q=plaquette"
            "/pieces/catalogue"
            "/pieces/catalogue?category=freinage"
            "/pieces/catalogue?category=moteur"
            "/contact"
            "/cart"
          )

          for url in "${URLS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL$url" --max-time 30)
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ $url -> $STATUS"
            else
              echo "‚ùå $url -> $STATUS (expected 200)"
              FAILED=1
            fi
          done

          # URL qui doit retourner 404 (ancien format)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/pieces/freinage" --max-time 30)
          if [ "$STATUS" != "200" ]; then
            echo "‚úÖ /pieces/freinage -> $STATUS (correctly not 200)"
          else
            echo "‚ö†Ô∏è /pieces/freinage -> $STATUS (should NOT be 200)"
            # Ne pas √©chouer pour √ßa, juste avertir
          fi

          if [ "$FAILED" = "1" ]; then
            echo "‚ùå Some URLs failed validation!"
            exit 1
          fi

          echo "‚úÖ All critical URLs validated successfully!"

      - name: Report validation results
        if: failure()
        run: |
          echo "::error::Production URL validation failed. Check deployment logs."
