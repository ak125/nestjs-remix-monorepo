name: ğŸš€ Deploy
on:
  push:
    branches:
      - main
      - dev
  pull_request: {}

permissions:
  actions: write
  contents: read

jobs:
  lint:
    name: â¬£ ESLint
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Application
        run: npm run build

      - name: ğŸ”¬ Lint
        run: npm run lint

  typecheck:
    name: Ê¦ TypeScript
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Application
        run: npm run build

      - name: ğŸ” Type check
        run: npm run typecheck --if-present

      - name: ğŸ§ª URL Pattern Tests
        run: cd frontend && npm run test -- --run tests/unit/url-patterns.test.ts

  build:
    name: ğŸ³ build
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
      tag: preprod

  deploy:
    name: ğŸ§ª Deploy PREPROD
    runs-on: [self-hosted, Linux, X64]
    needs: [build, lint, typecheck]
    if: ${{ (github.ref == 'refs/heads/main') && github.event_name == 'push' }}

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4.1.1

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ§ª Deploy to PREPROD
        env:
          NODE_ENV: preprod
        run: |
          docker pull massdoc/nestjs-remix-monorepo:preprod

          PREPROD_DIR=~/preprod
          mkdir -p $PREPROD_DIR

          # Copier docker-compose.preprod.yml
          cp $GITHUB_WORKSPACE/docker-compose.preprod.yml $PREPROD_DIR/

          # Copier le .env de prod (meme DB)
          if [ -f ~/production/.env ]; then
            cp ~/production/.env $PREPROD_DIR/.env
          else
            echo "âš ï¸ Warning: ~/production/.env not found, preprod may fail"
          fi

          cd $PREPROD_DIR

          # Creer le reseau
          docker network create automecanik-preprod 2>/dev/null || true

          # Arreter anciens conteneurs
          docker stop nestjs-remix-monorepo-preprod redis-preprod 2>/dev/null || true
          docker rm nestjs-remix-monorepo-preprod redis-preprod 2>/dev/null || true

          # Demarrer preprod
          docker compose -f docker-compose.preprod.yml up -d

          # Health check
          echo "â³ Waiting for PREPROD to start (30s)..."
          sleep 30

          if ! docker ps | grep -q nestjs-remix-monorepo-preprod; then
            echo "âŒ PREPROD container not running - checking logs..."
            docker logs nestjs-remix-monorepo-preprod --tail 50
            exit 1
          fi

          if ! curl -sf http://localhost:3100/health > /dev/null; then
            echo "âŒ PREPROD health check failed"
            docker logs nestjs-remix-monorepo-preprod --tail 30
            exit 1
          fi

          echo "âœ… PREPROD deployed successfully on port 3100"
          echo "ğŸ”— Test URL: http://$(hostname -I | awk '{print $1}'):3100"

          # Nettoyer les images
          docker image prune -f
