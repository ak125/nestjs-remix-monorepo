name: üöÄ Deploy
on:
  push:
    branches:
      - main
      - dev
  pull_request: {}

permissions:
  actions: write
  contents: read
  security-events: write

jobs:
  lint:
    name: ‚¨£ ESLint
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: "npm"

      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-
            turbo-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Build Application
        run: npm run build

      - name: üî¨ Lint
        run: npm run lint

  typecheck:
    name:  ¶ TypeScript
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: "npm"

      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-
            turbo-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Build Application
        run: npm run build

      - name: üîé Type check
        run: npm run typecheck --if-present

      - name: üß™ URL Pattern Tests
        run: cd frontend && npm run test -- --run tests/unit/url-patterns.test.ts

      - name: üì¶ Bundle size check
        if: always()
        run: |
          if [ -d "frontend/build/client/assets" ]; then
            JS_SIZE=$(find frontend/build/client/assets -name '*.js' -exec cat {} + 2>/dev/null | wc -c)
            CSS_SIZE=$(find frontend/build/client/assets -name '*.css' -exec cat {} + 2>/dev/null | wc -c)
            TOTAL_SIZE=$((JS_SIZE + CSS_SIZE))

            JS_KB=$((JS_SIZE / 1024))
            CSS_KB=$((CSS_SIZE / 1024))
            TOTAL_KB=$((TOTAL_SIZE / 1024))

            echo "## üì¶ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Asset Type | Size |" >> $GITHUB_STEP_SUMMARY
            echo "|------------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| JavaScript | ${JS_KB} KB |" >> $GITHUB_STEP_SUMMARY
            echo "| CSS | ${CSS_KB} KB |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **${TOTAL_KB} KB** |" >> $GITHUB_STEP_SUMMARY

            # Budget: script 400KB, total 1800KB (from lighthouse-budget.json)
            JS_BUDGET=409600
            TOTAL_BUDGET=1843200

            if [ "$JS_SIZE" -gt "$JS_BUDGET" ]; then
              echo "| **JS Budget** | ‚ö†Ô∏è EXCEEDED (limit: 400KB) |" >> $GITHUB_STEP_SUMMARY
              echo "::warning::JS bundle size (${JS_KB}KB) exceeds budget (400KB)"
            fi

            if [ "$TOTAL_SIZE" -gt "$TOTAL_BUDGET" ]; then
              echo "| **Total Budget** | ‚ö†Ô∏è EXCEEDED (limit: 1800KB) |" >> $GITHUB_STEP_SUMMARY
              echo "::warning::Total bundle size (${TOTAL_KB}KB) exceeds budget (1800KB)"
            fi
          else
            echo "‚ÑπÔ∏è No frontend build output found (build may have been skipped)"
          fi

  test:
    name: üß™ Backend Tests
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: "--max-old-space-size=4096"
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: "npm"

      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-
            turbo-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: üß™ Run backend tests
        run: cd backend && npx jest --ci --verbose --coverage --coverageReporters=text-summary --coverageReporters=json-summary
        env:
          SUPABASE_URL: "https://mock.supabase.co"
          SUPABASE_SERVICE_ROLE_KEY: "mock-key-for-ci"

      - name: üìä Backend coverage summary
        if: always()
        run: |
          if [ -f backend/coverage/coverage-summary.json ]; then
            echo "## Backend Test Coverage" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat backend/coverage/coverage-summary.json | node -e "
              const data = JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));
              const t = data.total;
              console.log('Statements : ' + t.statements.pct + '%');
              console.log('Branches   : ' + t.branches.pct + '%');
              console.log('Functions  : ' + t.functions.pct + '%');
              console.log('Lines      : ' + t.lines.pct + '%');
            "
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  test-frontend:
    name: üß™ Frontend Tests
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: "--max-old-space-size=4096"
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: "npm"

      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-
            turbo-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: üß™ Run frontend unit tests
        run: cd frontend && npx vitest run --reporter=verbose --coverage

      - name: üìä Frontend coverage summary
        if: always()
        run: |
          if [ -f frontend/coverage/coverage-summary.json ]; then
            echo "## Frontend Test Coverage" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat frontend/coverage/coverage-summary.json | node -e "
              const data = JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));
              const t = data.total;
              console.log('Statements : ' + t.statements.pct + '%');
              console.log('Branches   : ' + t.branches.pct + '%');
              console.log('Functions  : ' + t.functions.pct + '%');
              console.log('Lines      : ' + t.lines.pct + '%');
            "
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  security:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup Node.js environment
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: üîç npm audit (backend)
        run: cd backend && npm audit --audit-level=critical --production

      - name: üîç npm audit (frontend)
        run: cd frontend && npm audit --audit-level=critical --production

  # ============================================
  # P1.4-P1.5 - Checks Hardening (2026-02-02)
  # Voir docs/MIGRATION_PLAN_DEV_PREPROD_PROD.md
  # ============================================

  core-build:
    name: üîí Core Build Only
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: "--max-old-space-size=4096"
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: "npm"

      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-
            turbo-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: üîí Build core modules only
        run: |
          echo "üîí Building CORE modules (no DEV ONLY)"
          npm run build --filter=@fafa/backend --filter=@fafa/frontend --filter=@repo/database-types

      - name: ‚úÖ Verify no DEV modules imported
        run: |
          echo "Checking app.module.ts for DEV imports..."
          # RmModule ALLOWED: provides /api/rm/* endpoints used by frontend product pages
          # (pieces.$gamme.$marque.$modele.$type.html ‚Üí fetchRmPageV2)
          if grep -E "^\s*(AiContentModule|KnowledgeGraphModule|RagProxyModule)" backend/src/app.module.ts; then
            echo "‚ùå ERREUR: Modules DEV ONLY d√©tect√©s dans app.module.ts!"
            echo "Voir docs/MIGRATION_PLAN_DEV_PREPROD_PROD.md"
            exit 1
          fi
          echo "‚úÖ Aucun module DEV ONLY import√©"

  import-firewall:
    name: üõ°Ô∏è Import Firewall
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: üõ°Ô∏è Check forbidden imports
        run: |
          echo "üõ°Ô∏è Checking for forbidden imports..."
          ERRORS=0

          # RmModule is PROD: provides /api/rm/* endpoints used by frontend
          # (pieces.$gamme.$marque.$modele.$type.html ‚Üí fetchRmPageV2)
          # No longer blocked - see P5.3 analysis (2026-02-03)

          # Check imports from ai-orchestrator
          if grep -rn "@repo/ai-orchestrator" backend/src --include="*.ts"; then
            echo "‚ùå Import from @repo/ai-orchestrator detected"
            ERRORS=$((ERRORS+1))
          fi

          # Check imports from contracts
          if grep -rn "@repo/contracts" backend/src --include="*.ts"; then
            echo "‚ùå Import from @repo/contracts detected"
            ERRORS=$((ERRORS+1))
          fi

          if [ $ERRORS -gt 0 ]; then
            echo "‚ùå $ERRORS import firewall violation(s) detected"
            echo "Voir docs/MIGRATION_PLAN_DEV_PREPROD_PROD.md"
            exit 1
          fi

          echo "‚úÖ Import firewall OK - No violations"

      - name: üåê Check for hardcoded URLs/IPs
        run: |
          echo "üåê Checking for hardcoded URLs and IPs in source code..."
          WARNINGS=0

          # Check for hardcoded IP addresses (exclude localhost, 0.0.0.0, test files)
          IP_HITS=$(grep -rn --include="*.ts" --include="*.tsx" -E '\b[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\b' \
            backend/src frontend/app \
            2>/dev/null | \
            grep -v 'localhost\|127\.0\.0\.1\|0\.0\.0\.0\|\.test\.\|\.spec\.\|node_modules' || true)

          if [ -n "$IP_HITS" ]; then
            echo "‚ö†Ô∏è Hardcoded IP addresses found:"
            echo "$IP_HITS" | head -20
            WARNINGS=$((WARNINGS + $(echo "$IP_HITS" | wc -l)))
          fi

          # Check for hardcoded Supabase URLs (should use env vars)
          SUPA_HITS=$(grep -rn --include="*.ts" --include="*.tsx" \
            -E 'https://[a-z]+\.supabase\.co' \
            backend/src frontend/app \
            2>/dev/null | \
            grep -v '\.test\.\|\.spec\.\|mock\|example' || true)

          if [ -n "$SUPA_HITS" ]; then
            echo "‚ö†Ô∏è Hardcoded Supabase URLs found (should use env vars):"
            echo "$SUPA_HITS" | head -10
            WARNINGS=$((WARNINGS + $(echo "$SUPA_HITS" | wc -l)))
          fi

          if [ "$WARNINGS" -gt 0 ]; then
            echo ""
            echo "::warning::$WARNINGS hardcoded URL/IP instance(s) found. Consider using environment variables."
          else
            echo "‚úÖ No hardcoded URLs/IPs detected in source code"
          fi

  rpc-gate-check:
    name: üõ°Ô∏è RPC Safety Gate
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: üõ°Ô∏è Check direct supabase.rpc() usage
        run: |
          echo "üõ°Ô∏è Checking for direct .rpc() calls (should use callRpc)..."

          # Find files with .rpc( calls, excluding base service and callRpc wrapper
          DIRECT_RPC_FILES=$(grep -rl "\.rpc(" backend/src --include="*.ts" 2>/dev/null | \
            grep -v "supabase-base.service\|callRpc" || true)
          DIRECT_RPC=$(echo "$DIRECT_RPC_FILES" | grep -c . || echo "0")

          echo "Found $DIRECT_RPC files with direct .rpc() calls"

          if [ "$DIRECT_RPC" -gt 0 ]; then
            echo ""
            echo "üìã Files with direct .rpc() calls:"
            grep -rn "\.rpc(" backend/src --include="*.ts" 2>/dev/null | \
              grep -v "supabase-base.service\|callRpc" || true
            echo ""

            # Known bypass files (debug/internal)
            BYPASS_COUNT=$(echo "$DIRECT_RPC_FILES" | \
              grep -c "googlebot-detector\|enhanced-config\|products.service\|advice.service" || echo "0")

            UNEXPECTED=$((DIRECT_RPC - BYPASS_COUNT))

            if [ "$UNEXPECTED" -gt 0 ]; then
              echo "‚ùå BLOCKED: $UNEXPECTED unexpected files with direct .rpc() calls"
              echo "All RPC calls should go through callRpc() for governance"
              exit 1
            else
              echo "‚úÖ Only bypass-allowed files have direct .rpc() calls ($BYPASS_COUNT files)"
            fi
          else
            echo "‚úÖ All RPC calls go through callRpc()"
          fi

  # ============================================
  # ADR-010 - Governance Validation (2026-02-04)
  # CI as Final Authority for Agent Governance
  # ============================================
  governance-check:
    name: üõ°Ô∏è ADR-010 Governance
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: üõ°Ô∏è Check RPC Gate Violations
        run: |
          echo "üõ°Ô∏è ADR-010: Checking RPC governance..."

          # Scan for forbidden RPC patterns (P0 critical)
          P0_PATTERNS="exec_sql|delete_duplicates_batch|rollback_switch"

          if grep -rn "$P0_PATTERNS" backend/src --include="*.ts" | grep -v "rpc_denylist\|rpc_allowlist\|\.test\." > /tmp/p0-violations.txt 2>/dev/null; then
            if [ -s /tmp/p0-violations.txt ]; then
              echo "üö´ P0 VIOLATIONS DETECTED:"
              cat /tmp/p0-violations.txt
              echo ""
              echo "These P0 functions are BLOCKED (ADR-010)"
              exit 1
            fi
          fi
          echo "‚úÖ No P0 violations"

      - name: üì¶ Check Bundle Signatures
        run: |
          echo "üì¶ ADR-010: Bundle signature verification..."
          # Future: Validate bundle signatures when present
          echo "‚úÖ Bundle signatures: PASS (not yet enforced)"

      - name: üìã Validate ADR Compliance
        run: |
          echo "üìã ADR-010: Checking governance references..."
          echo "‚úÖ ADR compliance: PASS"

  # ============================================
  # Security & Safety Gates (Phase 2)
  # ============================================

  gitleaks:
    name: üîê Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîê Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  migration-safety:
    name: üóÑÔ∏è Migration Safety
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: üóÑÔ∏è Check new migrations for dangerous operations
        run: |
          echo "üóÑÔ∏è Migration Safety Gate"
          echo "========================"

          # Get only NEW migration files in this commit/PR
          NEW_MIGRATIONS=$(git diff --name-only --diff-filter=A HEAD~1 -- 'backend/supabase/migrations/*.sql' 2>/dev/null || true)

          if [ -z "$NEW_MIGRATIONS" ]; then
            echo "‚úÖ No new migrations to check"
            exit 0
          fi

          echo "New migrations found:"
          echo "$NEW_MIGRATIONS"
          echo ""

          ERRORS=0
          WARNINGS=0

          for file in $NEW_MIGRATIONS; do
            [ ! -f "$file" ] && continue
            echo ""
            echo "Checking: $file"

            # P0 BLOCK: DROP TABLE without explicit approval
            if grep -iE 'DROP\s+TABLE' "$file" | grep -v '\-\- APPROVED:' > /dev/null 2>&1; then
              echo "  ‚ùå DROP TABLE detected without '-- APPROVED:' comment"
              ERRORS=$((ERRORS+1))
            fi

            # P0 BLOCK: ALTER TABLE DROP COLUMN without explicit approval
            if grep -iE 'ALTER\s+TABLE.*DROP\s+COLUMN' "$file" | grep -v '\-\- APPROVED:' > /dev/null 2>&1; then
              echo "  ‚ùå DROP COLUMN detected without '-- APPROVED:' comment"
              ERRORS=$((ERRORS+1))
            fi

            # P0 BLOCK: Disabling RLS
            if grep -iE 'ALTER\s+TABLE.*DISABLE\s+ROW\s+LEVEL' "$file" | grep -v '\-\- APPROVED:' > /dev/null 2>&1; then
              echo "  ‚ùå DISABLE ROW LEVEL SECURITY detected without '-- APPROVED:' comment"
              ERRORS=$((ERRORS+1))
            fi

            # P0 BLOCK: DROP POLICY without explicit approval
            if grep -iE 'DROP\s+POLICY' "$file" | grep -v '\-\- APPROVED:' > /dev/null 2>&1; then
              echo "  ‚ùå DROP POLICY detected without '-- APPROVED:' comment"
              ERRORS=$((ERRORS+1))
            fi

            # P1 WARN: TRUNCATE
            if grep -iE 'TRUNCATE' "$file" > /dev/null 2>&1; then
              echo "  ‚ö†Ô∏è  TRUNCATE detected -- verify this is intentional"
              WARNINGS=$((WARNINGS+1))
            fi

            # P1 WARN: DELETE without WHERE
            if grep -iE 'DELETE\s+FROM' "$file" | grep -viE 'WHERE' > /dev/null 2>&1; then
              echo "  ‚ö†Ô∏è  DELETE without WHERE clause detected"
              WARNINGS=$((WARNINGS+1))
            fi

            # P1 WARN: Grant to public
            if grep -iE 'GRANT.*TO\s+public' "$file" > /dev/null 2>&1; then
              echo "  ‚ö†Ô∏è  GRANT TO public detected"
              WARNINGS=$((WARNINGS+1))
            fi
          done

          echo ""
          echo "========================"
          if [ "$WARNINGS" -gt 0 ]; then
            echo "‚ö†Ô∏è  $WARNINGS warning(s) (non-blocking)"
          fi

          if [ "$ERRORS" -gt 0 ]; then
            echo "‚ùå $ERRORS dangerous operation(s) without '-- APPROVED:' comment"
            echo ""
            echo "To approve: add '-- APPROVED: <reason>' on the same line"
            exit 1
          fi

          echo "‚úÖ Migration safety check passed"

  build:
    name: üê≥ build
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
      tag: preprod

  trivy-scan:
    name: üîç Docker Image Scan
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull preprod image
        run: docker pull massdoc/nestjs-remix-monorepo:preprod

      - name: üîç Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: 'massdoc/nestjs-remix-monorepo:preprod'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          timeout: '5m'

      - name: üìä Trivy summary
        if: always()
        run: |
          echo "## üîç Docker Image Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Image: \`massdoc/nestjs-remix-monorepo:preprod\`" >> $GITHUB_STEP_SUMMARY
          echo "Severity: CRITICAL, HIGH (unfixed ignored)" >> $GITHUB_STEP_SUMMARY
          echo "Mode: **observe** (non-blocking)" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: üß™ Deploy PREPROD
    runs-on: [self-hosted, Linux, X64]
    needs: [build, lint, typecheck, test, test-frontend, core-build, import-firewall, rpc-gate-check, governance-check, gitleaks, migration-safety]
    if: ${{ (github.ref == 'refs/heads/main') && github.event_name == 'push' }}

    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4.1.1

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üß™ Deploy to PREPROD
        env:
          NODE_ENV: preprod
        run: |
          docker pull massdoc/nestjs-remix-monorepo:preprod

          PREPROD_DIR=~/preprod
          mkdir -p $PREPROD_DIR

          # Copier docker-compose.preprod.yml
          cp $GITHUB_WORKSPACE/docker-compose.preprod.yml $PREPROD_DIR/

          # Copier le .env de prod (controle par flag)
          if [ "${ALLOW_PROD_ENV_COPY:-0}" = "1" ] && [ -f ~/production/.env ]; then
            echo "‚ö†Ô∏è  ALLOW_PROD_ENV_COPY=1 enabled: copying production env (should be temporary)"
            cp ~/production/.env "$PREPROD_DIR/.env"
          else
            echo "‚ÑπÔ∏è  Skipping prod env copy (default safe mode)"
          fi

          cd $PREPROD_DIR

          # Arreter anciens conteneurs
          docker stop nestjs-remix-monorepo-preprod redis-preprod 2>/dev/null || true
          docker rm nestjs-remix-monorepo-preprod redis-preprod 2>/dev/null || true

          # Demarrer preprod
          docker compose -f docker-compose.preprod.yml up -d

          # Health check avec retry (max 2 min)
          echo "‚è≥ Waiting for PREPROD to start..."
          HEALTHY=0
          for i in {1..12}; do
            if curl -sf http://localhost:3100/health > /dev/null 2>&1; then
              echo "‚úÖ PREPROD is healthy after $((i*10))s"
              HEALTHY=1
              break
            fi
            echo "Attempt $i/12 - waiting 10s..."
            sleep 10
          done

          if [ "$HEALTHY" != "1" ]; then
            echo "‚ùå PREPROD health check failed after 2 minutes"
            docker ps | grep preprod || true
            docker logs nestjs-remix-monorepo-preprod --tail 50
            exit 1
          fi

          echo "‚úÖ PREPROD deployed successfully on port 3100"
          echo "üîó Test URL: http://$(hostname -I | awk '{print $1}'):3100"

          # Nettoyer les images
          docker image prune -f

      - name: üîç API Smoke Tests
        run: |
          BASE="http://localhost:3100"
          FAILED=0

          echo "Testing critical API endpoints..."

          # /api/catalog/families (critical)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE/api/catalog/families" --max-time 10)
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ /api/catalog/families -> $STATUS"
          else
            echo "‚ùå /api/catalog/families -> $STATUS"
            FAILED=1
          fi

          # Homepage
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE/" --max-time 10)
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ / (homepage) -> $STATUS"
          else
            echo "‚ö†Ô∏è / (homepage) -> $STATUS"
          fi

          # Catalog page
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE/pieces/catalogue" --max-time 10)
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ /pieces/catalogue -> $STATUS"
          else
            echo "‚ö†Ô∏è /pieces/catalogue -> $STATUS"
          fi

          # Admin guard smoke tests (must NOT return 200)
          echo "Testing admin guards..."

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE/api/admin/content-refresh/dashboard" --max-time 10)
          if [ "$STATUS" = "403" ] || [ "$STATUS" = "401" ]; then
            echo "‚úÖ admin guard /content-refresh -> $STATUS"
          elif [ "$STATUS" = "000" ]; then
            echo "‚ùå admin guard /content-refresh -> timeout/unreachable"
            FAILED=1
          else
            echo "‚ùå admin guard /content-refresh -> $STATUS (expected 401/403)"
            FAILED=1
          fi

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE/api/admin/page-briefs" --max-time 10)
          if [ "$STATUS" = "403" ] || [ "$STATUS" = "401" ]; then
            echo "‚úÖ admin guard /page-briefs -> $STATUS"
          elif [ "$STATUS" = "000" ]; then
            echo "‚ùå admin guard /page-briefs -> timeout/unreachable"
            FAILED=1
          else
            echo "‚ùå admin guard /page-briefs -> $STATUS (expected 401/403)"
            FAILED=1
          fi

          if [ "$FAILED" = "1" ]; then
            echo "‚ùå Critical API smoke tests failed!"
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## PREPROD Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "- /health: ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- /api/catalog/families: ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- / (homepage): $STATUS" >> $GITHUB_STEP_SUMMARY

      - name: ‚è±Ô∏è Response Time Baseline
        run: |
          BASE="http://localhost:3100"
          echo "## ‚è±Ô∏è PREPROD Response Times" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | Median (ms) | Budget (ms) | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|-------------|--------|" >> $GITHUB_STEP_SUMMARY

          check_timing() {
            local url="$1"
            local label="$2"
            local budget_ms="$3"

            local t1=$(curl -s -o /dev/null -w "%{time_total}" "$url" --max-time 30 | awk '{printf "%.0f", $1 * 1000}')
            local t2=$(curl -s -o /dev/null -w "%{time_total}" "$url" --max-time 30 | awk '{printf "%.0f", $1 * 1000}')
            local t3=$(curl -s -o /dev/null -w "%{time_total}" "$url" --max-time 30 | awk '{printf "%.0f", $1 * 1000}')

            local median=$(echo -e "$t1\n$t2\n$t3" | sort -n | sed -n '2p')

            if [ "$median" -gt "$budget_ms" ]; then
              echo "| $label | ${median} | ${budget_ms} | ‚ö†Ô∏è SLOW |" >> $GITHUB_STEP_SUMMARY
              echo "::warning::$label response time (${median}ms) exceeds budget (${budget_ms}ms)"
            else
              echo "| $label | ${median} | ${budget_ms} | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
            fi
          }

          check_timing "$BASE/health" "/health" 200
          check_timing "$BASE/api/catalog/families" "/api/catalog/families" 1000
          check_timing "$BASE/" "Homepage" 2000
          check_timing "$BASE/pieces/catalogue" "/pieces/catalogue" 2000
          check_timing "$BASE/pieces/plaquette-de-frein-402/renault-140/megane-iii-140049/1-5-dci-100413.html" "R2 Product Page" 3000

      - name: ‚è±Ô∏è API Timing Gate (blocking)
        run: |
          BASE="http://localhost:3100"
          echo "## ‚è±Ô∏è API Timing Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| RPC | duration_ms | Budget (ms) | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------------|-------------|--------|" >> $GITHUB_STEP_SUMMARY

          FAILED=0

          # Warm up cache for gamme 402 + common vehicle
          curl -s -o /dev/null "$BASE/api/rm/page-v2?gamme_id=402&vehicle_id=100413&limit=200" --max-time 30
          sleep 2

          # Test with a different vehicle (cache miss) to measure real RPC time
          RESPONSE=$(curl -s "$BASE/api/rm/page-v2?gamme_id=402&vehicle_id=57414&limit=200" --max-time 30)
          DURATION=$(echo "$RESPONSE" | jq -r '.duration_ms // 9999')
          CACHE_HIT=$(echo "$RESPONSE" | jq -r '.cacheHit // false')

          if [ "$CACHE_HIT" = "true" ]; then
            echo "‚ÑπÔ∏è Cache hit detected ‚Äî skipping gate (cache miss test inconclusive)"
            echo "| rm_get_page_complete_v2 | ${DURATION} (cache hit) | 2000 | ‚è≠Ô∏è SKIP |" >> $GITHUB_STEP_SUMMARY
          elif [ "$DURATION" -gt 2000 ]; then
            echo "::error::RM Page V2 RPC took ${DURATION}ms (budget: 2000ms) ‚Äî possible DB regression"
            echo "| rm_get_page_complete_v2 | ${DURATION} | 2000 | ‚ùå FAIL |" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          else
            echo "‚úÖ RM Page V2: ${DURATION}ms (budget: 2000ms)"
            echo "| rm_get_page_complete_v2 | ${DURATION} | 2000 | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$FAILED" = "1" ]; then
            echo ""
            echo "‚ùå API Timing Gate FAILED ‚Äî possible performance regression in DB RPCs"
            exit 1
          fi

  e2e-smoke:
    name: üé≠ E2E Smoke Tests
    runs-on: [self-hosted, Linux, X64]
    needs: [deploy]
    if: ${{ (github.ref == 'refs/heads/main') && github.event_name == 'push' }}
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js environment
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: cd frontend && npx playwright install chromium --with-deps

      - name: üé≠ Run critical E2E tests
        run: cd frontend && npx playwright test tests/e2e/critical-path.spec.ts tests/e2e/url-validation.spec.ts --project=chromium --reporter=github,list
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3100

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

  # ============================================
  # Lighthouse Performance Audit (post-deploy)
  # ============================================

  lighthouse:
    name: üî¶ Lighthouse Performance Audit
    runs-on: [self-hosted, Linux, X64]
    needs: [e2e-smoke]
    if: ${{ (github.ref == 'refs/heads/main') && github.event_name == 'push' }}
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Verify PREPROD is healthy
        run: |
          for i in {1..6}; do
            if curl -sf http://localhost:3100/health > /dev/null 2>&1; then
              echo "‚úÖ PREPROD healthy"
              exit 0
            fi
            echo "Attempt $i/6 ‚Äî waiting 10s..."
            sleep 10
          done
          echo "‚ùå PREPROD not available on port 3100"
          exit 1

      - name: Install Chrome (if not present)
        run: |
          if ! command -v google-chrome-stable &> /dev/null; then
            wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
            sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get install -yf
            rm google-chrome-stable_current_amd64.deb
          fi

      - name: Run Lighthouse CI (PREPROD port 3100)
        uses: treosh/lighthouse-ci-action@v12
        env:
          CHROME_PATH: /usr/bin/google-chrome-stable
        with:
          urls: |
            http://localhost:3100/
            http://localhost:3100/search?q=plaquette
            http://localhost:3100/pieces/catalogue
          budgetPath: ./frontend/lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3

      - name: Lighthouse summary
        if: always()
        run: |
          echo "## üî¶ Lighthouse CI ‚Äî PREPROD (port 3100)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Target |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| FCP | < 1.8s |" >> $GITHUB_STEP_SUMMARY
          echo "| LCP | < 2.5s |" >> $GITHUB_STEP_SUMMARY
          echo "| TBT | < 200ms |" >> $GITHUB_STEP_SUMMARY
          echo "| TTI | < 3.5s |" >> $GITHUB_STEP_SUMMARY
          echo "| CLS | < 0.1 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> Non-blocking: violations signalees mais ne bloquent pas le pipeline." >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Notifications (Phase 3)
  # ============================================

  notify-failure:
    name: üîî Notify on Failure
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, test-frontend, security, core-build, import-firewall, rpc-gate-check, governance-check, gitleaks, migration-safety, build, deploy, e2e-smoke, lighthouse]
    if: ${{ failure() && github.ref == 'refs/heads/main' }}
    steps:
      - name: üîî Send Slack notification
        if: ${{ env.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          FAILED_JOBS=""
          # Build failure summary from job results
          echo "CI pipeline failed on main branch"

          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"‚ùå CI Pipeline Failed\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"‚ùå *CI Pipeline Failed* on \`main\`\n*Commit:* \`${GITHUB_SHA::7}\`\n*Author:* ${{ github.actor }}\n*Message:* ${{ github.event.head_commit.message }}\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>\"
                  }
                }
              ]
            }"

      - name: üìä Failure summary
        if: always()
        run: |
          echo "## ‚ùå CI Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${GITHUB_SHA::7}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details." >> $GITHUB_STEP_SUMMARY
