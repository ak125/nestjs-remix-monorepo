name: üöÄ Deploy
on:
  push:
    branches:
      - main
      - dev
  pull_request: {}

permissions:
  actions: write
  contents: read

jobs:
  lint:
    name: ‚¨£ ESLint
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Application
        run: npm run build

      - name: üî¨ Lint
        run: npm run lint

  typecheck:
    name:  ¶ TypeScript
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Application
        run: npm run build

      - name: üîé Type check
        run: npm run typecheck --if-present

      - name: üß™ URL Pattern Tests
        run: cd frontend && npm run test -- --run tests/unit/url-patterns.test.ts

  security:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: üîç npm audit (backend)
        run: cd backend && npm audit --audit-level=high
        continue-on-error: true

      - name: üîç npm audit (frontend)
        run: cd frontend && npm audit --audit-level=high
        continue-on-error: true

  # ============================================
  # P1.4-P1.5 - Checks Hardening (2026-02-02)
  # Voir docs/MIGRATION_PLAN_DEV_PREPROD_PROD.md
  # ============================================

  core-build:
    name: üîí Core Build Only
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: "--max-old-space-size=4096"
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: üîí Build core modules only
        run: |
          echo "üîí Building CORE modules (no DEV ONLY)"
          npm run build --filter=@fafa/backend --filter=@fafa/frontend --filter=@fafa/ui --filter=@repo/database-types

      - name: ‚úÖ Verify no DEV modules imported
        run: |
          echo "Checking app.module.ts for DEV imports..."
          # RmModule ALLOWED: provides /api/rm/* endpoints used by frontend product pages
          # (pieces.$gamme.$marque.$modele.$type.html ‚Üí fetchRmPageV2)
          if grep -E "^\s*(AiContentModule|KnowledgeGraphModule|RagProxyModule)" backend/src/app.module.ts; then
            echo "‚ùå ERREUR: Modules DEV ONLY d√©tect√©s dans app.module.ts!"
            echo "Voir docs/MIGRATION_PLAN_DEV_PREPROD_PROD.md"
            exit 1
          fi
          echo "‚úÖ Aucun module DEV ONLY import√©"

  import-firewall:
    name: üõ°Ô∏è Import Firewall
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: üõ°Ô∏è Check forbidden imports
        run: |
          echo "üõ°Ô∏è Checking for forbidden imports..."
          ERRORS=0

          # RmModule is PROD: provides /api/rm/* endpoints used by frontend
          # (pieces.$gamme.$marque.$modele.$type.html ‚Üí fetchRmPageV2)
          # No longer blocked - see P5.3 analysis (2026-02-03)

          # Check imports from ai-orchestrator
          if grep -rn "@repo/ai-orchestrator" backend/src --include="*.ts"; then
            echo "‚ùå Import from @repo/ai-orchestrator detected"
            ERRORS=$((ERRORS+1))
          fi

          # Check imports from contracts
          if grep -rn "@repo/contracts" backend/src --include="*.ts"; then
            echo "‚ùå Import from @repo/contracts detected"
            ERRORS=$((ERRORS+1))
          fi

          if [ $ERRORS -gt 0 ]; then
            echo "‚ùå $ERRORS import firewall violation(s) detected"
            echo "Voir docs/MIGRATION_PLAN_DEV_PREPROD_PROD.md"
            exit 1
          fi

          echo "‚úÖ Import firewall OK - No violations"

  rpc-gate-check:
    name: üõ°Ô∏è RPC Safety Gate
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: üõ°Ô∏è Check direct supabase.rpc() usage
        run: |
          echo "üõ°Ô∏è Checking for direct .rpc() calls (should use callRpc)..."

          # Install ripgrep
          sudo apt-get update && sudo apt-get install -y ripgrep

          # Count direct .rpc() calls excluding allowed patterns
          DIRECT_RPC=$(rg -l "\.rpc\(" backend/src --type ts 2>/dev/null | \
            rg -v "supabase-base.service|callRpc" | wc -l || echo "0")

          echo "Found $DIRECT_RPC files with direct .rpc() calls"

          # List them for visibility
          if [ "$DIRECT_RPC" -gt 0 ]; then
            echo ""
            echo "üìã Files with direct .rpc() calls:"
            rg -n "\.rpc\(" backend/src --type ts 2>/dev/null | \
              rg -v "supabase-base.service|callRpc" || true
            echo ""

            # Known bypass files (debug/internal)
            BYPASS_COUNT=$(rg -l "\.rpc\(" backend/src --type ts 2>/dev/null | \
              rg -v "supabase-base.service|callRpc" | \
              rg "googlebot-detector|enhanced-config|products.service|advice.service" | wc -l || echo "0")

            UNEXPECTED=$((DIRECT_RPC - BYPASS_COUNT))

            if [ "$UNEXPECTED" -gt 0 ]; then
              echo "‚ö†Ô∏è WARNING: $UNEXPECTED unexpected files with direct .rpc() calls"
              echo "All RPC calls should go through callRpc() for governance"
              # Warning only for now (observe mode)
              # exit 1
            else
              echo "‚úÖ Only bypass-allowed files have direct .rpc() calls ($BYPASS_COUNT files)"
            fi
          else
            echo "‚úÖ All RPC calls go through callRpc()"
          fi

  build:
    name: üê≥ build
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
      tag: preprod

  deploy:
    name: üß™ Deploy PREPROD
    runs-on: [self-hosted, Linux, X64]
    needs: [build, lint, typecheck, core-build, import-firewall, rpc-gate-check]
    if: ${{ (github.ref == 'refs/heads/main') && github.event_name == 'push' }}

    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4.1.1

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üß™ Deploy to PREPROD
        env:
          NODE_ENV: preprod
        run: |
          docker pull massdoc/nestjs-remix-monorepo:preprod

          PREPROD_DIR=~/preprod
          mkdir -p $PREPROD_DIR

          # Copier docker-compose.preprod.yml
          cp $GITHUB_WORKSPACE/docker-compose.preprod.yml $PREPROD_DIR/

          # Copier le .env de prod (controle par flag)
          if [ "${ALLOW_PROD_ENV_COPY:-0}" = "1" ] && [ -f ~/production/.env ]; then
            echo "‚ö†Ô∏è  ALLOW_PROD_ENV_COPY=1 enabled: copying production env (should be temporary)"
            cp ~/production/.env "$PREPROD_DIR/.env"
          else
            echo "‚ÑπÔ∏è  Skipping prod env copy (default safe mode)"
          fi

          cd $PREPROD_DIR

          # Arreter anciens conteneurs
          docker stop nestjs-remix-monorepo-preprod redis-preprod 2>/dev/null || true
          docker rm nestjs-remix-monorepo-preprod redis-preprod 2>/dev/null || true

          # Demarrer preprod
          docker compose -f docker-compose.preprod.yml up -d

          # Health check avec retry (max 2 min)
          echo "‚è≥ Waiting for PREPROD to start..."
          HEALTHY=0
          for i in {1..12}; do
            if curl -sf http://localhost:3100/health > /dev/null 2>&1; then
              echo "‚úÖ PREPROD is healthy after $((i*10))s"
              HEALTHY=1
              break
            fi
            echo "Attempt $i/12 - waiting 10s..."
            sleep 10
          done

          if [ "$HEALTHY" != "1" ]; then
            echo "‚ùå PREPROD health check failed after 2 minutes"
            docker ps | grep preprod || true
            docker logs nestjs-remix-monorepo-preprod --tail 50
            exit 1
          fi

          echo "‚úÖ PREPROD deployed successfully on port 3100"
          echo "üîó Test URL: http://$(hostname -I | awk '{print $1}'):3100"

          # Nettoyer les images
          docker image prune -f
