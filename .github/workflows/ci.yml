name: üöÄ Deploy
on:
  push:
    branches:
      - main
      - dev
  pull_request: {}

permissions:
  actions: write
  contents: read

jobs:
  lint:
    name: ‚¨£ ESLint
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Application
        run: npm run build

      - name: üî¨ Lint
        run: npm run lint

  typecheck:
    name:  ¶ TypeScript
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_REMOTE_ONLY: true
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Application
        run: npm run build

      - name: üîé Type check
        run: npm run typecheck --if-present

      - name: üß™ URL Pattern Tests
        run: cd frontend && npm run test -- --run tests/unit/url-patterns.test.ts

  security:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: üîç npm audit (backend)
        run: cd backend && npm audit --audit-level=high
        continue-on-error: true

      - name: üîç npm audit (frontend)
        run: cd frontend && npm audit --audit-level=high
        continue-on-error: true

  build:
    name: üê≥ build
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
      tag: preprod

  deploy:
    name: üß™ Deploy PREPROD
    runs-on: [self-hosted, Linux, X64]
    needs: [build, lint, typecheck]
    if: ${{ (github.ref == 'refs/heads/main') && github.event_name == 'push' }}

    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4.1.1

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üß™ Deploy to PREPROD
        env:
          NODE_ENV: preprod
        run: |
          docker pull massdoc/nestjs-remix-monorepo:preprod

          PREPROD_DIR=~/preprod
          mkdir -p $PREPROD_DIR

          # Copier docker-compose.preprod.yml
          cp $GITHUB_WORKSPACE/docker-compose.preprod.yml $PREPROD_DIR/

          # Copier le .env de prod (meme DB)
          if [ -f ~/production/.env ]; then
            cp ~/production/.env $PREPROD_DIR/.env
          else
            echo "‚ö†Ô∏è Warning: ~/production/.env not found, preprod may fail"
          fi

          cd $PREPROD_DIR

          # Arreter anciens conteneurs
          docker stop nestjs-remix-monorepo-preprod redis-preprod 2>/dev/null || true
          docker rm nestjs-remix-monorepo-preprod redis-preprod 2>/dev/null || true

          # Demarrer preprod
          docker compose -f docker-compose.preprod.yml up -d

          # Health check avec retry (max 2 min)
          echo "‚è≥ Waiting for PREPROD to start..."
          HEALTHY=0
          for i in {1..12}; do
            if curl -sf http://localhost:3100/health > /dev/null 2>&1; then
              echo "‚úÖ PREPROD is healthy after $((i*10))s"
              HEALTHY=1
              break
            fi
            echo "Attempt $i/12 - waiting 10s..."
            sleep 10
          done

          if [ "$HEALTHY" != "1" ]; then
            echo "‚ùå PREPROD health check failed after 2 minutes"
            docker ps | grep preprod || true
            docker logs nestjs-remix-monorepo-preprod --tail 50
            exit 1
          fi

          echo "‚úÖ PREPROD deployed successfully on port 3100"
          echo "üîó Test URL: http://$(hostname -I | awk '{print $1}'):3100"

          # Nettoyer les images
          docker image prune -f
