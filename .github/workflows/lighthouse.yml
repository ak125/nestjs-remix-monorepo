name: ðŸ”¦ Lighthouse CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Permet l'exÃ©cution manuelle
  workflow_dispatch:

jobs:
  lighthouse:
    name: ðŸ”¦ Performance Audit
    runs-on: [self-hosted, Linux, X64]
    # AprÃ¨s dÃ©ploiement sur main, ou sur PR pour baseline
    if: ${{ github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Wait for deployment (main only)
        if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
        run: |
          echo "â³ Waiting 30s for deployment to restart..."
          sleep 30

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            http://localhost:3000/
            http://localhost:3000/search?q=plaquette
            http://localhost:3000/pieces/catalogue
          budgetPath: ./frontend/lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3  # 3 runs pour moyenner les rÃ©sultats

      - name: Format Lighthouse results
        if: always()
        run: |
          echo "## ðŸ”¦ Lighthouse Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Performance audit completed. Check artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Targets" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Target |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| FCP | < 1.8s |" >> $GITHUB_STEP_SUMMARY
          echo "| LCP | < 2.5s |" >> $GITHUB_STEP_SUMMARY
          echo "| TBT | < 200ms |" >> $GITHUB_STEP_SUMMARY
          echo "| TTI | < 3.5s |" >> $GITHUB_STEP_SUMMARY

  # Job sÃ©parÃ© pour les alertes de performance critique
  performance-alert:
    name: âš ï¸ Performance Alert
    runs-on: [self-hosted, Linux, X64]
    needs: [lighthouse]
    if: failure()

    steps:
      - name: Alert on performance regression
        run: |
          echo "::warning::Performance budget exceeded! Review Lighthouse results."
          echo "## âš ï¸ Performance Alert" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more performance budgets were exceeded." >> $GITHUB_STEP_SUMMARY
          echo "Please review the Lighthouse CI artifacts and fix performance issues." >> $GITHUB_STEP_SUMMARY
