name: üöÄ Deploy PROD (via tag)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-prod:
    name: üöÄ Deploy to PROD
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üè∑Ô∏è Promote preprod ‚Üí production
        run: |
          echo "üì¶ Pulling preprod image..."
          docker pull massdoc/nestjs-remix-monorepo:preprod

          echo "üè∑Ô∏è Tagging as production..."
          docker tag massdoc/nestjs-remix-monorepo:preprod massdoc/nestjs-remix-monorepo:production
          docker tag massdoc/nestjs-remix-monorepo:preprod massdoc/nestjs-remix-monorepo:${{ github.ref_name }}

          echo "üì§ Pushing to registry..."
          docker push massdoc/nestjs-remix-monorepo:production
          docker push massdoc/nestjs-remix-monorepo:${{ github.ref_name }}

      - name: üöÄ Deploy to PROD
        env:
          NODE_ENV: production
        run: |
          docker pull massdoc/nestjs-remix-monorepo:production

          PROD_DIR=~/production
          mkdir -p $PROD_DIR/config/caddy

          # Sync configs
          rm -f $PROD_DIR/docker-compose.prod.yml $PROD_DIR/docker-compose.caddy.yml
          cp $GITHUB_WORKSPACE/docker-compose.prod.yml $PROD_DIR/
          cp $GITHUB_WORKSPACE/docker-compose.caddy.yml $PROD_DIR/
          cp $GITHUB_WORKSPACE/config/caddy/Caddyfile $PROD_DIR/config/caddy/

          cd $PROD_DIR

          # Valider .env
          echo "üîç Validating production .env file..."
          if [ ! -f ".env" ]; then
            echo "‚ùå FATAL: .env file missing at $PROD_DIR/.env"
            exit 1
          fi
          source .env
          REQUIRED_VARS="SUPABASE_URL SUPABASE_SERVICE_ROLE_KEY SYSTEMPAY_SITE_ID PAYBOX_SITE PAYBOX_HMAC_KEY SESSION_SECRET"
          for var in $REQUIRED_VARS; do
            if [ -z "${!var}" ]; then
              echo "‚ùå FATAL: Missing required env var: $var"
              exit 1
            fi
          done
          echo "‚úÖ All required environment variables present"

          docker network create automecanik-prod 2>/dev/null || true

          # Sauvegarder l'image actuelle pour rollback eventuel
          CURRENT_IMAGE=$(docker inspect --format='{{.Image}}' nestjs-remix-monorepo-prod 2>/dev/null || echo "")
          echo "üì¶ Current image: $CURRENT_IMAGE"

          docker stop nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true
          docker rm nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true

          docker compose -f docker-compose.prod.yml -f docker-compose.caddy.yml up -d

          echo "‚è≥ Waiting for containers to start (60s)..."
          sleep 60

          if ! docker ps | grep -q nestjs-remix-monorepo-prod; then
            echo "‚ùå Container not running - checking logs..."
            docker logs nestjs-remix-monorepo-prod --tail 50
            exit 1
          fi

          echo "üè• Running health check (inside container)..."
          RETRIES=3
          for i in $(seq 1 $RETRIES); do
            HEALTH=$(docker exec nestjs-remix-monorepo-prod wget -qO- http://localhost:3000/health 2>/dev/null || echo "")
            if echo "$HEALTH" | grep -q '"status":"ok"'; then
              echo "‚úÖ /health -> OK (attempt $i/$RETRIES)"
              break
            fi
            echo "‚è≥ Health check attempt $i/$RETRIES failed, waiting 10s..."
            sleep 10
          done
          if ! echo "$HEALTH" | grep -q '"status":"ok"'; then
            echo "‚ùå Health check failed after $RETRIES attempts"
            docker logs nestjs-remix-monorepo-prod --tail 30
            exit 1
          fi
          echo "‚úÖ PROD deployment successful - API responding"

          docker image prune -f

      - name: ‚úÖ Validate PROD
        run: |
          sleep 30
          FAILED=0

          # Test health INSIDE the container (bypasses Docker networking/Caddy)
          echo "üè• Testing health inside container..."
          HEALTH=$(docker exec nestjs-remix-monorepo-prod wget -qO- http://localhost:3000/health 2>/dev/null || echo "FAIL")
          if echo "$HEALTH" | grep -q '"status":"ok"'; then
            echo "‚úÖ /health -> OK (inside container)"
          else
            echo "‚ùå /health -> FAILED (inside container): $HEALTH"
            docker logs nestjs-remix-monorepo-prod --tail 20
            FAILED=1
          fi

          # Test homepage via host port (direct to NestJS, port 3000)
          echo "üåê Testing homepage via host..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "CF-IPCountry: FR" http://localhost:3000/ --max-time 30)
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ / -> $STATUS"
          else
            echo "‚ö†Ô∏è / -> $STATUS (non-blocking, may be Caddy/network issue)"
          fi

          # Test API endpoint (already validated in deploy step)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/catalog/families --max-time 30)
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ /api/catalog/families -> $STATUS"
          else
            echo "‚ùå /api/catalog/families -> $STATUS"
            FAILED=1
          fi

          if [ "$FAILED" = "1" ]; then
            echo "‚ùå Validation failed!"
            exit 1
          fi

          # Timing gate ‚Äî page produit R2 (warning, non-bloquant en prod)
          echo "‚è±Ô∏è Testing R2 product page response time..."
          T1=$(curl -s -o /dev/null -w "%{time_total}" http://localhost:3000/pieces/plaquette-de-frein-402/renault-140/megane-iii-140049/1-5-dci-100413.html --max-time 30 | awk '{printf "%.0f", $1 * 1000}')
          sleep 2
          T2=$(curl -s -o /dev/null -w "%{time_total}" http://localhost:3000/pieces/plaquette-de-frein-402/renault-140/megane-iii-140049/1-5-dci-100413.html --max-time 30 | awk '{printf "%.0f", $1 * 1000}')
          WORST=$(echo -e "$T1\n$T2" | sort -n | tail -1)

          if [ "$WORST" -gt 5000 ]; then
            echo "‚ö†Ô∏è R2 page response time: ${WORST}ms (threshold: 5000ms)"
            echo "::warning::Product page slow after deploy: ${WORST}ms ‚Äî check RPC performance"
          else
            echo "‚úÖ R2 page response time: ${WORST}ms (threshold: 5000ms)"
          fi

          echo "üéâ Version ${{ github.ref_name }} deployed to production!"

      - name: üîî Notify Slack on success
        if: ${{ success() && env.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"‚úÖ PROD deployed: ${{ github.ref_name }}\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"‚úÖ *Production Deployed*\n*Version:* \`${{ github.ref_name }}\`\n*Author:* ${{ github.actor }}\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>\"
                  }
                }
              ]
            }"

      - name: üîî Notify Slack on failure
        if: ${{ failure() && env.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"‚ùå PROD deploy FAILED: ${{ github.ref_name }}\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"‚ùå *Production Deploy FAILED*\n*Version:* \`${{ github.ref_name }}\`\n*Author:* ${{ github.actor }}\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>\"
                  }
                }
              ]
            }"
