name: üöÄ Deploy PROD (via tag)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-prod:
    name: üöÄ Deploy to PROD
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üè∑Ô∏è Promote preprod ‚Üí production
        run: |
          echo "üì¶ Pulling preprod image..."
          docker pull massdoc/nestjs-remix-monorepo:preprod

          echo "üè∑Ô∏è Tagging as production..."
          docker tag massdoc/nestjs-remix-monorepo:preprod massdoc/nestjs-remix-monorepo:production
          docker tag massdoc/nestjs-remix-monorepo:preprod massdoc/nestjs-remix-monorepo:${{ github.ref_name }}

          echo "üì§ Pushing to registry..."
          docker push massdoc/nestjs-remix-monorepo:production
          docker push massdoc/nestjs-remix-monorepo:${{ github.ref_name }}

      - name: Setup Node.js for sitemap generation
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üöÄ Deploy to PROD
        env:
          NODE_ENV: production
        run: |
          docker pull massdoc/nestjs-remix-monorepo:production

          PROD_DIR=~/production
          mkdir -p $PROD_DIR/config/caddy

          # Sync configs
          rm -f $PROD_DIR/docker-compose.prod.yml $PROD_DIR/docker-compose.caddy.yml
          cp $GITHUB_WORKSPACE/docker-compose.prod.yml $PROD_DIR/
          cp $GITHUB_WORKSPACE/docker-compose.caddy.yml $PROD_DIR/
          cp $GITHUB_WORKSPACE/config/caddy/Caddyfile $PROD_DIR/config/caddy/

          cd $PROD_DIR

          # Valider .env
          echo "üîç Validating production .env file..."
          if [ ! -f ".env" ]; then
            echo "‚ùå FATAL: .env file missing at $PROD_DIR/.env"
            exit 1
          fi
          source .env
          REQUIRED_VARS="SUPABASE_URL SUPABASE_SERVICE_ROLE_KEY SYSTEMPAY_SITE_ID PAYBOX_SITE PAYBOX_HMAC_KEY SESSION_SECRET"
          for var in $REQUIRED_VARS; do
            if [ -z "${!var}" ]; then
              echo "‚ùå FATAL: Missing required env var: $var"
              exit 1
            fi
          done
          echo "‚úÖ All required environment variables present"

          docker network create automecanik-prod 2>/dev/null || true

          # Sauvegarder l'image actuelle pour rollback eventuel
          CURRENT_IMAGE=$(docker inspect --format='{{.Image}}' nestjs-remix-monorepo-prod 2>/dev/null || echo "")
          echo "üì¶ Current image: $CURRENT_IMAGE"

          docker stop nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true
          docker rm nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true

          docker compose -f docker-compose.prod.yml -f docker-compose.caddy.yml up -d

          echo "‚è≥ Waiting for containers to start (60s)..."
          sleep 60

          if ! docker ps | grep -q nestjs-remix-monorepo-prod; then
            echo "‚ùå Container not running - checking logs..."
            docker logs nestjs-remix-monorepo-prod --tail 50
            exit 1
          fi

          echo "üè• Running health check..."
          if ! curl -sf http://localhost:3000/api/catalog/families > /dev/null; then
            echo "‚ùå Health check failed - API not responding"
            docker logs nestjs-remix-monorepo-prod --tail 30
            exit 1
          fi
          echo "‚úÖ PROD deployment successful - API responding"

          docker image prune -f

      - name: üó∫Ô∏è Generate static sitemaps (si necessaire)
        run: |
          PROD_DIR=~/production
          SITEMAP_FILE="$PROD_DIR/public/sitemaps/sitemap.xml"
          MAX_AGE_DAYS=7

          if [ -f "$SITEMAP_FILE" ]; then
            FILE_AGE=$(( ($(date +%s) - $(stat -c %Y "$SITEMAP_FILE")) / 86400 ))
            if [ $FILE_AGE -lt $MAX_AGE_DAYS ]; then
              echo "‚úÖ Sitemaps recents ($FILE_AGE jours) - generation ignoree"
              ls -la $PROD_DIR/public/sitemaps/
              exit 0
            fi
            echo "‚ö†Ô∏è Sitemaps anciens ($FILE_AGE jours) - regeneration necessaire..."
          else
            echo "üìù Sitemaps absents - generation initiale..."
          fi

          if [ -f "$PROD_DIR/.env" ]; then
            echo "üìÇ Chargement des variables depuis $PROD_DIR/.env"
            set -a
            source $PROD_DIR/.env
            set +a
          fi

          echo "üì¶ Installation des dependances backend..."
          cd $GITHUB_WORKSPACE/backend
          npm install --include=dev

          echo "üó∫Ô∏è Generation des sitemaps statiques..."
          mkdir -p $PROD_DIR/public/sitemaps
          export OUTPUT_DIR="$PROD_DIR/public/sitemaps"
          npx ts-node scripts/generate-sitemaps.ts

          echo "‚úÖ Sitemaps generes dans $PROD_DIR/public/sitemaps/"
          ls -la $PROD_DIR/public/sitemaps/

          echo "üîÑ Rechargement de Caddy..."
          docker exec nestjs-remix-caddy caddy reload --config /etc/caddy/Caddyfile || docker restart nestjs-remix-caddy

      - name: ‚úÖ Validate PROD
        run: |
          sleep 30
          BASE_URL="https://www.automecanik.com"
          FAILED=0

          URLS=("/" "/health")

          for url in "${URLS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL$url" --max-time 30)
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ $url -> $STATUS"
            else
              echo "‚ùå $url -> $STATUS (expected 200)"
              FAILED=1
            fi
          done

          if [ "$FAILED" = "1" ]; then
            echo "‚ùå Some URLs failed validation!"
            exit 1
          fi

          echo "üéâ Version ${{ github.ref_name }} deployed to production!"
