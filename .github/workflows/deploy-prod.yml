name: üöÄ Deploy PROD (via tag)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-prod:
    name: üöÄ Deploy to PROD
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üè∑Ô∏è Promote preprod ‚Üí production
        run: |
          echo "üì¶ Pulling preprod image..."
          docker pull massdoc/nestjs-remix-monorepo:preprod

          echo "üè∑Ô∏è Tagging as production..."
          docker tag massdoc/nestjs-remix-monorepo:preprod massdoc/nestjs-remix-monorepo:production
          docker tag massdoc/nestjs-remix-monorepo:preprod massdoc/nestjs-remix-monorepo:${{ github.ref_name }}

          echo "üì§ Pushing to registry..."
          docker push massdoc/nestjs-remix-monorepo:production
          docker push massdoc/nestjs-remix-monorepo:${{ github.ref_name }}

      - name: üöÄ Deploy to PROD
        env:
          NODE_ENV: production
        run: |
          docker pull massdoc/nestjs-remix-monorepo:production

          PROD_DIR=~/production
          mkdir -p $PROD_DIR/config/caddy

          # Sync configs
          rm -f $PROD_DIR/docker-compose.prod.yml $PROD_DIR/docker-compose.caddy.yml
          cp $GITHUB_WORKSPACE/docker-compose.prod.yml $PROD_DIR/
          cp $GITHUB_WORKSPACE/docker-compose.caddy.yml $PROD_DIR/
          cp $GITHUB_WORKSPACE/config/caddy/Caddyfile $PROD_DIR/config/caddy/

          cd $PROD_DIR

          # Valider .env
          echo "üîç Validating production .env file..."
          if [ ! -f ".env" ]; then
            echo "‚ùå FATAL: .env file missing at $PROD_DIR/.env"
            exit 1
          fi
          source .env
          REQUIRED_VARS="SUPABASE_URL SUPABASE_SERVICE_ROLE_KEY SYSTEMPAY_SITE_ID PAYBOX_SITE PAYBOX_HMAC_KEY SESSION_SECRET"
          for var in $REQUIRED_VARS; do
            if [ -z "${!var}" ]; then
              echo "‚ùå FATAL: Missing required env var: $var"
              exit 1
            fi
          done
          echo "‚úÖ All required environment variables present"

          docker network create automecanik-prod 2>/dev/null || true

          # Sauvegarder l'image actuelle pour rollback eventuel
          CURRENT_IMAGE=$(docker inspect --format='{{.Image}}' nestjs-remix-monorepo-prod 2>/dev/null || echo "")
          echo "üì¶ Current image: $CURRENT_IMAGE"

          docker stop nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true
          docker rm nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true

          docker compose -f docker-compose.prod.yml -f docker-compose.caddy.yml up -d --no-deps monorepo_prod caddy redis_prod

          echo "‚è≥ Waiting for containers to start (60s)..."
          sleep 60

          if ! docker ps | grep -q nestjs-remix-monorepo-prod; then
            echo "‚ùå Container not running - checking logs..."
            docker logs nestjs-remix-monorepo-prod --tail 50
            exit 1
          fi

          echo "üè• Running health check (inside container)..."
          RETRIES=3
          for i in $(seq 1 $RETRIES); do
            HEALTH=$(docker exec nestjs-remix-monorepo-prod wget -qO- http://localhost:3000/health 2>/dev/null || echo "")
            if echo "$HEALTH" | grep -q '"status":"ok"'; then
              echo "‚úÖ /health -> OK (attempt $i/$RETRIES)"
              break
            fi
            echo "‚è≥ Health check attempt $i/$RETRIES failed, waiting 10s..."
            sleep 10
          done
          if ! echo "$HEALTH" | grep -q '"status":"ok"'; then
            echo "‚ùå Health check failed after $RETRIES attempts"
            docker logs nestjs-remix-monorepo-prod --tail 30
            exit 1
          fi
          echo "‚úÖ PROD deployment successful - API responding"

          docker image prune -f

      - name: ‚úÖ Validate PROD
        run: |
          sleep 30
          FAILED=0

          # All checks run INSIDE the container (host networking unreliable on self-hosted runner)
          EXEC="docker exec nestjs-remix-monorepo-prod"

          # Test health
          echo "üè• Testing health inside container..."
          HEALTH=$($EXEC wget -qO- http://localhost:3000/health 2>/dev/null || echo "FAIL")
          if echo "$HEALTH" | grep -q '"status":"ok"'; then
            echo "‚úÖ /health -> OK"
          else
            echo "‚ùå /health -> FAILED: $HEALTH"
            docker logs nestjs-remix-monorepo-prod --tail 20
            FAILED=1
          fi

          # Test API endpoint
          echo "üîå Testing API endpoint..."
          API=$($EXEC wget -qO- http://localhost:3000/api/catalog/families 2>/dev/null || echo "FAIL")
          if echo "$API" | grep -q '"families"'; then
            echo "‚úÖ /api/catalog/families -> OK"
          else
            echo "‚ö†Ô∏è /api/catalog/families -> unexpected response (non-blocking)"
          fi

          # Admin guard verification (warning only, non-blocking)
          echo "üõ°Ô∏è Testing admin guards..."
          ADMIN_RESP=$($EXEC wget -q --server-response -O /dev/null http://localhost:3000/api/admin/content-refresh/dashboard 2>&1 | grep "HTTP/" | awk '{print $2}')
          if [ "$ADMIN_RESP" = "403" ] || [ "$ADMIN_RESP" = "401" ]; then
            echo "‚úÖ admin guard /content-refresh -> $ADMIN_RESP"
          else
            echo "‚ö†Ô∏è admin guard /content-refresh -> ${ADMIN_RESP:-unknown} (expected 401/403)"
          fi

          ADMIN_RESP=$($EXEC wget -q --server-response -O /dev/null http://localhost:3000/api/admin/page-briefs 2>&1 | grep "HTTP/" | awk '{print $2}')
          if [ "$ADMIN_RESP" = "403" ] || [ "$ADMIN_RESP" = "401" ]; then
            echo "‚úÖ admin guard /page-briefs -> $ADMIN_RESP"
          else
            echo "‚ö†Ô∏è admin guard /page-briefs -> ${ADMIN_RESP:-unknown} (expected 401/403)"
          fi

          if [ "$FAILED" = "1" ]; then
            echo "‚ùå Validation failed!"
            exit 1
          fi

          echo "üéâ Version ${{ github.ref_name }} deployed to production!"

      - name: üîî Notify Slack on success
        if: ${{ success() && env.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"‚úÖ PROD deployed: ${{ github.ref_name }}\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"‚úÖ *Production Deployed*\n*Version:* \`${{ github.ref_name }}\`\n*Author:* ${{ github.actor }}\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>\"
                  }
                }
              ]
            }"

      - name: üîî Notify Slack on failure
        if: ${{ failure() && env.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"‚ùå PROD deploy FAILED: ${{ github.ref_name }}\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"‚ùå *Production Deploy FAILED*\n*Version:* \`${{ github.ref_name }}\`\n*Author:* ${{ github.actor }}\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>\"
                  }
                }
              ]
            }"
