name: ğŸš€ Deploy PROD (via tag)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-prod:
    name: ğŸš€ Deploy to PROD
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Promote preprod â†’ production
        run: |
          echo "ğŸ“¦ Pulling preprod image..."
          docker pull massdoc/nestjs-remix-monorepo:preprod

          echo "ğŸ·ï¸ Tagging as production..."
          docker tag massdoc/nestjs-remix-monorepo:preprod massdoc/nestjs-remix-monorepo:production
          docker tag massdoc/nestjs-remix-monorepo:preprod massdoc/nestjs-remix-monorepo:${{ github.ref_name }}

          echo "ğŸ“¤ Pushing to registry..."
          docker push massdoc/nestjs-remix-monorepo:production
          docker push massdoc/nestjs-remix-monorepo:${{ github.ref_name }}

      - name: ğŸš€ Deploy to PROD
        env:
          NODE_ENV: production
        run: |
          docker pull massdoc/nestjs-remix-monorepo:production

          PROD_DIR=~/production
          mkdir -p $PROD_DIR/config/caddy

          # Sync configs
          rm -f $PROD_DIR/docker-compose.prod.yml $PROD_DIR/docker-compose.caddy.yml
          cp $GITHUB_WORKSPACE/docker-compose.prod.yml $PROD_DIR/
          cp $GITHUB_WORKSPACE/docker-compose.caddy.yml $PROD_DIR/
          cp $GITHUB_WORKSPACE/config/caddy/Caddyfile $PROD_DIR/config/caddy/

          cd $PROD_DIR

          # Valider .env
          echo "ğŸ” Validating production .env file..."
          if [ ! -f ".env" ]; then
            echo "âŒ FATAL: .env file missing at $PROD_DIR/.env"
            exit 1
          fi
          source .env
          REQUIRED_VARS="SUPABASE_URL SUPABASE_SERVICE_ROLE_KEY SYSTEMPAY_SITE_ID PAYBOX_SITE PAYBOX_HMAC_KEY SESSION_SECRET"
          for var in $REQUIRED_VARS; do
            if [ -z "${!var}" ]; then
              echo "âŒ FATAL: Missing required env var: $var"
              exit 1
            fi
          done
          echo "âœ… All required environment variables present"

          docker network create automecanik-prod 2>/dev/null || true

          # Sauvegarder l'image actuelle pour rollback eventuel
          CURRENT_IMAGE=$(docker inspect --format='{{.Image}}' nestjs-remix-monorepo-prod 2>/dev/null || echo "")
          echo "ğŸ“¦ Current image: $CURRENT_IMAGE"

          docker stop nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true
          docker rm nestjs-remix-caddy nestjs-remix-monorepo-prod 2>/dev/null || true

          docker compose -f docker-compose.prod.yml -f docker-compose.caddy.yml up -d

          echo "â³ Waiting for containers to start (60s)..."
          sleep 60

          if ! docker ps | grep -q nestjs-remix-monorepo-prod; then
            echo "âŒ Container not running - checking logs..."
            docker logs nestjs-remix-monorepo-prod --tail 50
            exit 1
          fi

          echo "ğŸ¥ Running health check..."
          if ! curl -sf http://localhost:3000/api/catalog/families > /dev/null; then
            echo "âŒ Health check failed - API not responding"
            docker logs nestjs-remix-monorepo-prod --tail 30
            exit 1
          fi
          echo "âœ… PROD deployment successful - API responding"

          docker image prune -f

      - name: âœ… Validate PROD
        run: |
          sleep 30
          FAILED=0

          # Test health INSIDE the container (bypasses Docker networking/Caddy)
          echo "ğŸ¥ Testing health inside container..."
          HEALTH=$(docker exec nestjs-remix-monorepo-prod wget -qO- http://localhost:3000/health 2>/dev/null || echo "FAIL")
          if echo "$HEALTH" | grep -q '"status":"ok"'; then
            echo "âœ… /health -> OK (inside container)"
          else
            echo "âŒ /health -> FAILED (inside container): $HEALTH"
            docker logs nestjs-remix-monorepo-prod --tail 20
            FAILED=1
          fi

          # Test homepage via host port (direct to NestJS, port 3000)
          echo "ğŸŒ Testing homepage via host..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "CF-IPCountry: FR" http://localhost:3000/ --max-time 30)
          if [ "$STATUS" = "200" ]; then
            echo "âœ… / -> $STATUS"
          else
            echo "âš ï¸ / -> $STATUS (non-blocking, may be Caddy/network issue)"
          fi

          # Test API endpoint (already validated in deploy step)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/catalog/families --max-time 30)
          if [ "$STATUS" = "200" ]; then
            echo "âœ… /api/catalog/families -> $STATUS"
          else
            echo "âŒ /api/catalog/families -> $STATUS"
            FAILED=1
          fi

          if [ "$FAILED" = "1" ]; then
            echo "âŒ Validation failed!"
            exit 1
          fi

          echo "ğŸ‰ Version ${{ github.ref_name }} deployed to production!"
