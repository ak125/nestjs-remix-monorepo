name: üó∫Ô∏è Generate Sitemaps (Nightly)

on:
  # D√©clenchement manuel
  workflow_dispatch:
    inputs:
      type:
        description: 'Sitemap type to generate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - products
          - blog
          - pages
          - delta
      
      includeHreflang:
        description: 'Include hreflang links'
        required: false
        default: true
        type: boolean
      
      includeImages:
        description: 'Include image sitemaps'
        required: false
        default: true
        type: boolean

  # D√©clenchement automatique (3h du matin UTC)
  schedule:
    - cron: '0 3 * * *'

  # D√©clenchement sur push tags (releases)
  push:
    tags:
      - 'v*.*.*'

env:
  NODE_VERSION: '20.x'

jobs:
  generate-sitemaps:
    name: Generate & Deploy Sitemaps
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      ##########################################################################
      # SETUP
      ##########################################################################
      
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci
      
      ##########################################################################
      # BUILD
      ##########################################################################
      
      - name: üèóÔ∏è Build backend
        run: npm run build --workspace=backend
        env:
          NODE_ENV: production
      
      ##########################################################################
      # START SERVICES
      ##########################################################################

      - name: üê≥ Start Redis
        run: |
          docker run -d --name redis-ci -p 6379:6379 redis:7-alpine
          sleep 5
          docker exec redis-ci redis-cli ping

      - name: üìÇ Create output directories
        run: |
          mkdir -p public/sitemaps
          mkdir -p logs/cron

      - name: üöÄ Start NestJS backend
        run: |
          cd backend
          # Start backend with output logging
          npm run start:prod > /tmp/backend.log 2>&1 &
          BACKEND_PID=$!
          echo "Backend PID: $BACKEND_PID"

          # Wait and check if process is still running
          sleep 10
          if ! kill -0 $BACKEND_PID 2>/dev/null; then
            echo "‚ùå Backend crashed! Showing logs:"
            cat /tmp/backend.log
            exit 1
          fi

          # Wait more for full startup
          sleep 20

          # Show startup logs
          echo "üìã Backend startup logs:"
          cat /tmp/backend.log

          # Check health
          curl --retry 10 --retry-delay 5 http://localhost:3000/health || {
            echo "‚ùå Health check failed! Full logs:"
            cat /tmp/backend.log
            exit 1
          }
        env:
          NODE_ENV: production
          REDIS_URL: redis://localhost:6379
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_KEY }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET || 'ci-temp-session-secret-32chars!' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'ci-temp-jwt-secret-32characters!' }}
          # Payment config (dummy values - not needed for sitemap generation)
          SYSTEMPAY_SITE_ID: 'ci-dummy-site-id'
          SYSTEMPAY_CERTIFICATE_PROD: 'ci-dummy-cert-prod'
          SYSTEMPAY_CERTIFICATE_TEST: 'ci-dummy-cert-test'
          APP_URL: 'http://localhost:3000'
      
      ##########################################################################
      # GENERATE SITEMAPS
      ##########################################################################
      
      - name: üîÑ Generate Delta Sitemap
        run: |
          curl -X POST "http://localhost:3000/sitemap-v2/delta/generate" \
            -H "Content-Type: application/json" \
            -o delta-response.json
          cat delta-response.json
          
          if ! jq -e '.success' delta-response.json > /dev/null; then
            echo "‚ùå Delta sitemap generation failed"
            exit 1
          fi
      
      - name: üóúÔ∏è Generate Streaming Sitemaps
        run: |
          TYPE="${{ github.event.inputs.type || 'all' }}"
          HREFLANG="${{ github.event.inputs.includeHreflang || 'true' }}"
          IMAGES="${{ github.event.inputs.includeImages || 'true' }}"

          curl -X POST "http://localhost:3000/sitemap-v2/streaming/generate?type=$TYPE&includeHreflang=$HREFLANG&includeImages=$IMAGES" \
            -H "Content-Type: application/json" \
            -o streaming-response.json
          cat streaming-response.json

          if ! jq -e '.success' streaming-response.json > /dev/null; then
            echo "‚ùå Streaming sitemap generation failed"
            exit 1
          fi

      - name: üó∫Ô∏è Generate All Sitemaps (Unified SEO 2026)
        run: |
          echo "üöÄ Generating all sitemaps with unified service..."
          # Use absolute path to avoid issues with backend running from different directory
          OUTPUT_DIR="${GITHUB_WORKSPACE}/public/sitemaps"
          echo "üìÇ Output directory: $OUTPUT_DIR"

          curl -X POST "http://localhost:3000/api/sitemap/generate-all?outputDir=${OUTPUT_DIR}" \
            -H "Content-Type: application/json" \
            -o unified-response.json

          echo "üìã Response:"
          cat unified-response.json

          if ! jq -e '.success' unified-response.json > /dev/null; then
            echo "‚ùå Unified sitemap generation failed"
            exit 1
          fi

          echo "‚úÖ Generated sitemaps:"
          jq -r '.data.files[] | "  - \(.name): \(.urlCount) URLs"' unified-response.json || echo "No files array"
          echo ""
          echo "üìä Total: $(jq -r '.data.totalUrls' unified-response.json) URLs in $(jq -r '.data.duration' unified-response.json)ms"

          # Verify files were created
          echo "üìÅ Files in output directory:"
          ls -la "$OUTPUT_DIR" || echo "Directory not found or empty"
      
      - name: üìä Fetch Generation Stats
        run: |
          echo "## üìà Delta Stats"
          curl -s "http://localhost:3000/sitemap-v2/delta/stats" | jq .
          
          echo "## üì¶ Streaming Files"
          curl -s "http://localhost:3000/sitemap-v2/streaming/files" | jq '.data | length'
      
      ##########################################################################
      # VALIDATE
      ##########################################################################
      
      - name: ‚úÖ Validate Sitemaps XML
        run: |
          cd public/sitemaps
          
          for file in *.xml; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              xmllint --noout "$file" || exit 1
            fi
          done
          
          echo "‚úÖ All XML files are valid"
      
      - name: üîç Check Sitemap Sizes
        run: |
          cd public/sitemaps

          echo "## File Sizes"
          if ls *.xml >/dev/null 2>&1; then
            du -sh *.xml 2>/dev/null || echo "No XML files found"
          else
            echo "‚ö†Ô∏è No XML files found in public/sitemaps"
            ls -la . || echo "Directory listing failed"
          fi

          echo "## Compression Ratios"
          for gz in *.xml.gz; do
            if [ -f "$gz" ]; then
              ORIGINAL=$(gzip -l "$gz" | tail -1 | awk '{print $2}')
              COMPRESSED=$(stat -f%z "$gz" 2>/dev/null || stat -c%s "$gz")
              RATIO=$(echo "scale=1; 100 - ($COMPRESSED * 100 / $ORIGINAL)" | bc)
              echo "$gz: ${RATIO}% compression"
            fi
          done
        continue-on-error: true
      
      ##########################################################################
      # UPLOAD TO S3 (optionnel)
      ##########################################################################
      
      - name: ‚òÅÔ∏è Upload to S3
        if: github.ref == 'refs/heads/main'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1
      
      - name: üì§ Sync sitemaps to S3
        if: github.ref == 'refs/heads/main'
        run: |
          aws s3 sync public/sitemaps/ s3://automecanik-sitemaps/ \
            --delete \
            --cache-control "public, max-age=86400" \
            --metadata-directive REPLACE
          
          echo "‚úÖ Sitemaps uploaded to S3"
      
      ##########################################################################
      # NOTIFY
      ##########################################################################
      
      - name: üí¨ Notify Slack
        if: always()
        continue-on-error: true
        uses: slackapi/slack-github-action@v2
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "${{ job.status == 'success' && '‚úÖ' || '‚ùå' }} Sitemap Generation: ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Sitemap Generation*\nStatus: ${{ job.status }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}"
                  }
                }
              ]
            }
      
      ##########################################################################
      # CLEANUP
      ##########################################################################
      
      - name: üßπ Cleanup old deltas
        run: |
          curl -X POST "http://localhost:3000/sitemap-v2/delta/cleanup" \
            -H "Content-Type: application/json"
      
      - name: üê≥ Stop Docker services
        if: always()
        run: docker stop redis-ci || true
      
      ##########################################################################
      # ARTIFACTS
      ##########################################################################
      
      - name: üì¶ Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sitemaps-${{ github.run_number }}
          path: |
            public/sitemaps/**
            logs/cron/**
            delta-response.json
            streaming-response.json
            unified-response.json
          retention-days: 7
