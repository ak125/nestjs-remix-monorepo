services:
  monorepo_preprod:
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://redis_preprod:6379
      - REDIS_HOST=redis_preprod
      - REDIS_PORT=6379
      - NODE_ENV=preprod
      - DATABASE_URL
      - SUPABASE_SERVICE_ROLE_KEY
      - SUPABASE_URL
      - USE_UNIFIED_RPC=true
      # ðŸ›¡ï¸ RPC Safety Gate - ENFORCE P1 (2026-02-03)
      - RPC_GATE_MODE=enforce
      - RPC_GATE_ENFORCE_LEVEL=P1

    container_name: nestjs-remix-monorepo-preprod
    image: massdoc/nestjs-remix-monorepo:preprod
    restart: always
    ports:
      - "3100:3000"
    networks:
      - automecanik-preprod
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  redis_preprod:
    image: redis:7-alpine
    container_name: redis-preprod
    restart: always
    command: >
      redis-server
      --appendonly yes
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
    volumes:
      - /dev/volumes/nestjs-remix/preprod/sessions/:/data
    networks:
      - automecanik-preprod

networks:
  automecanik-preprod:
    driver: bridge
