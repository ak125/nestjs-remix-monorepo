services:
  caddy:
    image: caddy:2-alpine
    container_name: nestjs-remix-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp" # HTTP/3
    volumes:
      # Configuration
      - ./config/caddy/Caddyfile:/etc/caddy/Caddyfile:ro

      # Donn√©es persistantes (certificats SSL)
      - caddy_data:/data
      - caddy_config:/config

      # Logs
      - ./logs/caddy:/var/log/caddy

      # Sitemaps statiques (714k URLs g√©n√©r√©s automatiquement) - volume persistant
      - /dev/volumes/nestjs-remix/production/sitemaps:/srv/sitemaps:ro

      # Configuration g√©n√©r√©e pour redirections (optionnel)
      - ./config/caddy/caddy-pieces-redirects.conf:/etc/caddy/redirects.conf:ro
    
    environment:
      - CADDY_ADMIN=off
    
    networks:
      - automecanik-prod
    
    depends_on:
      - monorepo_prod
    
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Service de g√©n√©ration automatique des r√®gles de redirection (optionnel)
  caddy-config-generator:
    image: curlimages/curl:latest
    container_name: caddy-config-generator
    profiles: ["tools"]
    command: >
      sh -c "
      echo 'üîÑ G√©n√©ration de la configuration Caddy...';
      curl -s http://monorepo_prod:3000/api/vehicles/migration/generate-caddy-rules > /output/caddy-pieces-redirects.conf;
      echo '‚úÖ Configuration g√©n√©r√©e!';
      "
    volumes:
      - ./:/output
    networks:
      - automecanik-prod
    depends_on:
      - monorepo_prod

networks:
  automecanik-prod:
    external: true

volumes:
  caddy_data:
    driver: local
  caddy_config:
    driver: local
