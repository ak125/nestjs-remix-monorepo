services:
  monorepo_prod:
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis_prod:6379
      - REDIS_HOST=redis_prod
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - NODE_ENV
      - DATABASE_URL
      - SUPABASE_SERVICE_ROLE_KEY
      - SUPABASE_URL
      - USE_UNIFIED_RPC=true
      - USE_RM_API=true
      - USE_RM_PAGE=true


    container_name: nestjs-remix-monorepo-prod
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    image: massdoc/nestjs-remix-monorepo:production
    restart: always
    ports:
      - 3000:3000
    volumes:
      - /var/www/sitemaps:/var/www/sitemaps:rw
      - /var/www/crawl-hubs:/var/www/crawl-hubs:rw
    networks:
      - automecanik-prod
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/api/catalog/families"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  redis_prod:
    image: redis:7-alpine
    restart: always
    # SECURITY: Never expose Redis publicly - internal network only
    # ports:
    #   - '6379:6379'
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes: 
      - /dev/volumes/nestjs-remix/production/sessions/:/data
    networks:
      - automecanik-prod

networks:
  automecanik-prod:
    external: true
