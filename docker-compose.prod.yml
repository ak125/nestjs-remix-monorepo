services:
  monorepo_prod:
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis_prod:6379
      - REDIS_HOST=redis_prod
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - NODE_ENV
      - DATABASE_URL
      - SUPABASE_SERVICE_ROLE_KEY
      - SUPABASE_URL
      - USE_UNIFIED_RPC=true
      - USE_RM_API=true
      - USE_RM_PAGE=true
      # ðŸ›¡ï¸ RPC Safety Gate - ENFORCE P2 (2026-02-03)
      # P2 activÃ© aprÃ¨s migration 12 read-only vers allowlist (commit ba00599d)
      - RPC_GATE_MODE=enforce
      - RPC_GATE_ENFORCE_LEVEL=P2
      # ðŸ›¡ï¸ BotGuard - Protection anti-bots (geo-block CN, behavioral scoring)
      - BOT_GUARD_ENABLED=true
      - BOT_GUARD_BLOCKED_COUNTRIES=CN
      - BOT_GUARD_SUSPICION_THRESHOLD=80
      # RAG Pipeline Phase 2b - Canary Ã©largi (2026-02-22)
      # Gates bloquants pour 25 gammes canary
      - EVIDENCE_PACK_ENABLED=true
      - HARD_GATES_ENABLED=true
      - AUTO_REPAIR_ENABLED=true
      - SAFE_FALLBACK_ENABLED=true
      - CANARY_GAMMES=disque-de-frein,filtre-a-huile,bougie-d-allumage,courroie-de-distribution,pompe-a-eau,agregat-de-freinage,alternateur,arbre-a-came,attelage,bague-d-etancheite-cardan,bagues-d-etancheite-moteur,balais-d-essuie-glace,barre-de-direction,barre-stabilisatrice,biellette-de-barre-stabilisatrice,bobine-d-allumage,boitier-de-prechauffage,bouchon-de-vidange,bougie-de-prechauffage,bouteille-deshydratante,bras-de-suspension,bride-de-liquide-de-refroidissement,butee-d-embrayage,butee-elastique-d-amortisseur,cable-d-embrayage
      - RAG_SERVICE_URL=http://rag-api:8000
      - RAG_API_KEY=856528eb83bd8b36867bc0bbf8ead7796f69de30fa6888a6876b54f4d98be08a

    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
    container_name: nestjs-remix-monorepo-prod
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    image: massdoc/nestjs-remix-monorepo:production
    restart: always
    expose:
      - "3000"
    volumes:
      - /var/www/sitemaps:/var/www/sitemaps:rw
      - /var/www/crawl-hubs:/var/www/crawl-hubs:rw
      - /opt/automecanik/rag/knowledge:/opt/automecanik/rag/knowledge:ro
    networks:
      - automecanik-prod
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  redis_prod:
    image: redis:7-alpine
    restart: always
    # SECURITY: Never expose Redis publicly - internal network only
    # ports:
    #   - '6379:6379'
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
    volumes: 
      - /dev/volumes/nestjs-remix/production/sessions/:/data
    networks:
      - automecanik-prod

networks:
  automecanik-prod:
    external: true
