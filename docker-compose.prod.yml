services:
  monorepo_prod:
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis_prod:6379
      - REDIS_HOST=redis_prod
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - NODE_ENV
      - DATABASE_URL
      - SUPABASE_SERVICE_ROLE_KEY
      - SUPABASE_URL
      - USE_UNIFIED_RPC=true
      - USE_RM_API=true
      - USE_RM_PAGE=true
      # ðŸ›¡ï¸ RPC Safety Gate - ENFORCE P2 (2026-02-03)
      # P2 activÃ© aprÃ¨s migration 12 read-only vers allowlist (commit ba00599d)
      - RPC_GATE_MODE=enforce
      - RPC_GATE_ENFORCE_LEVEL=P2
      # ðŸ›¡ï¸ BotGuard - Protection anti-bots (geo-block CN, behavioral scoring)
      - BOT_GUARD_ENABLED=true
      - BOT_GUARD_BLOCKED_COUNTRIES=CN
      - BOT_GUARD_SUSPICION_THRESHOLD=80
      # RAG Pipeline Phase 1 - Observe-only (2026-02-21)
      # Evidence packs collectes mais gates NON bloquants
      - EVIDENCE_PACK_ENABLED=true
      - HARD_GATES_ENABLED=false
      - AUTO_REPAIR_ENABLED=false
      - SAFE_FALLBACK_ENABLED=false
      - CANARY_GAMMES=

    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
    container_name: nestjs-remix-monorepo-prod
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    image: massdoc/nestjs-remix-monorepo:production
    restart: always
    ports:
      - 3000:3000
    volumes:
      - /var/www/sitemaps:/var/www/sitemaps:rw
      - /var/www/crawl-hubs:/var/www/crawl-hubs:rw
    networks:
      - automecanik-prod
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  redis_prod:
    image: redis:7-alpine
    restart: always
    # SECURITY: Never expose Redis publicly - internal network only
    # ports:
    #   - '6379:6379'
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
    volumes: 
      - /dev/volumes/nestjs-remix/production/sessions/:/data
    networks:
      - automecanik-prod

networks:
  automecanik-prod:
    external: true
