services:
  monorepo_prod:
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis_prod:6379
      - REDIS_HOST=redis_prod
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - NODE_ENV
      - DATABASE_URL
      - SUPABASE_SERVICE_ROLE_KEY
      - SUPABASE_URL
      - USE_UNIFIED_RPC=true
      - USE_RM_API=true
      - USE_RM_PAGE=true
      # ðŸ›¡ï¸ RPC Safety Gate - ENFORCE P2 (2026-02-03)
      # P2 activÃ© aprÃ¨s migration 12 read-only vers allowlist (commit ba00599d)
      - RPC_GATE_MODE=enforce
      - RPC_GATE_ENFORCE_LEVEL=P2
      # ðŸ›¡ï¸ BotGuard - Protection anti-bots (geo-block CN, behavioral scoring)
      - BOT_GUARD_ENABLED=true
      - BOT_GUARD_BLOCKED_COUNTRIES=CN
      - BOT_GUARD_SUSPICION_THRESHOLD=80
      # RAG Pipeline Phase 2b - Canary Ã©largi (2026-02-22)
      # Gates bloquants pour 25 gammes canary
      - EVIDENCE_PACK_ENABLED=true
      - HARD_GATES_ENABLED=true
      - AUTO_REPAIR_ENABLED=true
      - SAFE_FALLBACK_ENABLED=true
      - CANARY_GAMMES=disque-de-frein,filtre-a-huile,bougie-d-allumage,courroie-de-distribution,pompe-a-eau,agregat-de-freinage,alternateur,arbre-a-came,attelage,bague-d-etancheite-cardan,bagues-d-etancheite-moteur,balais-d-essuie-glace,barre-de-direction,barre-stabilisatrice,biellette-de-barre-stabilisatrice,bobine-d-allumage,boitier-de-prechauffage,bouchon-de-vidange,bougie-de-prechauffage,bouteille-deshydratante,bras-de-suspension,bride-de-liquide-de-refroidissement,butee-d-embrayage,butee-elastique-d-amortisseur,cable-d-embrayage
      # Brief Gates Phase 1: observe-only (toutes les 6 gates s'executent, aucune ne bloque)
      - BRIEF_GATES_ENABLED=true
      - BRIEF_GATES_OBSERVE_ONLY=true
      - KEYWORD_DENSITY_GATE_ENABLED=true
      - RAG_SERVICE_URL=http://rag-api:8000
      - RAG_API_KEY=856528eb83bd8b36867bc0bbf8ead7796f69de30fa6888a6876b54f4d98be08a
      # Internal API key for RAG webhook â†’ NestJS auth
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      # Video Render Service (P6.1 â€” Canary controlee)
      # Rollback: VIDEO_CANARY_ENABLED=false â†’ restart â†’ canary off, stub continue
      - VIDEO_RENDER_ENABLED=true
      - VIDEO_CANARY_ENABLED=true
      - VIDEO_RENDER_ENGINE=remotion
      - VIDEO_CANARY_ELIGIBLE_VIDEO_TYPES=short
      - VIDEO_CANARY_QUOTA_PER_DAY=5
      - VIDEO_RENDER_BASE_URL=http://remotion_renderer:3100
      # P7e: Video pipeline concurrency (1 = sequential, safe default)
      - VIDEO_PIPELINE_CONCURRENCY=1

    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
    container_name: nestjs-remix-monorepo-prod
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    image: massdoc/nestjs-remix-monorepo:production
    restart: always
    expose:
      - "3000"
    volumes:
      - /var/www/sitemaps:/var/www/sitemaps:rw
      - /var/www/crawl-hubs:/var/www/crawl-hubs:rw
      - /opt/automecanik/rag/knowledge:/opt/automecanik/rag/knowledge:ro
    networks:
      - automecanik-prod
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  remotion_renderer:
    image: automecanik/remotion-renderer:production
    container_name: remotion-renderer-prod
    restart: unless-stopped
    expose:
      - "3100"
    environment:
      - S3_ENDPOINT=${S3_ENDPOINT:-http://minio:9000}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-automecanik-renders}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_REGION=${S3_REGION:-eu-central-1}
      - RENDER_SERVICE_PORT=3100
      - CHROMIUM_PATH=/usr/bin/chromium
      # P7e: Max concurrent renders (1 = sequential, safe default)
      - VIDEO_MAX_CONCURRENT_RENDERS=1
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
    networks:
      - automecanik-prod
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  minio:
    image: minio/minio:latest
    container_name: minio-prod
    restart: unless-stopped
    command: server /data --console-address ":9001"
    expose:
      - "9000"
      - "9001"
    environment:
      - MINIO_ROOT_USER=${S3_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${S3_SECRET_KEY:-minioadmin}
    volumes:
      - /dev/volumes/minio/data:/data
    networks:
      - automecanik-prod
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis_prod:
    image: redis:7-alpine
    restart: always
    # SECURITY: Never expose Redis publicly - internal network only
    # ports:
    #   - '6379:6379'
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
    volumes: 
      - /dev/volumes/nestjs-remix/production/sessions/:/data
    networks:
      - automecanik-prod

networks:
  automecanik-prod:
    external: true
