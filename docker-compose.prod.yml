services:
  monorepo_prod:
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis_prod:6379
      - REDIS_HOST=redis_prod
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - NODE_ENV
      - DATABASE_URL
      - SUPABASE_SERVICE_ROLE_KEY
      - SUPABASE_URL
      - USE_UNIFIED_RPC=true


    container_name: nestjs-remix-monorepo-prod
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    image: massdoc/nestjs-remix-monorepo:production
    restart: always
    ports:
      - 3000:3000
    volumes:
      - ./public/sitemaps:/srv/sitemaps
    networks:
      - automecanik-prod

  redis_prod:
    image: redis:7-alpine
    restart: always
    # SECURITY: Never expose Redis publicly - internal network only
    # ports:
    #   - '6379:6379'
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes: 
      - /dev/volumes/nestjs-remix/production/sessions/:/data
    networks:
      - automecanik-prod

networks:
  automecanik-prod:
    external: true
