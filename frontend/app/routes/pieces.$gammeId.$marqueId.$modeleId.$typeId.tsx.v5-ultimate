// üèóÔ∏è Architecture Modulaire V5 Ultimate - Route Pi√®ces V√©hicule
import { type UnifiedPiece } from "@monorepo/shared-types";
import { json, type LoaderFunctionArgs, type MetaFunction } from "@remix-run/node";
import { useLoaderData } from "@remix-run/react";
import { useState, useMemo } from 'react';

// Services modulaires
import { unifiedCatalogApi } from "../services/api/unified-catalog.api";
import { getCrossSellingV5ByAlias, getAdvancedSeoV5, type CrossSellingV5Result, type AdvancedSeoV5Result } from "../services/api/v5-ultimate.api";

// Types modulaires V5
interface VehicleData {
  marque: string;
  modele: string;
  type: string;
  typeId: number;
  marqueId: number;
  modeleId: number;
}

interface GammeData {
  id: number;
  name: string;
  alias: string;
  description: string;
}

interface LoaderData {
  vehicle: VehicleData;
  gamme: GammeData;
  pieces: UnifiedPiece[];
  count: number;
  minPrice: number;
  maxPrice: number;
  
  // üÜï V5 Ultimate - Cross-selling et SEO avanc√©
  crossSelling?: CrossSellingV5Result;
  advancedSeo?: AdvancedSeoV5Result;
  
  seo: {
    title: string;
    h1: string;
    description: string;
  };
  performance: {
    loadTime: number;
    source: string;
    cacheHit: boolean;
  };
}

// Utilitaires modulaires
const toTitleCaseFromSlug = (slug: string): string => 
  slug.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

const parseUrlParam = (param: string): {alias: string, id: number} => {
  const parts = param.split('-');
  
  // Chercher le dernier nombre dans l'URL
  for (let i = parts.length - 1; i >= 0; i--) {
    const id = parseInt(parts[i]);
    if (!isNaN(id) && id > 0) {
      const alias = parts.slice(0, i).join('-');
      return { alias, id };
    }
  }
  
  // Fallback si pas d'ID trouv√©
  return { alias: param, id: 0 };
}

// Loader modulaire V5 Ultimate - Format IDs
export async function loader({ params }: LoaderFunctionArgs) {
  const startTime = Date.now();
  
  if (!params.gammeId || !params.marqueId || !params.modeleId || !params.typeId) {
    throw new Response("Param√®tres manquants", { status: 400 });
  }

  try {
    // üéØ Parsing param√®tres avec IDs (format: nom-ID)
    const gammeInfo = parseUrlParam(params.gammeId);
    const marqueInfo = parseUrlParam(params.marqueId); 
    const modeleInfo = parseUrlParam(params.modeleId);
    const typeInfo = parseUrlParam(params.typeId);

    // üîÑ R√©cup√©ration des donn√©es V5 Ultimate en parall√®le
    const [piecesResult, crossSellingResult, advancedSeoResult] = await Promise.allSettled([
      unifiedCatalogApi.getPiecesUnified(typeInfo.id, gammeInfo.id),
      getCrossSellingV5ByAlias(gammeInfo.alias, marqueInfo.alias, modeleInfo.alias, typeInfo.alias),
      getAdvancedSeoV5({
        typeId: typeInfo.id,
        pgId: gammeInfo.id,
        marque: marqueInfo.alias,
        modele: modeleInfo.alias,
        gamme: gammeInfo.alias,
      })
    ]);

    // Gestion des r√©sultats avec fallbacks
    const piecesData = piecesResult.status === 'fulfilled' ? piecesResult.value : { pieces: [], count: 0, minPrice: 0, maxPrice: 0 };
    const crossSellingData = crossSellingResult.status === 'fulfilled' ? crossSellingResult.value : undefined;
    const seoData = advancedSeoResult.status === 'fulfilled' ? advancedSeoResult.value : undefined;

    // Simpler vehicle data construction from params
    const vehicle = {
      marque: toTitleCaseFromSlug(marqueInfo.alias),
      modele: toTitleCaseFromSlug(modeleInfo.alias),
      type: toTitleCaseFromSlug(typeInfo.alias),
      typeId: typeInfo.id,
      marqueId: marqueInfo.id,
      modeleId: modeleInfo.id,
    };

    const loadTime = Date.now() - startTime;

    return json<LoaderData>({
      vehicle,
      gamme: {
        id: gammeInfo.id,
        name: toTitleCaseFromSlug(gammeInfo.alias),
        alias: gammeInfo.alias,
        description: `Pi√®ces ${gammeInfo.alias} de qualit√© pour votre v√©hicule`
      },
      pieces: piecesData.pieces || [],
      count: piecesData.count || 0,
      minPrice: piecesData.minPrice || 0,
      maxPrice: piecesData.maxPrice || 0,
      
      // üÜï V5 Ultimate - Nouvelles donn√©es int√©gr√©es
      crossSelling: crossSellingData,
      advancedSeo: seoData,
      
      seo: {
        title: `${toTitleCaseFromSlug(gammeInfo.alias)} ${vehicle.marque} ${vehicle.modele} ${vehicle.type} | Pi√®ces Auto`,
        h1: `${toTitleCaseFromSlug(gammeInfo.alias)} pour ${vehicle.marque} ${vehicle.modele} ${vehicle.type}`,
        description: `D√©couvrez nos ${toTitleCaseFromSlug(gammeInfo.alias)} pour ${vehicle.marque} ${vehicle.modele} ${vehicle.type}. ${piecesData.count} pi√®ces en stock, livraison rapide.`
      },
      performance: {
        loadTime,
        source: "unified-api-v5",
        cacheHit: (piecesData as any).success || false
      }
    });

  } catch (error) {
    console.error("Erreur loader V5:", error);
    throw new Response("Erreur interne", { status: 500 });
  }
}

// Composant principal modulaire V5
export default function UnifiedPiecesPageV5() {
  const data = useLoaderData<LoaderData>();

  // üéØ √âtats simplifi√©s pour architecture modulaire
  const [filters, setFilters] = useState({
    marque: '',
    search: '',
    sortBy: 'name',
    priceRange: 'all', // all, low, medium, high
    quality: 'all',    // all, OEM, aftermarket
    availability: 'all' // all, stock, preorder
  });

  const [viewMode, setViewMode] = useState<"grid" | "list" | "comparison">("grid");
  const [selectedPieces, setSelectedPieces] = useState<number[]>([]);

  // üîß Handler de filtres modulaire
  const handleFilterChange = (key: string, value: string) => {
    setFilters(prev => ({ ...prev, [key]: value }));
  };

  // üîÑ Filtrage des pi√®ces avec filtres avanc√©s V5+
  const filteredPieces = useMemo(() => {
    let result = [...data.pieces];
    
    // Filtre par recherche
    if (filters.search) {
      result = result.filter(piece => 
        piece.piece_name?.toLowerCase().includes(filters.search.toLowerCase()) ||
        piece.reference?.toLowerCase().includes(filters.search.toLowerCase())
      );
    }
    
    // Filtre par marque
    if (filters.marque) {
      result = result.filter(piece => piece.marque === filters.marque);
    }

    // üÜï Filtre par gamme de prix
    if (filters.priceRange !== 'all') {
      result = result.filter(piece => {
        const price = piece.prix_ttc || 0;
        switch (filters.priceRange) {
          case 'low': return price < 50;
          case 'medium': return price >= 50 && price < 150;
          case 'high': return price >= 150;
          default: return true;
        }
      });
    }

    // üÜï Filtre par qualit√©
    if (filters.quality !== 'all') {
      result = result.filter(piece => {
        const quality = piece.qualite?.toLowerCase() || '';
        switch (filters.quality) {
          case 'OEM': return quality.includes('oem') || quality.includes('origine');
          case 'aftermarket': return !quality.includes('oem') && !quality.includes('origine');
          default: return true;
        }
      });
    }

    // Tri am√©lior√©
    switch (filters.sortBy) {
      case 'price':
        result.sort((a, b) => (a.prix_ttc || 0) - (b.prix_ttc || 0));
        break;
      case 'price-desc':
        result.sort((a, b) => (b.prix_ttc || 0) - (a.prix_ttc || 0));
        break;
      case 'name':
      default:
        result.sort((a, b) => (a.piece_name || '').localeCompare(b.piece_name || ''));
        break;
    }
    
    return result;
  }, [data.pieces, filters]);

  // üÜï Marques disponibles
  const availableBrands = useMemo(() => {
    const brands = [...new Set(data.pieces.map(p => p.marque))];
    return brands.sort();
  }, [data.pieces]);

  // üÜï V5+ Statistiques avanc√©es
  const piecesStats = useMemo(() => {
    const prices = data.pieces.map(p => p.prix_ttc || 0).filter(p => p > 0);
    const avgPrice = prices.length > 0 ? prices.reduce((sum, price) => sum + price, 0) / prices.length : 0;
    
    return {
      total: data.pieces.length,
      filtered: filteredPieces.length,
      avgPrice: avgPrice,
      minPrice: Math.min(...prices) || 0,
      maxPrice: Math.max(...prices) || 0,
      brandsCount: availableBrands.length,
      priceRanges: {
        low: data.pieces.filter(p => (p.prix_ttc || 0) < 50).length,
        medium: data.pieces.filter(p => (p.prix_ttc || 0) >= 50 && (p.prix_ttc || 0) < 150).length,
        high: data.pieces.filter(p => (p.prix_ttc || 0) >= 150).length
      }
    };
  }, [data.pieces, filteredPieces, availableBrands]);

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-7xl mx-auto px-4 py-8">
        {/* üöó HEADER V√âHICULE */}
        <div className="bg-white rounded-xl shadow-sm p-6 mb-8">
          <nav className="text-sm text-gray-600 mb-4">
            <a href="/" className="hover:underline">Accueil</a> ‚Üí 
            <a href="/pieces" className="hover:underline ml-1">Pi√®ces</a> ‚Üí 
            <a href={`/pieces/${data.gamme.alias}`} className="text-blue-600 hover:underline ml-1">{data.gamme.name}</a> ‚Üí
            <span className="font-medium ml-1">{data.vehicle.marque} {data.vehicle.modele}</span>
          </nav>
          
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            {data.seo.h1}
            <span className="ml-3 px-3 py-1 bg-blue-100 text-blue-800 text-lg rounded-full font-medium">
              {data.count} pi√®ces
            </span>
          </h1>
          
          <div className="flex items-center justify-between">
            <p className="text-gray-600">
              {data.count} pi√®ces disponibles ‚Ä¢ Livraison rapide ‚Ä¢ Garantie constructeur
            </p>
            <div className="text-sm text-gray-500 flex items-center gap-2">
              <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                data.performance.loadTime < 3000 
                  ? 'bg-green-100 text-green-800' 
                  : data.performance.loadTime < 6000 
                  ? 'bg-yellow-100 text-yellow-800' 
                  : 'bg-red-100 text-red-800'
              }`}>
                ‚ö° {data.performance.loadTime}ms
              </span>
              <span className="text-gray-300">‚Ä¢</span>
              <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                data.performance.cacheHit 
                  ? 'bg-blue-100 text-blue-800' 
                  : 'bg-gray-100 text-gray-600'
              }`}>
                {data.performance.cacheHit ? 'üìÅ Cache' : 'üîÑ Live'}
              </span>
              <span className="text-gray-300">‚Ä¢</span>
              <span className="px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                üöÄ V5.2
              </span>
            </div>
          </div>
        </div>

        {/* üîß FILTRES ET CONTR√îLES AVANC√âS V5+ */}
        <div className="bg-white rounded-xl shadow-sm p-6 mb-8">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
            {/* Recherche */}
            <div className="lg:col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                üîç Recherche
              </label>
              <input
                type="text"
                value={filters.search}
                onChange={(e) => handleFilterChange('search', e.target.value)}
                placeholder="Nom ou r√©f√©rence..."
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>

            {/* Marque */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                üè∑Ô∏è Marque
              </label>
              <select
                value={filters.marque}
                onChange={(e) => handleFilterChange('marque', e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="">Toutes</option>
                {availableBrands.map(brand => (
                  <option key={brand} value={brand}>{brand}</option>
                ))}
              </select>
            </div>

            {/* üÜï Gamme de prix */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ÔøΩ Prix
              </label>
              <select
                value={filters.priceRange}
                onChange={(e) => handleFilterChange('priceRange', e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="all">Tous prix</option>
                <option value="low">&lt; 50‚Ç¨</option>
                <option value="medium">50-150‚Ç¨</option>
                <option value="high">&gt; 150‚Ç¨</option>
              </select>
            </div>

            {/* üÜï Qualit√© */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ‚≠ê Qualit√©
              </label>
              <select
                value={filters.quality}
                onChange={(e) => handleFilterChange('quality', e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="all">Toutes</option>
                <option value="OEM">OEM/Origine</option>
                <option value="aftermarket">Aftermarket</option>
              </select>
            </div>

            {/* Tri am√©lior√© */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ÔøΩ Tri
              </label>
              <select
                value={filters.sortBy}
                onChange={(e) => handleFilterChange('sortBy', e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="name">Nom A-Z</option>
                <option value="price">Prix ‚¨Ü</option>
                <option value="price-desc">Prix ‚¨á</option>
              </select>
            </div>
          </div>

          {/* Mode d'affichage - Ligne s√©par√©e */}
          <div className="mt-4 pt-4 border-t border-gray-200">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <span className="text-sm font-medium text-gray-700">üëÅÔ∏è Affichage :</span>
                <div className="flex gap-2">
                  <button 
                    onClick={() => setViewMode('grid')}
                    className={`px-3 py-1 text-sm rounded ${
                      viewMode === 'grid' 
                        ? 'bg-blue-100 text-blue-700 border-blue-300' 
                        : 'bg-gray-100 text-gray-700 border-gray-300'
                    } border`}
                  >
                    ‚äû Grille
                  </button>
                  <button 
                    onClick={() => setViewMode('list')}
                    className={`px-3 py-1 text-sm rounded ${
                      viewMode === 'list' 
                        ? 'bg-blue-100 text-blue-700 border-blue-300' 
                        : 'bg-gray-100 text-gray-700 border-gray-300'
                    } border`}
                  >
                    ‚ò∞ Liste
                  </button>
                </div>
              </div>
              
              {/* Bouton Reset filtres */}
              <button 
                onClick={() => setFilters({ marque: '', search: '', sortBy: 'name', priceRange: 'all', quality: 'all', availability: 'all' })}
                className="text-sm text-gray-600 hover:text-red-600 hover:underline"
              >
                üóëÔ∏è R√©initialiser filtres
              </button>
            </div>
          </div>

          {/* Statistiques */}
          <div className="mt-4 pt-4 border-t border-gray-200">
            <div className="flex items-center justify-between">
              <span className="text-sm text-gray-600">
                üî¢ {filteredPieces.length} pi√®ce(s) trouv√©e(s)
              </span>
              {selectedPieces.length > 0 && (
                <div className="flex items-center gap-4">
                  <span className="text-sm text-blue-600">
                    ‚úì {selectedPieces.length} s√©lectionn√©e(s)
                  </span>
                  <button 
                    onClick={() => setSelectedPieces([])}
                    className="text-sm text-red-600 hover:underline"
                  >
                    Effacer s√©lection
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* üìä PANNEAU STATISTIQUES AVANC√âES V5+ */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          {/* R√©sum√© global */}
          <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border border-blue-200">
            <div className="flex items-center justify-between mb-2">
              <span className="text-blue-700 font-medium">üì¶ Pi√®ces</span>
              <span className="text-2xl">üîß</span>
            </div>
            <div className="text-2xl font-bold text-blue-900">{piecesStats.filtered}</div>
            <div className="text-sm text-blue-600">sur {piecesStats.total} total</div>
          </div>

          {/* Prix moyen */}
          <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border border-green-200">
            <div className="flex items-center justify-between mb-2">
              <span className="text-green-700 font-medium">üí∞ Prix moyen</span>
              <span className="text-2xl">üìà</span>
            </div>
            <div className="text-2xl font-bold text-green-900">{piecesStats.avgPrice.toFixed(0)}‚Ç¨</div>
            <div className="text-sm text-green-600">{piecesStats.minPrice}‚Ç¨ - {piecesStats.maxPrice}‚Ç¨</div>
          </div>

          {/* Marques disponibles */}
          <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 border border-purple-200">
            <div className="flex items-center justify-between mb-2">
              <span className="text-purple-700 font-medium">üè∑Ô∏è Marques</span>
              <span className="text-2xl">üè≠</span>
            </div>
            <div className="text-2xl font-bold text-purple-900">{piecesStats.brandsCount}</div>
            <div className="text-sm text-purple-600">marques disponibles</div>
          </div>

          {/* R√©partition prix */}
          <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-4 border border-orange-200">
            <div className="flex items-center justify-between mb-2">
              <span className="text-orange-700 font-medium">üìä R√©partition</span>
              <span className="text-2xl">üíé</span>
            </div>
            <div className="space-y-1 text-sm">
              <div className="flex justify-between text-orange-900">
                <span>&lt; 50‚Ç¨:</span> <span className="font-semibold">{piecesStats.priceRanges.low}</span>
              </div>
              <div className="flex justify-between text-orange-900">
                <span>50-150‚Ç¨:</span> <span className="font-semibold">{piecesStats.priceRanges.medium}</span>
              </div>
              <div className="flex justify-between text-orange-900">
                <span>&gt; 150‚Ç¨:</span> <span className="font-semibold">{piecesStats.priceRanges.high}</span>
              </div>
            </div>
          </div>
        </div>

        {/* üõçÔ∏è LISTE DES PI√àCES */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          {filteredPieces.length === 0 ? (
            <div className="text-center py-12">
              <div className="text-gray-400 text-6xl mb-4">üîç</div>
              <h3 className="text-lg font-medium text-gray-900 mb-2">
                Aucune pi√®ce trouv√©e
              </h3>
              <p className="text-gray-600">
                Modifiez vos crit√®res de recherche pour voir plus de r√©sultats.
              </p>
            </div>
          ) : (
            <div className={viewMode === 'grid' 
              ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' 
              : 'space-y-4'
            }>
              {filteredPieces.map((piece) => (
                <div 
                  key={piece.id} 
                  className={`border rounded-lg p-4 hover:shadow-md transition-shadow ${
                    selectedPieces.includes(piece.id) 
                      ? 'border-blue-500 bg-blue-50' 
                      : 'border-gray-200 bg-white'
                  }`}
                >
                  <div className="flex items-start justify-between mb-2">
                    <h3 className="font-semibold text-gray-900 text-sm">
                      {piece.piece_name}
                    </h3>
                    <input
                      type="checkbox"
                      checked={selectedPieces.includes(piece.id)}
                      onChange={() => {
                        setSelectedPieces(prev => 
                          prev.includes(piece.id)
                            ? prev.filter(id => id !== piece.id)
                            : [...prev, piece.id]
                        );
                      }}
                      className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                    />
                  </div>
                  
                  <div className="space-y-1 text-sm text-gray-600">
                    <p><span className="font-medium">Marque:</span> {piece.marque}</p>
                    <p><span className="font-medium">R√©f√©rence:</span> {piece.reference}</p>
                    <p><span className="font-medium">Stock:</span> 
                      <span className="ml-1 px-2 py-0.5 rounded text-xs bg-green-100 text-green-800">
                        En stock
                      </span>
                    </p>
                    {piece.qualite && (
                      <p><span className="font-medium">Qualit√©:</span> 
                        <span className="ml-1 px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">
                          {piece.qualite}
                        </span>
                      </p>
                    )}
                  </div>

                  <div className="flex items-center justify-between mt-4">
                    <div className="font-bold text-lg text-blue-600">
                      {`${piece.prix_ttc.toFixed(2)}‚Ç¨`}
                    </div>
                    <button className="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition-colors">
                      üõí Ajouter
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* üìä R√âSUM√â S√âLECTION */}
        {selectedPieces.length > 0 && (
          <div className="bg-blue-50 border border-blue-200 rounded-xl p-6 mt-8">
            <h3 className="font-semibold text-blue-900 mb-4">
              üõí R√©sum√© de votre s√©lection ({selectedPieces.length} pi√®ces)
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {selectedPieces.slice(0, 3).map(pieceId => {
                const piece = data.pieces.find(p => p.id === pieceId);
                if (!piece) return null;
                return (
                  <div key={piece.id} className="bg-white rounded p-3">
                    <div className="font-medium text-sm">{piece.piece_name}</div>
                    <div className="text-xs text-gray-600">{piece.marque}</div>
                    <div className="font-semibold text-blue-600 mt-1">
                      {`${piece.prix_ttc.toFixed(2)}‚Ç¨`}
                    </div>
                  </div>
                );
              })}
              {selectedPieces.length > 3 && (
                <div className="bg-white rounded p-3 flex items-center justify-center text-gray-500">
                  +{selectedPieces.length - 3} autres...
                </div>
              )}
            </div>
            <div className="flex items-center justify-between mt-4">
              <div className="font-semibold text-blue-900">
                Total: {selectedPieces.reduce((sum, pieceId) => {
                  const piece = data.pieces.find(p => p.id === pieceId);
                  return sum + (piece?.prix_ttc || 0);
                }, 0).toFixed(2)}‚Ç¨
              </div>
              <button className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition-colors">
                Valider la s√©lection
              </button>
            </div>
          </div>
        )}

        {/* üÜï SECTION CROSS-SELLING V5 ULTIMATE */}
        {data.crossSelling?.success && data.crossSelling.recommendations.length > 0 && (
          <div className="bg-white rounded-xl shadow-sm p-6 mt-8">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-900">
                üîß Pi√®ces compl√©mentaires recommand√©es
              </h2>
              <div className="text-sm text-gray-500">
                {data.crossSelling.metadata.total_found} recommandations
              </div>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {data.crossSelling.recommendations.slice(0, 6).map((recommendation) => (
                <div key={recommendation.pg_id} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                  <div className="flex items-start justify-between mb-3">
                    <div className="flex-1">
                      <h3 className="font-semibold text-gray-900 text-sm mb-1">
                        {recommendation.pg_name}
                      </h3>
                      <div className="flex items-center gap-2">
                        <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                          recommendation.source === 'family' 
                            ? 'bg-blue-100 text-blue-800'
                            : recommendation.source === 'compatibility'
                            ? 'bg-green-100 text-green-800'
                            : 'bg-purple-100 text-purple-800'
                        }`}>
                          {recommendation.source === 'family' ? 'üë• Famille' : 
                           recommendation.source === 'compatibility' ? 'üîß Compatible' : '‚öôÔ∏è Config'}
                        </span>
                        {recommendation.compatibility_score && (
                          <span className="text-xs text-gray-500">
                            {Math.round(recommendation.compatibility_score * 100)}% compatible
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                  
                  <div className="text-sm text-gray-600 mb-3">
                    {recommendation.products_count && (
                      <span>üì¶ {recommendation.products_count} pi√®ces disponibles</span>
                    )}
                  </div>
                  
                  <a
                    href={`/pieces/${recommendation.pg_alias}/${data.vehicle.marque.toLowerCase()}-${data.vehicle.marqueId}/${data.vehicle.modele.toLowerCase()}-${data.vehicle.modeleId}/${data.vehicle.type.toLowerCase()}-${data.vehicle.typeId}`}
                    className="w-full bg-blue-50 text-blue-700 px-4 py-2 rounded text-sm hover:bg-blue-100 transition-colors block text-center"
                  >
                    Voir les pi√®ces
                  </a>
                </div>
              ))}
            </div>
            
            <div className="mt-4 text-center">
              <div className="text-xs text-gray-500">
                ‚ö° Recommandations g√©n√©r√©es en {data.crossSelling.metadata.response_time}ms
                {data.crossSelling.metadata.cache_hit && ' (üìÅ Cache)'}
              </div>
            </div>
          </div>
        )}

        {/* üÜï SECTION FAQ ET CONTENU ENRICHI V5 */}
        {data.advancedSeo?.success && data.advancedSeo.content.faq.length > 0 && (
          <div className="bg-white rounded-xl shadow-sm p-6 mt-8">
            <h2 className="text-2xl font-bold text-gray-900 mb-6">
              ‚ùì Questions fr√©quentes
            </h2>
            
            <div className="space-y-4">
              {data.advancedSeo.content.faq.map((faqItem) => (
                <details key={faqItem.id} className="group border-b border-gray-200 pb-4">
                  <summary className="cursor-pointer font-medium text-gray-900 hover:text-blue-600 transition-colors">
                    <span className="mr-2">üìã</span>
                    {faqItem.question}
                  </summary>
                  <div className="mt-3 ml-6 text-gray-700 text-sm">
                    {faqItem.answer}
                  </div>
                </details>
              ))}
            </div>
            
            <div className="mt-6 text-center">
              <div className="text-xs text-gray-500">
                üéØ Score SEO : {data.advancedSeo.performance.seo_score}/100 
                ‚Ä¢ ‚ö° {data.advancedSeo.performance.response_time}ms
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// Meta modulaire V5
export const meta: MetaFunction<typeof loader> = ({ data }) => {
  if (!data) {
    return [
      { title: "Pi√®ces non trouv√©es" },
      { name: "description", content: "Les pi√®ces demand√©es n'ont pas √©t√© trouv√©es." }
    ];
  }

  return [
    { title: data.seo.title },
    { name: "description", content: data.seo.description },
    { name: "keywords", content: `${data.gamme.name}, ${data.vehicle.marque}, ${data.vehicle.modele}, pi√®ces auto, automobile` },
    { property: "og:title", content: data.seo.title },
    { property: "og:description", content: data.seo.description },
    { property: "og:type", content: "website" }
  ];
};