openapi: 3.0.3
info:
  title: Payment API
  version: 1.0.0
  description: |
    API de gestion des paiements pour la plateforme e-commerce.
    
    ## üéØ Fonctionnalit√©s principales
    
    - **Cr√©ation de paiements** : Initialisation avec Cyberplus ou Paybox
    - **Gestion du cycle de vie** : Suivi du statut (PENDING ‚Üí SUCCESS/FAILED)
    - **Callbacks bancaires** : Webhooks IPN pour notifications asynchrones
    - **Remboursements** : Gestion des remboursements totaux/partiels (admin)
    - **Statistiques** : Analyse des paiements par p√©riode/statut (admin)
    - **Audit complet** : Logs transactions et callbacks dans `ic_postback`
    
    ## üîê S√©curit√©
    
    - **Authentification** : JWT Bearer token (15min access + 7 days refresh)
    - **Autorisations** : 
      - Client : Ses propres paiements uniquement
      - Admin (role ‚â• 9) : Tous les paiements + remboursements
    - **Callbacks** : Validation HMAC signature pour Cyberplus/Paybox
    
    ## üí≥ M√©thodes de paiement
    
    - **CYBERPLUS** : BNP Paribas (production)
    - **PAYBOX** : Verifone (production)
    - **CREDIT_CARD** : Cartes bancaires (Visa, Mastercard, Amex)
    - **PAYPAL** : D√©sactiv√© (int√©gration future)
    - **BANK_TRANSFER** : D√©sactiv√© (virement SEPA)
    
    ## üìä Volum√©trie
    
    - **Commandes** : 1,440 commandes
    - **CA total** : ‚Ç¨51,509
    - **Panier moyen** : ‚Ç¨35.77
    - **Temps de r√©ponse** : < 300ms (p95)
    
    ## üîó Liens utiles
    
    - [Spec compl√®te Payment & Cart](/spec/features/payment-cart-system.md)
    - [Types Zod](/spec/types/payment.schema.md)
    - [ADR Supabase](/spec/architecture/001-supabase-direct.md)

  contact:
    name: API Support
    email: dev@example.com

servers:
  - url: http://localhost:3000
    description: D√©veloppement local
  - url: https://api.production.com
    description: Production

tags:
  - name: payments
    description: Op√©rations client (cr√©ation, consultation, annulation)
  - name: admin
    description: Op√©rations administrateur (liste, stats, remboursements)
  - name: callbacks
    description: Webhooks bancaires (IPN Cyberplus, Paybox)
  - name: utilities
    description: M√©thodes disponibles, transactions

security:
  - BearerAuth: []

paths:
  /api/payments:
    post:
      tags:
        - payments
      summary: Cr√©er un nouveau paiement
      description: |
        Initialise un paiement pour une commande. G√©n√®re automatiquement le formulaire
        de redirection vers la passerelle bancaire (Cyberplus ou Paybox).
        
        **Flux :**
        1. Validation du montant (min ‚Ç¨0.50, max ‚Ç¨10,000)
        2. Cr√©ation de l'enregistrement paiement (statut `PENDING`)
        3. G√©n√©ration du formulaire bancaire avec signature HMAC
        4. Retour des donn√©es de redirection (URL + param√®tres)
        
        **M√©thodes support√©es :**
        - `CYBERPLUS` : BNP Paribas Mercanet
        - `PAYBOX` : Verifone Paybox System
        
        **S√©curit√© :**
        - Authentification JWT requise
        - userId extrait du token
        - HMAC signature g√©n√©r√©e c√¥t√© serveur
      operationId: createPayment
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentDto'
            examples:
              cyberplusPayment:
                summary: Paiement Cyberplus
                value:
                  orderId: "12345"
                  amount: 99.99
                  currency: "EUR"
                  method: "CYBERPLUS"
                  customerEmail: "client@example.com"
                  description: "Commande #12345 - 3 articles"
                  returnUrl: "https://app.com/payment/success"
                  cancelUrl: "https://app.com/payment/cancel"
                  notifyUrl: "https://api.app.com/api/payments/callback/cyberplus"
              payboxPayment:
                summary: Paiement Paybox
                value:
                  orderId: "12346"
                  amount: 149.50
                  currency: "EUR"
                  method: "PAYBOX"
                  customerEmail: "client@example.com"
                  returnUrl: "https://app.com/payment/success"
      responses:
        '201':
          description: Paiement cr√©√© avec succ√®s
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResponse'
              examples:
                success:
                  value:
                    success: true
                    data:
                      id: "pay_1234567890"
                      paymentReference: "PAY_1696502400_ABC123"
                      status: "PENDING"
                      amount: 99.99
                      currency: "EUR"
                      method: "CYBERPLUS"
                      orderId: "12345"
                      userId: "usr_123"
                      redirectData:
                        url: "https://secure-paypage.lyra.com/vads-payment/"
                        method: "POST"
                        parameters:
                          vads_action_mode: "INTERACTIVE"
                          vads_amount: "9999"
                          vads_ctx_mode: "PRODUCTION"
                          vads_currency: "978"
                          vads_order_id: "12345"
                          vads_payment_config: "SINGLE"
                          vads_site_id: "12345678"
                          vads_trans_date: "20231005120000"
                          vads_trans_id: "123456"
                          vads_version: "V2"
                          signature: "abc123def456..."
                    message: "Paiement cr√©√© avec succ√®s"
        '400':
          description: Donn√©es invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidAmount:
                  value:
                    success: false
                    error: "Amount must be between ‚Ç¨0.50 and ‚Ç¨10,000"
                missingOrder:
                  value:
                    success: false
                    error: "Order ID is required"
        '401':
          description: Non authentifi√©
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Unauthorized - JWT token required"
    
    get:
      tags:
        - admin
      summary: Liste tous les paiements (admin)
      description: |
        R√©cup√®re la liste compl√®te des paiements (tous utilisateurs).
        
        **Restrictions :**
        - R√©serv√© aux administrateurs (role ‚â• 9)
        - Pagination recommand√©e pour volum√©trie √©lev√©e
        
        **Note :** Endpoint en cours d'impl√©mentation.
      operationId: listAllPayments
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Liste des paiements
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Payment'
                  message:
                    type: string
              example:
                success: true
                data: []
                message: "Method to be implemented: findAllPayments"
        '403':
          description: Acc√®s refus√© (non admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/payments/stats:
    get:
      tags:
        - admin
      summary: Statistiques des paiements (admin)
      description: |
        Analyse globale des paiements avec filtres par statut et p√©riode.
        
        **M√©triques calcul√©es :**
        - Total paiements par statut (SUCCESS, PENDING, FAILED, REFUNDED)
        - Montant total encaiss√©
        - Montant moyen par transaction
        - Taux de succ√®s/√©chec
        - √âvolution temporelle
        
        **Filtres disponibles :**
        - `status` : SUCCESS, PENDING, FAILED, REFUNDED
        - `startDate` / `endDate` : ISO 8601 format
      operationId: getPaymentStats
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [PENDING, SUCCESS, FAILED, REFUNDED, CANCELLED]
          description: Filtrer par statut
        - name: startDate
          in: query
          schema:
            type: string
            format: date-time
          description: Date de d√©but (ISO 8601)
          example: "2024-01-01T00:00:00Z"
        - name: endDate
          in: query
          schema:
            type: string
            format: date-time
          description: Date de fin (ISO 8601)
          example: "2024-12-31T23:59:59Z"
      responses:
        '200':
          description: Statistiques calcul√©es
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      totalCount:
                        type: integer
                      successCount:
                        type: integer
                      failedCount:
                        type: integer
                      refundedCount:
                        type: integer
                      totalAmount:
                        type: number
                        format: float
                      averageAmount:
                        type: number
                        format: float
                      successRate:
                        type: number
                        format: float
                        description: Taux de succ√®s (0-1)
              example:
                success: true
                data:
                  totalCount: 1440
                  successCount: 1380
                  failedCount: 45
                  refundedCount: 15
                  totalAmount: 51509.00
                  averageAmount: 35.77
                  successRate: 0.958

  /api/payments/stats/global:
    get:
      tags:
        - admin
      summary: Alias pour /stats (compatibilit√©)
      description: Identique √† `GET /api/payments/stats`
      operationId: getGlobalStats
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [PENDING, SUCCESS, FAILED, REFUNDED, CANCELLED]
        - name: startDate
          in: query
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Statistiques globales
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object

  /api/payments/{id}:
    get:
      tags:
        - payments
      summary: Obtenir les d√©tails d'un paiement
      description: |
        R√©cup√®re les informations compl√®tes d'un paiement par son ID.
        
        **R√®gles d'acc√®s :**
        - Client : Uniquement ses propres paiements
        - Admin : Tous les paiements
        
        **V√©rification propri√©t√© :**
        - Compare `payment.userId` avec `req.user.id` du JWT
      operationId: getPayment
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID du paiement
          example: "pay_1234567890"
      responses:
        '200':
          description: D√©tails du paiement
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Payment'
        '404':
          description: Paiement non trouv√©
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Acc√®s non autoris√© (pas propri√©taire)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/payments/user/{userId}:
    get:
      tags:
        - payments
      summary: Liste des paiements d'un utilisateur
      description: |
        R√©cup√®re l'historique des paiements d'un utilisateur sp√©cifique.
        
        **R√®gles d'acc√®s :**
        - Client : Uniquement ses propres paiements (`userId === req.user.id`)
        - Admin : Tous les utilisateurs
        
        **Pagination :**
        - Par d√©faut : 20 derniers paiements
        - Maximum recommand√© : 100
      operationId: getUserPayments
      security:
        - BearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          description: ID de l'utilisateur
          example: "usr_123"
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
          description: Nombre de r√©sultats
      responses:
        '200':
          description: Liste des paiements
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Payment'
                  count:
                    type: integer
              example:
                success: true
                count: 5
                data:
                  - id: "pay_001"
                    status: "SUCCESS"
                    amount: 99.99
                    orderId: "12345"
                  - id: "pay_002"
                    status: "PENDING"
                    amount: 149.50
                    orderId: "12346"

  /api/payments/order/{orderId}:
    get:
      tags:
        - payments
      summary: Paiements associ√©s √† une commande
      description: |
        R√©cup√®re le(s) paiement(s) li√©s √† une commande sp√©cifique.
        
        **Cas d'usage :**
        - V√©rifier le statut de paiement d'une commande
        - G√©rer les compl√©ments de paiement (ORD_PARENT != 0)
        - Historique des tentatives de paiement
      operationId: getOrderPayments
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
          description: ID de la commande
          example: "12345"
      responses:
        '200':
          description: Paiement(s) de la commande
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Payment'

  /api/payments/reference/{reference}:
    get:
      tags:
        - payments
      summary: Paiement par r√©f√©rence
      description: |
        R√©cup√®re un paiement par sa r√©f√©rence unique (g√©n√©r√©e c√¥t√© serveur).
        
        **Format r√©f√©rence :** `PAY_{timestamp}_{random}`
        
        **Exemple :** `PAY_1696502400_ABC123`
      operationId: getPaymentByReference
      parameters:
        - name: reference
          in: path
          required: true
          schema:
            type: string
          description: R√©f√©rence du paiement
          example: "PAY_1696502400_ABC123"
      responses:
        '200':
          description: D√©tails du paiement
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Payment'
        '404':
          description: Paiement introuvable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/payments/{id}/status:
    patch:
      tags:
        - admin
      summary: Mettre √† jour le statut d'un paiement
      description: |
        Modification manuelle du statut d'un paiement (admin uniquement).
        
        **Transitions autoris√©es :**
        - PENDING ‚Üí SUCCESS | FAILED | CANCELLED
        - FAILED ‚Üí PENDING (retry)
        - SUCCESS ‚Üí REFUNDED (via endpoint `/refund`)
        
        **Audit :**
        - Changement de statut enregistr√© dans logs
        - Notification email si besoin
      operationId: updatePaymentStatus
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID du paiement
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [PENDING, SUCCESS, FAILED, REFUNDED, CANCELLED]
                providerTransactionId:
                  type: string
                  description: ID transaction bancaire (optionnel)
            example:
              status: "SUCCESS"
              providerTransactionId: "TXN_987654321"
      responses:
        '200':
          description: Statut mis √† jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Payment'
        '404':
          description: Paiement introuvable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/payments/{id}/cancel:
    post:
      tags:
        - payments
      summary: Annuler un paiement en attente
      description: |
        Annule un paiement en statut `PENDING`.
        
        **R√®gles :**
        - Seuls les paiements PENDING peuvent √™tre annul√©s
        - Le propri√©taire ou admin peut annuler
        - Transition : PENDING ‚Üí CANCELLED
        
        **Impact :**
        - Aucune action bancaire (paiement non valid√©)
        - Commande reste en attente de paiement
      operationId: cancelPayment
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID du paiement
      responses:
        '200':
          description: Paiement annul√©
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Payment'
                  message:
                    type: string
              example:
                success: true
                data:
                  id: "pay_123"
                  status: "CANCELLED"
                message: "Paiement annul√© avec succ√®s"
        '400':
          description: Paiement non annulable (d√©j√† SUCCESS/FAILED)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Non autoris√© (pas propri√©taire)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/payments/{id}/refund:
    post:
      tags:
        - admin
      summary: Rembourser un paiement (admin)
      description: |
        Effectue un remboursement total ou partiel sur un paiement SUCCESS.
        
        **R√®gles de validation :**
        - Paiement doit √™tre en statut SUCCESS
        - Montant ‚â§ montant original
        - D√©lai remboursement : 7-14 jours bancaires
        
        **Types de remboursement :**
        - **Total** : Omit `amount` ou √©gal au montant original
        - **Partiel** : Sp√©cifier `amount` < montant original
        
        **Audit :**
        - Enregistrement dans `ic_refunds`
        - Email client automatique
        - Log admin avec raison
      operationId: refundPayment
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID du paiement
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                amount:
                  type: number
                  format: float
                  description: Montant √† rembourser (optionnel = total)
                  minimum: 0.01
                reason:
                  type: string
                  description: Raison du remboursement
                  maxLength: 255
            examples:
              totalRefund:
                summary: Remboursement total
                value:
                  reason: "Article d√©fectueux"
              partialRefund:
                summary: Remboursement partiel
                value:
                  amount: 50.00
                  reason: "Compensation service client"
      responses:
        '200':
          description: Remboursement effectu√©
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Payment'
                  message:
                    type: string
              example:
                success: true
                data:
                  id: "pay_123"
                  status: "REFUNDED"
                  amount: 99.99
                  refundedAmount: 99.99
                message: "Remboursement effectu√© avec succ√®s"
        '400':
          description: Remboursement impossible
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                alreadyRefunded:
                  value:
                    success: false
                    error: "Payment already refunded"
                invalidAmount:
                  value:
                    success: false
                    error: "Refund amount exceeds original payment"

  /api/payments/callback/cyberplus:
    post:
      tags:
        - callbacks
      summary: Callback Cyberplus pour notifications de paiement
      description: |
        Webhook IPN (Instant Payment Notification) appel√© par Cyberplus/BNP Paribas.
        
        **Flux de traitement :**
        1. R√©ception du callback POST de Cyberplus
        2. Enregistrement dans `ic_postback` (audit complet)
        3. Validation de la signature HMAC-SHA256
        4. Mise √† jour du statut du paiement
        5. Notification commande si SUCCESS
        6. Retour 200 OK (obligatoire pour Cyberplus)
        
        **S√©curit√© :**
        - Signature HMAC-SHA256 obligatoire
        - IP whitelisting recommand√©
        - Idempotence g√©r√©e (replay protection)
        
        **Codes statut Cyberplus :**
        - `00` : SUCCESS
        - `05` : Refus√©
        - `30` : Fraude d√©tect√©e
        - Voir `.spec/types/payment.schema.md` pour liste compl√®te
        
        **Note :** Endpoint public mais s√©curis√© par signature.
      operationId: handleCyberplusCallback
      security: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - transaction_id
                - order_id
                - status
                - amount
                - signature
              properties:
                transaction_id:
                  type: string
                  description: ID transaction Cyberplus
                order_id:
                  type: string
                  description: ID commande (notre r√©f√©rence)
                status:
                  type: string
                  description: Code statut Cyberplus
                amount:
                  type: string
                  description: Montant en centimes
                signature:
                  type: string
                  description: Signature HMAC-SHA256
                currency:
                  type: string
                  description: Code devise ISO (978 = EUR)
                payment_method:
                  type: string
                  description: M√©thode utilis√©e (CB, VISA, MASTERCARD)
            example:
              transaction_id: "TXN_987654321"
              order_id: "12345"
              status: "00"
              amount: "9999"
              signature: "abc123def456..."
              currency: "978"
              payment_method: "CB"
      responses:
        '200':
          description: Callback trait√© avec succ√®s
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  paymentId:
                    type: string
              example:
                success: true
                message: "Callback processed successfully"
                paymentId: "pay_1234567890"
        '400':
          description: Signature invalide ou donn√©es manquantes
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  paymentId:
                    type: string
              example:
                success: false
                message: "Invalid signature"
                paymentId: "12345"

  /api/payments/callback/success:
    post:
      tags:
        - callbacks
      summary: Page de retour apr√®s paiement r√©ussi
      description: |
        URL de retour appel√©e par la passerelle bancaire apr√®s paiement r√©ussi.
        
        **Flux :**
        1. Client redirig√© par Cyberplus/Paybox apr√®s paiement
        2. Param√®tres GET/POST re√ßus
        3. R√©cup√©ration du paiement par orderId
        4. Affichage confirmation client
        
        **Note :** Ceci est le retour client, le callback IPN reste la source de v√©rit√©.
      operationId: handleSuccessReturn
      security: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                order_id:
                  type: string
                orderid:
                  type: string
            example:
              order_id: "12345"
      responses:
        '200':
          description: Paiement valid√©
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      paymentId:
                        type: string
                      status:
                        type: string
                      amount:
                        type: number
                      orderId:
                        type: string
                  message:
                    type: string
              example:
                success: true
                data:
                  paymentId: "pay_123"
                  status: "SUCCESS"
                  amount: 99.99
                  orderId: "12345"
                message: "Payment completed successfully"

  /api/payments/callback/error:
    post:
      tags:
        - callbacks
      summary: Page de retour apr√®s erreur de paiement
      description: |
        URL de retour appel√©e par la passerelle bancaire en cas d'erreur.
        
        **Actions :**
        - Mise √† jour statut : PENDING ‚Üí FAILED
        - Log de l'erreur
        - Redirection client vers page erreur
      operationId: handleErrorReturn
      security: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                order_id:
                  type: string
                error:
                  type: string
                error_message:
                  type: string
            example:
              order_id: "12345"
              error: "05"
              error_message: "Carte refus√©e"
      responses:
        '200':
          description: Erreur enregistr√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  error:
                    type: string
              example:
                success: false
                message: "Payment failed"
                error: "Carte refus√©e"

  /api/payments/methods/available:
    get:
      tags:
        - utilities
      summary: Liste des m√©thodes de paiement disponibles
      description: |
        Retourne les m√©thodes de paiement actives et configur√©es.
        
        **Statuts :**
        - `enabled: true` : M√©thode active en production
        - `enabled: false` : M√©thode d√©sactiv√©e (future int√©gration)
      operationId: getAvailablePaymentMethods
      responses:
        '200':
          description: M√©thodes disponibles
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        enabled:
                          type: boolean
                        description:
                          type: string
                        logo:
                          type: string
                  allMethods:
                    type: array
                    items:
                      type: object
              example:
                success: true
                data:
                  - id: "CYBERPLUS"
                    name: "Cyberplus (BNP Paribas)"
                    enabled: true
                    description: "Paiement s√©curis√© par carte bancaire"
                    logo: "/assets/cyberplus-logo.png"
                  - id: "CREDIT_CARD"
                    name: "Carte de cr√©dit"
                    enabled: true
                    description: "Visa, Mastercard, American Express"
                    logo: "/assets/credit-card-logo.png"
                allMethods:
                  - id: "PAYPAL"
                    name: "PayPal"
                    enabled: false

  /api/payments/{id}/transactions:
    get:
      tags:
        - utilities
      summary: Historique des transactions d'un paiement
      description: |
        Liste chronologique de toutes les transactions li√©es √† un paiement.
        
        **Inclut :**
        - Tentatives de paiement
        - Callbacks re√ßus
        - Remboursements effectu√©s
        - Changements de statut
        
        **Source :** Table `ic_postback` + logs internes
      operationId: getPaymentTransactions
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID du paiement
      responses:
        '200':
          description: Liste des transactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        timestamp:
                          type: string
                          format: date-time
                        type:
                          type: string
                        status:
                          type: string
                        amount:
                          type: number
                        metadata:
                          type: object
                  count:
                    type: integer
              example:
                success: true
                count: 3
                data:
                  - id: "txn_001"
                    timestamp: "2024-11-14T10:00:00Z"
                    type: "PAYMENT_CREATED"
                    status: "PENDING"
                    amount: 99.99
                  - id: "txn_002"
                    timestamp: "2024-11-14T10:05:00Z"
                    type: "CALLBACK_RECEIVED"
                    status: "SUCCESS"
                    amount: 99.99
                  - id: "txn_003"
                    timestamp: "2024-11-15T14:30:00Z"
                    type: "REFUND_PROCESSED"
                    status: "REFUNDED"
                    amount: 99.99

  /api/payments/proceed-supplement:
    post:
      tags:
        - payments
      summary: Initialiser le paiement d'un suppl√©ment de commande
      description: |
        G√©n√®re le formulaire de paiement pour un compl√©ment de commande (ORD_PARENT != 0).
        
        **Cas d'usage :**
        - Ajout d'articles apr√®s commande initiale
        - Suppl√©ment frais de port modifi√©s
        - Consignes suppl√©mentaires
        
        **Validations :**
        - Commande doit avoir `ORD_PARENT != 0`
        - Commande non d√©j√† pay√©e (`ORD_IS_PAY = 0`)
        - Utilisateur doit √™tre propri√©taire de la commande
      operationId: proceedSupplementPayment
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - orderId
                - paymentMethod
              properties:
                orderId:
                  type: string
                  description: ID de la commande suppl√©ment
                paymentMethod:
                  type: string
                  enum: [PAYBOX, PAYPAL]
                  description: M√©thode de paiement
            example:
              orderId: "12347"
              paymentMethod: "PAYBOX"
      responses:
        '200':
          description: Redirection vers passerelle de paiement
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      redirectData:
                        type: object
        '400':
          description: Commande invalide ou d√©j√† pay√©e
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notSupplement:
                  value:
                    success: false
                    error: "This is not a supplement order"
                alreadyPaid:
                  value:
                    success: false
                    error: "Order already paid"
        '403':
          description: Acc√®s non autoris√©
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token obtenu via `/api/auth/login`.
        
        **Format :** `Authorization: Bearer <token>`
        
        **Dur√©e de vie :**
        - Access token : 15 minutes
        - Refresh token : 7 jours

  schemas:
    CreatePaymentDto:
      type: object
      required:
        - orderId
        - amount
        - currency
        - method
      properties:
        orderId:
          type: string
          description: ID de la commande √† payer
          example: "12345"
        userId:
          type: string
          description: ID utilisateur (optionnel si extrait du JWT)
          example: "usr_123"
        amount:
          type: number
          format: float
          minimum: 0.5
          maximum: 10000
          description: Montant en EUR (min ‚Ç¨0.50, max ‚Ç¨10,000)
          example: 99.99
        currency:
          type: string
          enum: [EUR, USD, GBP]
          default: EUR
          description: Devise ISO 4217
        method:
          type: string
          enum: [CYBERPLUS, PAYBOX, CREDIT_CARD, DEBIT_CARD, PAYPAL, BANK_TRANSFER]
          description: M√©thode de paiement
          example: CYBERPLUS
        customerEmail:
          type: string
          format: email
          description: Email client (pour notifications)
          example: "client@example.com"
        description:
          type: string
          maxLength: 255
          description: Description du paiement
          example: "Commande #12345 - 3 articles"
        returnUrl:
          type: string
          format: uri
          description: URL de retour apr√®s paiement r√©ussi
          example: "https://app.com/payment/success"
        cancelUrl:
          type: string
          format: uri
          description: URL de retour en cas d'annulation
          example: "https://app.com/payment/cancel"
        notifyUrl:
          type: string
          format: uri
          description: URL webhook IPN (callback asynchrone)
          example: "https://api.app.com/api/payments/callback/cyberplus"

    Payment:
      type: object
      properties:
        id:
          type: string
          description: ID unique du paiement
          example: "pay_1234567890"
        paymentReference:
          type: string
          description: R√©f√©rence unique g√©n√©r√©e
          example: "PAY_1696502400_ABC123"
        orderId:
          type: string
          description: ID de la commande associ√©e
          example: "12345"
        userId:
          type: string
          description: ID de l'utilisateur
          example: "usr_123"
        amount:
          type: number
          format: float
          description: Montant du paiement
          example: 99.99
        currency:
          type: string
          description: Devise ISO 4217
          example: "EUR"
        method:
          type: string
          enum: [CYBERPLUS, PAYBOX, CREDIT_CARD, DEBIT_CARD, PAYPAL, BANK_TRANSFER]
          description: M√©thode de paiement utilis√©e
        status:
          type: string
          enum: [PENDING, SUCCESS, FAILED, REFUNDED, CANCELLED]
          description: Statut actuel du paiement
          example: "SUCCESS"
        providerTransactionId:
          type: string
          description: ID transaction bancaire
          example: "TXN_987654321"
        refundedAmount:
          type: number
          format: float
          description: Montant rembours√© (si applicable)
          example: 0
        description:
          type: string
          description: Description du paiement
        metadata:
          type: object
          description: M√©tadonn√©es additionnelles
        createdAt:
          type: string
          format: date-time
          description: Date de cr√©ation
          example: "2024-11-14T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          description: Derni√®re mise √† jour
          example: "2024-11-14T10:05:00Z"

    PaymentResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Indicateur de succ√®s
        data:
          type: object
          properties:
            id:
              type: string
            paymentReference:
              type: string
            status:
              type: string
            amount:
              type: number
            currency:
              type: string
            method:
              type: string
            orderId:
              type: string
            userId:
              type: string
            redirectData:
              type: object
              description: Donn√©es pour redirection bancaire
              properties:
                url:
                  type: string
                  format: uri
                  description: URL de la passerelle bancaire
                method:
                  type: string
                  enum: [GET, POST]
                  description: M√©thode HTTP
                parameters:
                  type: object
                  description: Param√®tres du formulaire (inclut signature HMAC)
        message:
          type: string
          description: Message de succ√®s

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Message d'erreur
          example: "Invalid request"
        details:
          type: object
          description: D√©tails additionnels (optionnel)
