openapi: 3.0.3
info:
  title: Order API
  version: 1.0.0
  description: |
    API de gestion des commandes pour la plateforme e-commerce.
    
    ## üéØ Fonctionnalit√©s principales
    
    - **Gestion du cycle de vie** : 6 statuts (PENDING ‚Üí CONFIRMED ‚Üí PROCESSING ‚Üí SHIPPED ‚Üí DELIVERED, + CANCELLED)
    - **Actions admin** : Validation, exp√©dition, livraison, annulation, remboursements
    - **Gestion des lignes** : 6 statuts normaux (1-6) + 4 statuts √©quivalence (91-94)
    - **Archivage** : Export PDF, historique client, statistiques
    - **Tickets** : Pr√©paration, avoirs/cr√©dits avec expiration
    - **Donn√©es v√©hicule** : Immatriculation, VIN, compatibilit√© OEM
    
    ## üîê S√©curit√©
    
    - **Authentification** : JWT Bearer token (15min access + 7 days refresh)
    - **Autorisations** : 
      - Client : Ses propres commandes uniquement
      - Admin (role ‚â• 7) : Toutes commandes + actions backoffice
    
    ## üìä Workflow des statuts
    
    ### Statuts commande (6 √©tats)
    
    ```
    PENDING (1) ‚Üí CONFIRMED (2) ‚Üí PROCESSING (3) ‚Üí SHIPPED (4) ‚Üí DELIVERED (5)
                      ‚Üì
                  CANCELLED (6)
    ```
    
    ### Statuts ligne de commande
    
    **√âtats normaux (1-6) :**
    - `1` : En attente (ligne cr√©√©e)
    - `2` : Valid√©e (stock v√©rifi√©)
    - `3` : En pr√©paration
    - `4` : Exp√©di√©e
    - `5` : Livr√©e
    - `6` : Command√©e fournisseur (rupture stock)
    
    **√âtats √©quivalence (91-94) :**
    - `91` : √âquivalence propos√©e (produit de remplacement)
    - `92` : √âquivalence accept√©e (client OK)
    - `93` : √âquivalence refus√©e (client KO)
    - `94` : Annul√©e (remboursement effectu√©)
    
    ## üöö Volum√©trie production
    
    - **Commandes** : 1,440 commandes
    - **CA total** : ‚Ç¨51,509
    - **Panier moyen** : ‚Ç¨35.77
    - **Taux livraison** : 95.8%
    - **Temps moyen traitement** : 2.3 jours
    
    ## üîó Liens utiles
    
    - [Spec compl√®te Order Management](/spec/features/order-management.md)
    - [Types Zod](/spec/types/order.schema.md)
    - [ADR Supabase](/spec/architecture/001-supabase-direct.md)

  contact:
    name: API Support
    email: dev@example.com

servers:
  - url: http://localhost:3000
    description: D√©veloppement local
  - url: https://api.production.com
    description: Production

tags:
  - name: orders
    description: Op√©rations client (CRUD commandes)
  - name: admin
    description: Op√©rations administrateur (validation, stats, gestion globale)
  - name: actions
    description: Actions backoffice (exp√©dition, livraison, annulation)
  - name: status
    description: Gestion des statuts (lignes, historique)
  - name: archive
    description: Archivage et export (PDF, historique)
  - name: tickets
    description: Tickets de pr√©paration et avoirs

security:
  - BearerAuth: []

paths:
  /api/orders:
    get:
      tags:
        - orders
      summary: Lister les commandes de l'utilisateur
      description: |
        R√©cup√®re la liste pagin√©e des commandes de l'utilisateur connect√©.
        
        **Filtres disponibles :**
        - `status` : Filtrer par statut (1-6)
        - `year` : Filtrer par ann√©e (ex: 2024)
        - `startDate` / `endDate` : Plage de dates personnalis√©e
        
        **Pagination :**
        - `page` : Num√©ro de page (d√©faut: 1)
        - `limit` : R√©sultats par page (d√©faut: 10, max: 100)
      operationId: listMyOrders
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
          example: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
          example: 10
        - name: status
          in: query
          schema:
            type: integer
            enum: [1, 2, 3, 4, 5, 6]
          description: Statut de la commande
          example: 6
        - name: year
          in: query
          schema:
            type: integer
          description: Ann√©e de la commande
          example: 2025
        - name: startDate
          in: query
          schema:
            type: string
            format: date
          description: Date de d√©but (YYYY-MM-DD)
        - name: endDate
          in: query
          schema:
            type: string
            format: date
          description: Date de fin (YYYY-MM-DD)
      responses:
        '200':
          description: Liste des commandes
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                      limit:
                        type: integer
                      total:
                        type: integer
                      totalPages:
                        type: integer
              example:
                success: true
                data:
                  - id: "12345"
                    customerId: "usr_123"
                    status: 5
                    totalTTC: 99.99
                    createdAt: "2024-11-14T10:00:00Z"
                  - id: "12346"
                    customerId: "usr_123"
                    status: 3
                    totalTTC: 149.50
                    createdAt: "2024-11-13T15:30:00Z"
                pagination:
                  page: 1
                  limit: 10
                  total: 25
                  totalPages: 3
        '401':
          description: Non authentifi√©
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    
    post:
      tags:
        - orders
      summary: Cr√©er une nouvelle commande
      description: |
        Initialise une nouvelle commande √† partir du panier utilisateur.
        
        **Flux de cr√©ation :**
        1. Validation des donn√©es (montants, adresse, v√©hicule)
        2. V√©rification stock disponible
        3. Cr√©ation commande + lignes dans `___xtr_order` et `___xtr_order_line`
        4. G√©n√©ration r√©f√©rence unique
        5. Transition paiement (si montant > 0)
        
        **Donn√©es requises :**
        - Adresse de livraison compl√®te (CP, ville, t√©l√©phone valid√©s)
        - Donn√©es v√©hicule (immatriculation OU VIN)
        - Items avec quantit√©s et prix
        
        **Calculs automatiques :**
        - Frais de port selon poids/zone
        - Consignes si applicable
        - TVA 20%
        - Total TTC
      operationId: createOrder
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderDto'
            example:
              customerId: "usr_123"
              deliveryAddress:
                firstName: "Jean"
                lastName: "Dupont"
                street: "15 rue de la Paix"
                postalCode: "75001"
                city: "Paris"
                country: "France"
                phone: "+33612345678"
              vehicleData:
                immatriculation: "AB-123-CD"
                brand: "Renault"
                model: "Clio"
                year: 2020
              items:
                - productId: "prod_123"
                  quantity: 2
                  priceHT: 45.00
                  priceTTC: 54.00
                - productId: "prod_456"
                  quantity: 1
                  priceHT: 25.00
                  priceTTC: 30.00
              comment: "Livraison avant 18h si possible"
      responses:
        '201':
          description: Commande cr√©√©e avec succ√®s
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Order'
                  message:
                    type: string
              example:
                success: true
                data:
                  id: "12347"
                  reference: "ORD-2024-12347"
                  status: 1
                  customerId: "usr_123"
                  totalHT: 70.00
                  totalTTC: 84.00
                  shippingCost: 5.90
                  createdAt: "2024-11-14T16:00:00Z"
                message: "Commande cr√©√©e avec succ√®s"
        '400':
          description: Donn√©es invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidAddress:
                  value:
                    success: false
                    error: "Code postal invalide"
                stockUnavailable:
                  value:
                    success: false
                    error: "Article prod_123 en rupture de stock"

  /api/orders/{id}:
    get:
      tags:
        - orders
      summary: R√©cup√©rer une commande par ID
      description: |
        Obtient les d√©tails complets d'une commande sp√©cifique.
        
        **Inclut :**
        - Informations commande
        - Lignes de commande (articles)
        - Adresse de livraison
        - Donn√©es v√©hicule
        - Historique des statuts
        - Paiements associ√©s
        
        **R√®gles d'acc√®s :**
        - Client : Uniquement ses propres commandes
        - Admin : Toutes commandes
      operationId: getOrderById
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID de la commande
          example: "12345"
      responses:
        '200':
          description: D√©tails de la commande
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/OrderDetails'
                  timestamp:
                    type: string
                    format: date-time
        '404':
          description: Commande non trouv√©e
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Acc√®s non autoris√©
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    
    patch:
      tags:
        - orders
      summary: Mettre √† jour une commande
      description: |
        Permet au client de modifier certains champs d'une commande en statut PENDING.
        
        **Champs modifiables :**
        - `comment` : Commentaire client
        - Adresse de livraison (si non exp√©di√©e)
        
        **Restrictions :**
        - Commande doit √™tre en statut 1 (PENDING) ou 2 (CONFIRMED)
        - Modifications interdites apr√®s exp√©dition
      operationId: updateOrder
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID de la commande
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                comment:
                  type: string
                  maxLength: 500
                deliveryAddress:
                  $ref: '#/components/schemas/DeliveryAddress'
            example:
              comment: "Nouvelle remarque : laisser au gardien"
      responses:
        '200':
          description: Commande mise √† jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Order'
        '400':
          description: Modification non autoris√©e
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    
    delete:
      tags:
        - orders
      summary: Annuler une commande
      description: |
        Annule une commande en statut PENDING.
        
        **Actions effectu√©es :**
        1. V√©rification statut (doit √™tre PENDING)
        2. Annulation paiement associ√© (si applicable)
        3. Remise en stock des articles
        4. Transition statut ‚Üí CANCELLED (6)
        5. Notification email client
        
        **Restrictions :**
        - Seules les commandes PENDING peuvent √™tre annul√©es par le client
        - Admin peut annuler commandes CONFIRMED/PROCESSING
      operationId: deleteOrder
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID de la commande
      responses:
        '200':
          description: Commande annul√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
              example:
                success: true
                message: "Commande annul√©e avec succ√®s"
        '400':
          description: Annulation impossible
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/orders/customer/stats:
    get:
      tags:
        - orders
      summary: Statistiques des commandes client
      description: |
        Analyse personnelle de l'historique de commandes de l'utilisateur connect√©.
        
        **M√©triques calcul√©es :**
        - Nombre total de commandes
        - Montant total d√©pens√©
        - Panier moyen
        - R√©partition par statut
        - Commandes par mois (12 derniers mois)
        - Articles pr√©f√©r√©s
      operationId: getCustomerStats
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Statistiques client
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      totalOrders:
                        type: integer
                      totalSpent:
                        type: number
                      averageBasket:
                        type: number
                      statusBreakdown:
                        type: object
                      monthlyOrders:
                        type: array
                        items:
                          type: object

  /api/orders/admin/all:
    get:
      tags:
        - admin
      summary: Liste toutes les commandes (admin)
      description: |
        R√©cup√®re la liste compl√®te de toutes les commandes (tous clients).
        
        **Filtres admin :**
        - `status` : Filtrer par statut
        - `customerId` : Filtrer par client
        - `startDate` / `endDate` : Plage dates
        - `minAmount` / `maxAmount` : Plage montants
        - `search` : Recherche par r√©f√©rence/email/nom
        
        **Tri disponible :**
        - `createdAt` (desc par d√©faut)
        - `totalTTC`
        - `status`
      operationId: listAllOrders
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: status
          in: query
          schema:
            type: integer
            enum: [1, 2, 3, 4, 5, 6]
        - name: customerId
          in: query
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
          description: Recherche par r√©f√©rence/email/nom
      responses:
        '200':
          description: Liste des commandes
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'
                  pagination:
                    type: object
        '403':
          description: Acc√®s admin requis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/orders/admin/{id}:
    get:
      tags:
        - admin
      summary: D√©tails complets commande (admin)
      description: |
        Vue administrative compl√®te d'une commande avec toutes les m√©tadonn√©es.
        
        **Informations suppl√©mentaires admin :**
        - Logs de statut complets
        - Historique des modifications
        - Donn√©es fournisseur (si applicable)
        - √âquivalences propos√©es/accept√©es/refus√©es
        - Tickets associ√©s (pr√©paration, avoirs)
      operationId: getOrderByIdAdmin
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: D√©tails admin
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/OrderAdminDetails'

  /api/orders/admin/{id}/status:
    patch:
      tags:
        - admin
      summary: Mettre √† jour le statut d'une commande (admin)
      description: |
        Modification manuelle du statut global de la commande.
        
        **Transitions autoris√©es :**
        - 1 (PENDING) ‚Üí 2 (CONFIRMED)
        - 2 (CONFIRMED) ‚Üí 3 (PROCESSING)
        - 3 (PROCESSING) ‚Üí 4 (SHIPPED)
        - 4 (SHIPPED) ‚Üí 5 (DELIVERED)
        - Tout statut ‚Üí 6 (CANCELLED)
        
        **Actions automatiques :**
        - Email client √† chaque changement
        - Mise √† jour statuts lignes (si applicable)
        - Log audit admin
      operationId: updateOrderStatus
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: integer
                  enum: [1, 2, 3, 4, 5, 6]
                comment:
                  type: string
                  maxLength: 255
            example:
              status: 4
              comment: "Exp√©di√© via Colissimo - Suivi: 6A12345678"
      responses:
        '200':
          description: Statut mis √† jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Order'

  /api/orders/admin/stats/global:
    get:
      tags:
        - admin
      summary: Statistiques globales (admin)
      description: |
        Analyse compl√®te de toutes les commandes plateforme.
        
        **KPIs calcul√©s :**
        - CA total et par p√©riode
        - Nombre commandes par statut
        - Panier moyen
        - Taux conversion (panier ‚Üí commande)
        - Taux livraison
        - Temps moyen traitement
        - Top clients
        - Top produits
      operationId: getGlobalStats
      security:
        - BearerAuth: []
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: groupBy
          in: query
          schema:
            type: string
            enum: [day, week, month, year]
          description: Granularit√© d'agr√©gation
      responses:
        '200':
          description: Statistiques globales
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      totalRevenue:
                        type: number
                      totalOrders:
                        type: integer
                      averageBasket:
                        type: number
                      conversionRate:
                        type: number
                      deliveryRate:
                        type: number
                      avgProcessingTime:
                        type: number
                        description: En jours
                      statusBreakdown:
                        type: object
                      timeSeries:
                        type: array
                        items:
                          type: object

  /api/orders/admin/customer/{customerId}:
    get:
      tags:
        - admin
      summary: Commandes d'un client sp√©cifique (admin)
      description: Historique complet des commandes d'un client (vue admin)
      operationId: getCustomerOrders
      security:
        - BearerAuth: []
      parameters:
        - name: customerId
          in: path
          required: true
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Commandes du client
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'

  /api/admin/orders/{orderId}/validate:
    post:
      tags:
        - actions
      summary: Valider une commande (admin)
      description: |
        Valide une commande en attente (statut 1 ‚Üí 2).
        
        **Actions effectu√©es :**
        1. V√©rification paiement (si applicable)
        2. V√©rification stock pour toutes lignes
        3. R√©servation stock
        4. Transition statut ‚Üí CONFIRMED (2)
        5. Email confirmation client
        
        **Pr√©requis :**
        - Commande en statut PENDING (1)
        - Paiement valid√© (si montant > 0)
        - Stock disponible pour tous les articles
      operationId: validateOrder
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Commande valid√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/Order'
              example:
                success: true
                message: "Commande 12345 valid√©e avec succ√®s"
                data:
                  id: "12345"
                  status: 2
        '400':
          description: Validation impossible
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/admin/orders/{orderId}/ship:
    post:
      tags:
        - actions
      summary: Marquer commande comme exp√©di√©e (admin)
      description: |
        Marque la commande comme exp√©di√©e (statut 3 ‚Üí 4).
        
        **Actions effectu√©es :**
        1. Transition statut ‚Üí SHIPPED (4)
        2. Enregistrement num√©ro de suivi
        3. G√©n√©ration ticket de pr√©paration
        4. Email exp√©dition client (avec tracking)
        5. Mise √† jour toutes lignes ‚Üí statut 4
        
        **Donn√©es requises :**
        - Transporteur (Colissimo, Chronopost, etc.)
        - Num√©ro de suivi
      operationId: shipOrder
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - carrier
                - trackingNumber
              properties:
                carrier:
                  type: string
                  enum: [COLISSIMO, CHRONOPOST, UPS, DHL, FEDEX]
                trackingNumber:
                  type: string
                  minLength: 5
                  maxLength: 50
                comment:
                  type: string
            example:
              carrier: "COLISSIMO"
              trackingNumber: "6A12345678901"
              comment: "Colis fragile"
      responses:
        '200':
          description: Commande exp√©di√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/Order'

  /api/admin/orders/{orderId}/deliver:
    post:
      tags:
        - actions
      summary: Marquer commande comme livr√©e (admin)
      description: |
        Confirme la livraison de la commande (statut 4 ‚Üí 5).
        
        **Actions effectu√©es :**
        1. Transition statut ‚Üí DELIVERED (5)
        2. Date/heure de livraison enregistr√©e
        3. Email livraison client (demande avis)
        4. Mise √† jour toutes lignes ‚Üí statut 5
        5. Archivage automatique apr√®s 30 jours
      operationId: deliverOrder
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                deliveredAt:
                  type: string
                  format: date-time
                  description: Date/heure livraison (d√©faut = maintenant)
                signedBy:
                  type: string
                  description: Nom du destinataire ayant sign√©
            example:
              deliveredAt: "2024-11-14T14:30:00Z"
              signedBy: "Jean Dupont"
      responses:
        '200':
          description: Commande livr√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /api/admin/orders/{orderId}/cancel:
    post:
      tags:
        - actions
      summary: Annuler une commande (admin)
      description: |
        Annule une commande √† n'importe quel statut (transition ‚Üí 6 CANCELLED).
        
        **Actions effectu√©es :**
        1. V√©rification possibilit√© annulation
        2. Annulation paiement / Remboursement (si pay√©e)
        3. Remise en stock des articles
        4. Transition statut ‚Üí CANCELLED (6)
        5. Annulation de toutes lignes ‚Üí statut 94
        6. Email annulation client
        
        **Remboursement automatique si :**
        - Commande pay√©e (paiement SUCCESS)
        - Annulation avant exp√©dition
      operationId: cancelOrder
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - reason
              properties:
                reason:
                  type: string
                  minLength: 10
                  maxLength: 500
                  description: Raison de l'annulation
                refund:
                  type: boolean
                  default: true
                  description: Effectuer remboursement automatique
            example:
              reason: "Article en rupture d√©finitive chez fournisseur"
              refund: true
      responses:
        '200':
          description: Commande annul√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  refunded:
                    type: boolean
                  refundAmount:
                    type: number

  /api/admin/orders/{orderId}/payment-reminder:
    post:
      tags:
        - actions
      summary: Envoyer rappel de paiement (admin)
      description: |
        Envoie un email de rappel pour commande non pay√©e.
        
        **Cas d'usage :**
        - Commande cr√©√©e mais paiement abandonn√©
        - Paiement en erreur (carte refus√©e)
        - Virement attendu (paiement diff√©r√©)
        
        **Email contient :**
        - R√©capitulatif commande
        - Lien paiement direct
        - Date limite paiement
      operationId: sendPaymentReminder
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Rappel envoy√©
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /api/admin/orders/{orderId}/lines/{lineId}/status/{newStatus}:
    patch:
      tags:
        - actions
      summary: Changer statut d'une ligne de commande (admin)
      description: |
        Modifie le statut individuel d'une ligne de commande.
        
        **Statuts disponibles :**
        - 1-6 : √âtats normaux
        - 91-94 : √âtats √©quivalence
        
        **Transitions courantes :**
        - 1 ‚Üí 2 : Validation stock
        - 2 ‚Üí 3 : D√©but pr√©paration
        - 2 ‚Üí 6 : Commande fournisseur (rupture)
        - 2 ‚Üí 91 : Proposition √©quivalence
        - 91 ‚Üí 92 : Acceptation √©quivalence
        - 91 ‚Üí 93 : Refus √©quivalence
        - Tout ‚Üí 94 : Annulation
      operationId: updateLineStatus
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
        - name: lineId
          in: path
          required: true
          schema:
            type: integer
        - name: newStatus
          in: path
          required: true
          schema:
            type: integer
            enum: [1, 2, 3, 4, 5, 6, 91, 92, 93, 94]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                comment:
                  type: string
                  maxLength: 255
                resetEquiv:
                  type: boolean
                  default: false
                  description: R√©initialiser √©quivalence propos√©e
            example:
              comment: "Article en rupture, commande fournisseur lanc√©e"
              resetEquiv: false
      responses:
        '200':
          description: Statut ligne mis √† jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /api/admin/orders/{orderId}/lines/{lineId}/order-from-supplier:
    post:
      tags:
        - actions
      summary: Commander ligne chez fournisseur (admin)
      description: |
        Marque une ligne comme "command√©e fournisseur" (statut 6).
        
        **Donn√©es enregistr√©es :**
        - ID fournisseur (splId)
        - Nom fournisseur
        - Prix d'achat HT
        - Quantit√© command√©e
        - Date commande
        
        **Email automatique :**
        - Client notifi√© du d√©lai suppl√©mentaire
        - Estimation nouvelle date livraison
      operationId: orderFromSupplier
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
        - name: lineId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - supplierId
                - supplierName
                - priceHT
                - quantity
              properties:
                supplierId:
                  type: integer
                supplierName:
                  type: string
                priceHT:
                  type: number
                  minimum: 0
                quantity:
                  type: integer
                  minimum: 1
            example:
              supplierId: 42
              supplierName: "Fournisseur Auto Parts SAS"
              priceHT: 35.50
              quantity: 2
      responses:
        '200':
          description: Commande fournisseur enregistr√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /api/admin/orders/{orderId}/lines/{lineId}/propose-equivalent:
    post:
      tags:
        - actions
      summary: Proposer √©quivalence pour une ligne (admin)
      description: |
        Propose un produit de remplacement pour article indisponible (statut 91).
        
        **R√®gles m√©tier :**
        - Article original en rupture (statut 2)
        - √âquivalence compatible avec v√©hicule client
        - Prix √©quivalent (¬±10%)
        - OEM compatible si applicable
        
        **Email client :**
        - D√©tails produit √©quivalent
        - Comparatif caract√©ristiques
        - Lien acceptation/refus
      operationId: proposeEquivalent
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
        - name: lineId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - productId
                - quantity
              properties:
                productId:
                  type: integer
                  description: ID du produit √©quivalent
                quantity:
                  type: integer
                  minimum: 1
            example:
              productId: 98765
              quantity: 2
      responses:
        '200':
          description: √âquivalence propos√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /api/admin/orders/{orderId}/lines/{lineId}/accept-equivalent:
    patch:
      tags:
        - actions
      summary: Accepter √©quivalence (statut 91 ‚Üí 92)
      description: |
        Marque l'√©quivalence comme accept√©e (client a valid√©).
        
        **Actions :**
        1. Transition statut 91 ‚Üí 92
        2. Remplacement article dans commande
        3. Recalcul montants si diff√©rence prix
        4. G√©n√©ration avoir/suppl√©ment si n√©cessaire
      operationId: acceptEquivalent
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
        - name: lineId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: √âquivalence accept√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /api/admin/orders/{orderId}/lines/{lineId}/reject-equivalent:
    patch:
      tags:
        - actions
      summary: Refuser √©quivalence (statut 91 ‚Üí 93)
      description: |
        Marque l'√©quivalence comme refus√©e (client a d√©clin√©).
        
        **Actions :**
        1. Transition statut 91 ‚Üí 93
        2. Annulation ligne ‚Üí statut 94
        3. G√©n√©ration avoir automatique
        4. Email confirmation client
      operationId: rejectEquivalent
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
        - name: lineId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: √âquivalence refus√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /order-status/info/{status}:
    get:
      tags:
        - status
      summary: Obtenir informations d'un statut
      description: |
        R√©cup√®re les d√©tails d'un code statut sp√©cifique.
        
        **Informations retourn√©es :**
        - Code num√©rique
        - Label fran√ßais
        - Couleur UI
        - Description
        - Actions disponibles
      operationId: getStatusInfo
      parameters:
        - name: status
          in: path
          required: true
          schema:
            type: integer
          example: 3
      responses:
        '200':
          description: Informations statut
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  status:
                    type: integer
                  label:
                    type: string
                  color:
                    type: string
                  description:
                    type: string
              example:
                success: true
                status: 3
                label: "En pr√©paration"
                color: "#FFA500"
                description: "Commande en cours de pr√©paration dans l'entrep√¥t"

  /order-status/all:
    get:
      tags:
        - status
      summary: Obtenir tous les statuts disponibles
      description: Liste compl√®te des codes statuts avec m√©tadonn√©es
      operationId: getAllStatuses
      responses:
        '200':
          description: Liste des statuts
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  statuses:
                    type: array
                    items:
                      type: object
                  total:
                    type: integer

  /order-status/line/{lineId}:
    patch:
      tags:
        - status
      summary: Mettre √† jour statut d'une ligne
      description: Modification directe du statut d'une ligne (sans contr√¥leur parent)
      operationId: updateLineStatusDirect
      parameters:
        - name: lineId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: integer
                comment:
                  type: string
                userId:
                  type: integer
      responses:
        '200':
          description: Statut mis √† jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /order-status/order/{orderId}/history:
    get:
      tags:
        - status
      summary: Historique des statuts d'une commande
      description: |
        Chronologie compl√®te des changements de statuts.
        
        **Inclut :**
        - Date/heure de chaque transition
        - Ancien et nouveau statut
        - Utilisateur ayant effectu√© le changement
        - Commentaire associ√©
      operationId: getOrderStatusHistory
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Historique des statuts
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  orderId:
                    type: integer
                  history:
                    type: array
                    items:
                      type: object
                      properties:
                        timestamp:
                          type: string
                          format: date-time
                        fromStatus:
                          type: integer
                        toStatus:
                          type: integer
                        userId:
                          type: integer
                        comment:
                          type: string
                  total:
                    type: integer

  /order-archive/{orderId}:
    get:
      tags:
        - archive
      summary: R√©cup√©rer une commande archiv√©e
      description: Acc√®s aux commandes archiv√©es (> 1 an ou livr√©es depuis > 30j)
      operationId: getArchivedOrder
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Commande archiv√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Order'

  /order-archive/customer/{customerId}/list:
    get:
      tags:
        - archive
      summary: Lister commandes archiv√©es d'un client
      description: Historique complet des commandes archiv√©es
      operationId: listArchivedOrders
      parameters:
        - name: customerId
          in: path
          required: true
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Liste archives
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'

  /order-archive/{orderId}/export:
    get:
      tags:
        - archive
      summary: Exporter commande pour PDF
      description: |
        G√©n√®re les donn√©es format√©es pour export PDF.
        
        **Format de sortie :**
        - Donn√©es commande compl√®tes
        - Lignes format√©es pour impression
        - Adresses format√©es
        - QR code (r√©f√©rence commande)
        - Logo entreprise
      operationId: exportOrderForPdf
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Donn√©es export PDF
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                  message:
                    type: string

  /order-archive/customer/{customerId}/stats:
    get:
      tags:
        - archive
      summary: Statistiques d'archivage client
      description: M√©triques sur commandes archiv√©es d'un client
      operationId: getArchiveStats
      parameters:
        - name: customerId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Stats archives
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object

  /order-archive/{orderId}/archive:
    post:
      tags:
        - archive
      summary: Marquer commande comme archiv√©e
      description: Archivage manuel (normalement automatique apr√®s 30j)
      operationId: archiveOrder
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Commande archiv√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /order-archive/{orderId}/restore:
    post:
      tags:
        - archive
      summary: Restaurer commande archiv√©e
      description: D√©sarchivage (admin uniquement)
      operationId: restoreOrder
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Commande restaur√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /api/tickets/test:
    get:
      tags:
        - tickets
      summary: Test du service tickets
      description: Endpoint de sant√© pour service tickets
      operationId: testTicketsService
      responses:
        '200':
          description: Service op√©rationnel
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  features:
                    type: array
                    items:
                      type: string

  /api/tickets/preparation/{orderLineId}:
    post:
      tags:
        - tickets
      summary: Cr√©er ticket de pr√©paration
      description: |
        G√©n√®re un ticket de pr√©paration pour une ligne de commande.
        
        **Contenu ticket :**
        - R√©f√©rence unique (QR code)
        - Informations produit
        - Emplacement stock
        - Quantit√© √† pr√©parer
        - Notes pr√©paration
        
        **Statut ligne :** 2 (valid√©e) ‚Üí 3 (en pr√©paration)
      operationId: createPreparationTicket
      security:
        - BearerAuth: []
      parameters:
        - name: orderLineId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Ticket cr√©√©
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      ticketId:
                        type: string
                      reference:
                        type: string
                      qrCode:
                        type: string
                        format: uri
                  message:
                    type: string

  /api/tickets/credit:
    post:
      tags:
        - tickets
      summary: Cr√©er un avoir/cr√©dit
      description: |
        G√©n√®re un avoir pour remboursement client.
        
        **Types d'avoir :**
        - Annulation article (remboursement total)
        - Compensation service (remboursement partiel)
        - Geste commercial
        
        **Expiration :** 12 mois par d√©faut
        
        **Utilisation :** D√©ductible sur prochaine commande
      operationId: createCreditNote
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - orderLineId
                - amount
                - reason
              properties:
                orderLineId:
                  type: string
                amount:
                  type: number
                  minimum: 0.01
                reason:
                  type: string
                  minLength: 10
                  maxLength: 255
            example:
              orderLineId: "line_123"
              amount: 25.50
              reason: "Article endommag√© lors du transport"
      responses:
        '200':
          description: Avoir cr√©√©
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      creditId:
                        type: string
                      reference:
                        type: string
                      amount:
                        type: number
                      expiresAt:
                        type: string
                        format: date-time
                  message:
                    type: string

  /api/tickets/validate/{ticketReference}:
    get:
      tags:
        - tickets
      summary: Valider un ticket
      description: |
        V√©rification de la validit√© d'un ticket (pr√©paration ou avoir).
        
        **V√©rifications :**
        - Ticket existe
        - Non expir√©
        - Non d√©j√† utilis√©
        - Montant disponible (avoirs)
      operationId: validateTicket
      parameters:
        - name: ticketReference
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Validation effectu√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      valid:
                        type: boolean
                      ticketType:
                        type: string
                      amount:
                        type: number
                      expiresAt:
                        type: string
                        format: date-time
                  message:
                    type: string

  /api/tickets/use:
    post:
      tags:
        - tickets
      summary: Utiliser un ticket
      description: |
        Consomme un ticket (marque comme utilis√©).
        
        **Cas d'usage :**
        - Validation pr√©paration (ticket pr√©paration)
        - Application avoir sur commande (ticket cr√©dit)
      operationId: useTicket
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ticketReference
              properties:
                ticketReference:
                  type: string
                orderId:
                  type: string
                  description: ID commande (pour avoirs)
            example:
              ticketReference: "CREDIT-2024-001"
              orderId: "12348"
      responses:
        '200':
          description: Ticket utilis√©
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /api/tickets/order/{orderId}:
    get:
      tags:
        - tickets
      summary: Lister tickets d'une commande
      description: Tous les tickets (pr√©paration + avoirs) associ√©s √† une commande
      operationId: listOrderTickets
      security:
        - BearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Liste des tickets
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token obtenu via `/api/auth/login`.
        
        **Format :** `Authorization: Bearer <token>`

  schemas:
    CreateOrderDto:
      type: object
      required:
        - customerId
        - deliveryAddress
        - items
      properties:
        customerId:
          type: string
          description: ID utilisateur (extrait du JWT si omis)
        deliveryAddress:
          $ref: '#/components/schemas/DeliveryAddress'
        vehicleData:
          $ref: '#/components/schemas/VehicleData'
        items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - productId
              - quantity
              - priceHT
              - priceTTC
            properties:
              productId:
                type: string
              quantity:
                type: integer
                minimum: 1
              priceHT:
                type: number
                minimum: 0
              priceTTC:
                type: number
                minimum: 0
        comment:
          type: string
          maxLength: 500

    Order:
      type: object
      properties:
        id:
          type: string
          description: ID unique de la commande
        reference:
          type: string
          description: R√©f√©rence format√©e (ORD-YYYY-XXXXX)
        customerId:
          type: string
        status:
          type: integer
          enum: [1, 2, 3, 4, 5, 6]
          description: Statut de la commande
        totalHT:
          type: number
          description: Total hors taxes
        totalTTC:
          type: number
          description: Total TTC
        shippingCost:
          type: number
        depositAmount:
          type: number
          description: Montant des consignes
        isPaid:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    OrderDetails:
      allOf:
        - $ref: '#/components/schemas/Order'
        - type: object
          properties:
            lines:
              type: array
              items:
                $ref: '#/components/schemas/OrderLine'
            deliveryAddress:
              $ref: '#/components/schemas/DeliveryAddress'
            vehicleData:
              $ref: '#/components/schemas/VehicleData'
            payments:
              type: array
              items:
                type: object
            statusHistory:
              type: array
              items:
                type: object

    OrderAdminDetails:
      allOf:
        - $ref: '#/components/schemas/OrderDetails'
        - type: object
          properties:
            supplierOrders:
              type: array
              description: Commandes fournisseur associ√©es
            equivalences:
              type: array
              description: √âquivalences propos√©es/accept√©es/refus√©es
            tickets:
              type: array
              description: Tickets pr√©paration et avoirs
            logs:
              type: array
              description: Logs admin complets

    OrderLine:
      type: object
      properties:
        id:
          type: integer
        orderId:
          type: string
        productId:
          type: string
        productName:
          type: string
        quantity:
          type: integer
        priceHT:
          type: number
        priceTTC:
          type: number
        status:
          type: integer
          enum: [1, 2, 3, 4, 5, 6, 91, 92, 93, 94]
        equivalentProductId:
          type: string
          nullable: true
        supplierData:
          type: object
          nullable: true

    DeliveryAddress:
      type: object
      required:
        - firstName
        - lastName
        - street
        - postalCode
        - city
        - country
        - phone
      properties:
        firstName:
          type: string
          minLength: 2
          maxLength: 50
        lastName:
          type: string
          minLength: 2
          maxLength: 50
        street:
          type: string
          minLength: 5
          maxLength: 100
        complement:
          type: string
          maxLength: 100
        postalCode:
          type: string
          pattern: '^\d{5}$'
          description: Code postal fran√ßais (5 chiffres)
        city:
          type: string
          minLength: 2
          maxLength: 50
        country:
          type: string
          default: France
        phone:
          type: string
          pattern: '^\+?[0-9]{10,15}$'
          description: T√©l√©phone valide (format international accept√©)

    VehicleData:
      type: object
      properties:
        immatriculation:
          type: string
          pattern: '^[A-Z]{2}-[0-9]{3}-[A-Z]{2}$'
          description: Format fran√ßais (AB-123-CD)
        vin:
          type: string
          minLength: 17
          maxLength: 17
          description: Num√©ro de ch√¢ssis (17 caract√®res)
        brand:
          type: string
        model:
          type: string
        year:
          type: integer
          minimum: 1970
          maximum: 2030
        engine:
          type: string
        fuel:
          type: string
          enum: [ESSENCE, DIESEL, HYBRID, ELECTRIC, GPL]

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
        details:
          type: object
