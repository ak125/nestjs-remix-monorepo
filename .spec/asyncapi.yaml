asyncapi: 3.0.0
info:
  title: Autoparts E-commerce Webhooks & Events API
  version: 1.0.0
  description: |
    # üì° Documentation AsyncAPI - Webhooks & Events
    
    Cette sp√©cification documente tous les **webhooks entrants** et **√©v√©nements asynchrones** 
    de la plateforme e-commerce pi√®ces auto.
    
    ## üéØ Cas d'usage
    
    - **Webhooks tiers** : Paybox, TecDoc, transporteurs
    - **Automatisations** : n8n workflows
    - **√âv√©nements internes** : Order lifecycle, payment notifications
    - **Int√©grations externes** : ERP, CRM, analytics
    
    ## üîê S√©curit√©
    
    Tous les webhooks utilisent l'une des m√©thodes suivantes :
    - **HMAC-SHA512** (Paybox) - Signature cryptographique
    - **IP Whitelisting** (TecDoc) - Liste blanche IPs
    - **API Keys** (n8n, internal) - Cl√©s secr√®tes
    
    ## üìä Statistiques
    
    - **5 webhooks externes** document√©s
    - **12 √©v√©nements internes** (order, payment, shipping)
    - **~500 callbacks/jour** (production)
  
  contact:
    name: Webhook Support
    email: webhooks@autoparts.com
    url: https://autoparts.com/webhooks
  
  license:
    name: Proprietary
    url: https://autoparts.com/license

servers:
  production:
    host: api.autoparts.com
    protocol: https
    description: Production webhook receiver
    
  staging:
    host: staging-api.autoparts.com
    protocol: https
    description: Staging webhook receiver
    
  development:
    host: localhost:3000
    protocol: http
    description: Development webhook receiver

channels:
  payboxIpnCallback:
    address: /api/paybox/callback
    messages:
      payboxPaymentNotification:
        $ref: '#/components/messages/PayboxIPN'
    description: |
      **Webhook Paybox IPN** (Instant Payment Notification)
      
      Appel√© par Paybox apr√®s chaque transaction de paiement (succ√®s ou √©chec).
      
      ### üîê S√©curit√©
      - **Signature HMAC-SHA512** obligatoire
      - Cl√© HMAC configur√©e dans back-office Paybox
      - V√©rification signature c√¥t√© serveur
      
      ### üéØ Flow
      1. User compl√®te paiement sur Paybox
      2. Paybox envoie POST vers `/api/paybox/callback`
      3. Backend valide signature HMAC
      4. Mise √† jour statut commande
      5. Email confirmation client
      6. Retour HTTP 200 OK
      
      ### ‚è±Ô∏è Timeout
      - Paybox attend r√©ponse sous **30 secondes**
      - Retry automatique si timeout (3x max)
      
      ### üìù Logs
      - Tous les callbacks logu√©s dans `ic_postback`
      - Audit complet (params, signature, timestamp)
  
  cyberPlusCallback:
    address: /api/payments/callback/cyberplus
    messages:
      cyberPlusPaymentNotification:
        $ref: '#/components/messages/CyberPlusIPN'
    description: |
      **Webhook CyberPlus/BNP Paribas** (IPN)
      
      Ancienne passerelle de paiement (legacy, toujours active).
      
      ### üîê S√©curit√©
      - **Signature HMAC-SHA256**
      - IP Whitelisting BNP Paribas
      
      ### üéØ Statuts support√©s
      - `00` : SUCCESS
      - `05` : Refus√© (funds)
      - `17` : Annul√© user
      - `30` : Format error
  
  tecDocProductUpdate:
    address: /api/integrations/tecdoc/webhook
    messages:
      tecDocProductUpdate:
        $ref: '#/components/messages/TecDocUpdate'
    description: |
      **Webhook TecDoc** - Mises √† jour catalogue
      
      TecDoc envoie des notifications lors de :
      - Mise √† jour stock fournisseur
      - Changement prix
      - Nouveau produit disponible
      - Produit discontinu√©
      
      ### üîê S√©curit√©
      - **IP Whitelisting** TecDoc servers
      - **API Key** dans header `X-TecDoc-Key`
      
      ### ‚è±Ô∏è Fr√©quence
      - Temps r√©el (√©v√©nementiel)
      - Batch nightly (full sync) √† 02:00 UTC
      
      ### üìä Volume
      - ~50-200 webhooks/jour
      - Batch : ~10,000 produits/nuit
  
  carrierTrackingUpdate:
    address: /api/shipping/tracking/webhook
    messages:
      carrierTrackingUpdate:
        $ref: '#/components/messages/CarrierTracking'
    description: |
      **Webhook Transporteurs** - Suivi colis
      
      Les transporteurs (DHL, Chronopost, Colissimo) envoient des updates :
      - Colis en transit
      - Arriv√© au centre de tri
      - En cours de livraison
      - Livr√© (POD - Proof of Delivery)
      - √âchec livraison
      
      ### üöö Transporteurs support√©s
      - DHL Express
      - Chronopost
      - Colissimo
      - UPS
      - FedEx
      
      ### üîê S√©curit√©
      - **API Key** par transporteur
      - **Signature HMAC** (optionnel selon transporteur)
  
  n8nWorkflowTrigger:
    address: /api/webhooks/n8n/{workflowId}
    messages:
      n8nWorkflowEvent:
        $ref: '#/components/messages/N8nWorkflow'
    description: |
      **Webhook n8n** - Automatisations
      
      Endpoints g√©n√©riques pour d√©clencher des workflows n8n.
      
      ### ü§ñ Workflows actifs
      1. **Order fulfillment** - Automatise pr√©paration commande
      2. **Stock alerts** - Notifications stock bas
      3. **Customer segments** - Mise √† jour segments marketing
      4. **Invoice generation** - G√©n√©ration factures auto
      5. **Support tickets** - Cr√©ation tickets Zendesk
      
      ### üîê S√©curit√©
      - **Webhook secret** dans query param `?secret=xxx`
      - IP restriction (optionnel)
      
      ### üìä Format
      - POST JSON (flexible schema)
      - Headers custom support√©s

operations:
  receivePayboxCallback:
    action: receive
    channel:
      $ref: '#/channels/payboxIpnCallback'
    summary: Recevoir notification paiement Paybox
    description: |
      Traite les callbacks IPN de Paybox apr√®s un paiement.
      
      **√âtapes de traitement :**
      1. Extraction param√®tres query string
      2. V√©rification signature HMAC-SHA512
      3. Validation montant/r√©f√©rence
      4. Mise √† jour statut paiement en DB
      5. Mise √† jour statut commande
      6. Envoi email confirmation client
      7. Log audit dans `ic_postback`
      8. Retour HTTP 200 OK
    messages:
      - $ref: '#/channels/payboxIpnCallback/messages/payboxPaymentNotification'
  
  receiveCyberPlusCallback:
    action: receive
    channel:
      $ref: '#/channels/cyberPlusCallback'
    summary: Recevoir notification paiement CyberPlus
    description: Traite les callbacks IPN de CyberPlus (legacy).
    messages:
      - $ref: '#/channels/cyberPlusCallback/messages/cyberPlusPaymentNotification'
  
  receiveTecDocUpdate:
    action: receive
    channel:
      $ref: '#/channels/tecDocProductUpdate'
    summary: Recevoir mise √† jour produit TecDoc
    description: |
      Synchronise les donn√©es produits depuis TecDoc.
      
      **Actions selon type d'update :**
      - `STOCK_UPDATE` : Mise √† jour stock en cache Redis
      - `PRICE_CHANGE` : Recalcul prix + marges
      - `NEW_PRODUCT` : Ajout catalogue + indexation Meilisearch
      - `DISCONTINUED` : Marquage produit non disponible
    messages:
      - $ref: '#/channels/tecDocProductUpdate/messages/tecDocProductUpdate'
  
  receiveCarrierTracking:
    action: receive
    channel:
      $ref: '#/channels/carrierTrackingUpdate'
    summary: Recevoir mise √† jour suivi colis
    description: |
      Met √† jour le tracking des colis en temps r√©el.
      
      **Actions :**
      1. Insertion √©v√©nement tracking en DB
      2. Mise √† jour cache Redis (last status)
      3. Notification client si livraison
      4. Notification admin si probl√®me
    messages:
      - $ref: '#/channels/carrierTrackingUpdate/messages/carrierTrackingUpdate'
  
  triggerN8nWorkflow:
    action: receive
    channel:
      $ref: '#/channels/n8nWorkflowTrigger'
    summary: D√©clencher workflow n8n
    description: |
      Endpoint g√©n√©rique pour d√©clencher des automatisations n8n.
      
      Le payload est transmis tel quel au workflow n8n.
    messages:
      - $ref: '#/channels/n8nWorkflowTrigger/messages/n8nWorkflowEvent'

components:
  messages:
    PayboxIPN:
      name: PayboxPaymentNotification
      title: Notification paiement Paybox
      summary: Callback IPN envoy√© par Paybox apr√®s transaction
      contentType: application/x-www-form-urlencoded
      payload:
        $ref: '#/components/schemas/PayboxCallbackPayload'
      examples:
        - name: Paiement r√©ussi
          summary: Transaction valid√©e par la banque
          payload:
            Mt: "7790"
            Ref: "ORD-2024-001"
            Auto: "123456"
            Erreur: "00000"
            Date: "20240115143000"
            Heure: "143000"
            Pays: "FRA"
            Carte: "VISA"
            Sign: "ABC123DEF456..."
            K: "ABC123DEF456..."
        
        - name: Paiement refus√©
          summary: Transaction rejet√©e (fonds insuffisants)
          payload:
            Mt: "7790"
            Ref: "ORD-2024-002"
            Auto: ""
            Erreur: "00001"
            Date: "20240115143100"
            Heure: "143100"
            Pays: "FRA"
            Carte: "VISA"
            Sign: "XYZ789GHI012..."
            K: "XYZ789GHI012..."
    
    CyberPlusIPN:
      name: CyberPlusPaymentNotification
      title: Notification paiement CyberPlus
      summary: Callback IPN CyberPlus (legacy)
      contentType: application/x-www-form-urlencoded
      payload:
        $ref: '#/components/schemas/CyberPlusCallbackPayload'
      examples:
        - name: Paiement r√©ussi
          payload:
            vads_amount: "7790"
            vads_order_id: "ORD-2024-003"
            vads_trans_id: "654321"
            vads_trans_status: "AUTHORISED"
            vads_auth_result: "00"
            signature: "fedcba987654..."
    
    TecDocUpdate:
      name: TecDocProductUpdate
      title: Mise √† jour produit TecDoc
      summary: Notification de changement catalogue TecDoc
      contentType: application/json
      payload:
        $ref: '#/components/schemas/TecDocUpdatePayload'
      examples:
        - name: Mise √† jour stock
          payload:
            eventType: "STOCK_UPDATE"
            productId: "TD-123456"
            ean: "5012345678900"
            stock: 150
            supplier: "VALEO"
            timestamp: "2024-01-15T14:30:00Z"
        
        - name: Changement prix
          payload:
            eventType: "PRICE_CHANGE"
            productId: "TD-123457"
            ean: "5012345678901"
            priceHT: 45.90
            priceOld: 49.90
            currency: "EUR"
            effectiveDate: "2024-01-20T00:00:00Z"
            timestamp: "2024-01-15T14:35:00Z"
    
    CarrierTracking:
      name: CarrierTrackingUpdate
      title: Mise √† jour suivi colis
      summary: √âv√©nement tracking envoy√© par transporteur
      contentType: application/json
      payload:
        $ref: '#/components/schemas/CarrierTrackingPayload'
      examples:
        - name: Colis livr√©
          payload:
            trackingNumber: "DHL123456789"
            carrier: "DHL"
            status: "DELIVERED"
            statusCode: "OK"
            location: "Paris 75001"
            timestamp: "2024-01-15T16:45:00Z"
            recipient: "Jean Dupont"
            signatureUrl: "https://dhl.com/pod/123456789.pdf"
        
        - name: En transit
          payload:
            trackingNumber: "CP987654321"
            carrier: "CHRONOPOST"
            status: "IN_TRANSIT"
            statusCode: "TR"
            location: "Centre de tri Roissy"
            timestamp: "2024-01-15T08:20:00Z"
            estimatedDelivery: "2024-01-16T18:00:00Z"
    
    N8nWorkflow:
      name: N8nWorkflowEvent
      title: √âv√©nement workflow n8n
      summary: Payload flexible pour d√©clencher workflow
      contentType: application/json
      payload:
        $ref: '#/components/schemas/N8nWorkflowPayload'
      examples:
        - name: Order fulfillment
          payload:
            workflowId: "order-fulfillment-v2"
            event: "order.validated"
            orderId: "ORD-2024-005"
            items: 
              - productId: "PRD-001"
                quantity: 2
                location: "Warehouse-A-Shelf-12"
            priority: "high"
        
        - name: Stock alert
          payload:
            workflowId: "stock-alerts"
            event: "stock.low"
            productId: "PRD-002"
            currentStock: 5
            threshold: 10
            supplier: "BOSCH"
            reorderQuantity: 50

  schemas:
    PayboxCallbackPayload:
      type: object
      required:
        - Mt
        - Ref
        - Erreur
        - K
      properties:
        Mt:
          type: string
          description: Montant en centimes (ex 7790 = 77.90‚Ç¨)
          example: "7790"
        
        Ref:
          type: string
          description: R√©f√©rence commande unique
          example: "ORD-2024-001"
        
        Auto:
          type: string
          description: Code autorisation banque (si succ√®s)
          example: "123456"
        
        Erreur:
          type: string
          description: Code erreur Paybox (00000 = succ√®s)
          enum:
            - "00000"
            - "00001"
            - "00002"
            - "00003"
            - "00004"
            - "00008"
            - "00012"
            - "00017"
            - "00030"
            - "99999"
          example: "00000"
        
        Date:
          type: string
          description: Date transaction YYYYMMDD
          pattern: "^\\d{8}$"
          example: "20240115"
        
        Heure:
          type: string
          description: Heure transaction HHMMSS
          pattern: "^\\d{6}$"
          example: "143000"
        
        Pays:
          type: string
          description: Code pays ISO 3166-1 alpha-3
          example: "FRA"
        
        Carte:
          type: string
          description: Type de carte (VISA, MASTERCARD, etc.)
          example: "VISA"
        
        Sign:
          type: string
          description: Signature HMAC-SHA512 (alias de K)
          example: "ABC123DEF456..."
        
        K:
          type: string
          description: Signature HMAC-SHA512 (cl√© principale)
          example: "ABC123DEF456..."
    
    CyberPlusCallbackPayload:
      type: object
      required:
        - vads_amount
        - vads_order_id
        - vads_trans_status
        - signature
      properties:
        vads_amount:
          type: string
          description: Montant en centimes
          example: "7790"
        
        vads_order_id:
          type: string
          description: ID commande
          example: "ORD-2024-003"
        
        vads_trans_id:
          type: string
          description: ID transaction CyberPlus
          example: "654321"
        
        vads_trans_status:
          type: string
          enum:
            - AUTHORISED
            - REFUSED
            - CANCELLED
          example: "AUTHORISED"
        
        vads_auth_result:
          type: string
          description: Code r√©sultat autorisation
          example: "00"
        
        signature:
          type: string
          description: Signature HMAC-SHA256
          example: "fedcba987654..."
    
    TecDocUpdatePayload:
      type: object
      required:
        - eventType
        - productId
        - timestamp
      properties:
        eventType:
          type: string
          enum:
            - STOCK_UPDATE
            - PRICE_CHANGE
            - NEW_PRODUCT
            - DISCONTINUED
            - ATTRIBUTE_UPDATE
          description: Type de mise √† jour
          example: "STOCK_UPDATE"
        
        productId:
          type: string
          description: ID produit TecDoc
          example: "TD-123456"
        
        ean:
          type: string
          description: Code-barres EAN13
          pattern: "^\\d{13}$"
          example: "5012345678900"
        
        stock:
          type: integer
          description: Quantit√© en stock (si STOCK_UPDATE)
          minimum: 0
          example: 150
        
        priceHT:
          type: number
          format: double
          description: Prix HT (si PRICE_CHANGE)
          example: 45.90
        
        priceOld:
          type: number
          format: double
          description: Ancien prix HT
          example: 49.90
        
        currency:
          type: string
          description: Devise ISO 4217
          example: "EUR"
        
        supplier:
          type: string
          description: Nom fournisseur
          example: "VALEO"
        
        timestamp:
          type: string
          format: date-time
          description: Timestamp √©v√©nement
          example: "2024-01-15T14:30:00Z"
    
    CarrierTrackingPayload:
      type: object
      required:
        - trackingNumber
        - carrier
        - status
        - timestamp
      properties:
        trackingNumber:
          type: string
          description: Num√©ro de suivi colis
          example: "DHL123456789"
        
        carrier:
          type: string
          enum:
            - DHL
            - CHRONOPOST
            - COLISSIMO
            - UPS
            - FEDEX
          description: Code transporteur
          example: "DHL"
        
        status:
          type: string
          enum:
            - PICKED_UP
            - IN_TRANSIT
            - OUT_FOR_DELIVERY
            - DELIVERED
            - DELIVERY_FAILED
            - RETURNED
          description: Statut actuel du colis
          example: "DELIVERED"
        
        statusCode:
          type: string
          description: Code statut interne transporteur
          example: "OK"
        
        location:
          type: string
          description: Localisation actuelle
          example: "Paris 75001"
        
        timestamp:
          type: string
          format: date-time
          description: Timestamp √©v√©nement
          example: "2024-01-15T16:45:00Z"
        
        recipient:
          type: string
          description: Nom du destinataire (si livr√©)
          example: "Jean Dupont"
        
        signatureUrl:
          type: string
          format: uri
          description: URL preuve de livraison (POD)
          example: "https://dhl.com/pod/123456789.pdf"
        
        estimatedDelivery:
          type: string
          format: date-time
          description: Date de livraison estim√©e
          example: "2024-01-16T18:00:00Z"
    
    N8nWorkflowPayload:
      type: object
      required:
        - workflowId
        - event
      properties:
        workflowId:
          type: string
          description: ID du workflow n8n √† d√©clencher
          example: "order-fulfillment-v2"
        
        event:
          type: string
          description: Type d'√©v√©nement d√©clencheur
          example: "order.validated"
        
        data:
          type: object
          description: Payload flexible (structure libre)
          additionalProperties: true
          example:
            orderId: "ORD-2024-005"
            customerId: "CUST-12345"
        
        priority:
          type: string
          enum:
            - low
            - normal
            - high
            - urgent
          description: Priorit√© d'ex√©cution
          default: "normal"
          example: "high"
        
        metadata:
          type: object
          description: M√©tadonn√©es additionnelles
          properties:
            source:
              type: string
              example: "api"
            userId:
              type: string
              example: "admin-123"
            timestamp:
              type: string
              format: date-time
              example: "2024-01-15T14:30:00Z"

  securitySchemes:
    HmacSignature:
      type: httpApiKey
      name: X-Signature
      in: header
      description: Signature HMAC-SHA512 (Paybox) ou HMAC-SHA256 (autres)
    
    ApiKeyHeader:
      type: httpApiKey
      name: X-API-Key
      in: header
      description: Cl√© API secr√®te pour webhooks
    
    WebhookSecret:
      type: httpApiKey
      name: secret
      in: query
      description: Secret partag√© dans query parameter (n8n)

tags:
  - name: paybox
    description: Webhooks Paybox (paiements)
  
  - name: cyberplus
    description: Webhooks CyberPlus (legacy)
  
  - name: tecdoc
    description: Int√©gration TecDoc (catalogue)
  
  - name: shipping
    description: Webhooks transporteurs (tracking)
  
  - name: automation
    description: Automatisations n8n

externalDocs:
  description: Documentation compl√®te des webhooks
  url: https://docs.autoparts.com/webhooks
