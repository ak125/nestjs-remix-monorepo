#!/usr/bin/env bash
set -euo pipefail

# ----------------------------
# gov — Governance Vault runner
# dry-run → confirmation → signed commit → check-orphans → push
# ----------------------------

GOV_VAULT_DIR="${GOV_VAULT_DIR:-/opt/automecanik/governance-vault}"
NO_PUSH=0
FORCE_DRY_RUN=0
CUSTOM_MSG=""

usage() {
  cat <<'USAGE'
Usage:
  gov [--dry-run] [--no-push] [--message "commit message"] [--help]

Environment:
  GOV_VAULT_DIR=/path/to/governance-vault   (default: /opt/automecanik/governance-vault)

Behavior:
  - Default: run sync in dry-run, show changes, ask for confirmation.
  - If confirmed: apply sync (--commit), run orphan check, ensure last commit is signed, push.

Options:
  --dry-run        Only show what would change (no commit, no push).
  --no-push        Allow commit but do not push.
  --message "..."  Custom commit message for the sync commit (best effort).
  --help           Show help.

USAGE
}

info()  { echo "ℹ️  $*"; }
ok()    { echo "✅ $*"; }
warn()  { echo "⚠️  $*"; }
err()   { echo "❌ $*" 1>&2; }

need_cmd() {
  command -v "$1" >/dev/null 2>&1 || { err "Missing command: $1"; exit 1; }
}

# Parse args
while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry-run) FORCE_DRY_RUN=1; shift ;;
    --no-push) NO_PUSH=1; shift ;;
    --message) CUSTOM_MSG="${2:-}"; shift 2 ;;
    --help|-h) usage; exit 0 ;;
    *) err "Unknown argument: $1"; usage; exit 2 ;;
  esac
done

need_cmd git

if [[ ! -d "$GOV_VAULT_DIR/.git" ]]; then
  err "Vault directory not found or not a git repo: $GOV_VAULT_DIR"
  exit 1
fi

cd "$GOV_VAULT_DIR"

# Basic sanity
if [[ -z "$(git rev-parse --is-inside-work-tree 2>/dev/null || true)" ]]; then
  err "Not inside a git work tree: $GOV_VAULT_DIR"
  exit 1
fi

SYNC_SCRIPT="./scripts/sync-canon.sh"
ORPHANS_SCRIPT="./scripts/check-orphans.sh"

if [[ ! -x "$SYNC_SCRIPT" ]]; then
  err "Missing or non-executable: $SYNC_SCRIPT"
  err "Fix: chmod +x $SYNC_SCRIPT"
  exit 1
fi

if [[ ! -x "$ORPHANS_SCRIPT" ]]; then
  err "Missing or non-executable: $ORPHANS_SCRIPT"
  err "Fix: chmod +x $ORPHANS_SCRIPT"
  exit 1
fi

# Ensure signing is enabled in repo (we don't force global)
SIGNING="$(git config --get commit.gpgsign || true)"
FORMAT="$(git config --get gpg.format || true)"
SIGNKEY="$(git config --get user.signingkey || true)"

if [[ "$SIGNING" != "true" || "$FORMAT" != "ssh" || -z "$SIGNKEY" ]]; then
  warn "Git signing is not fully configured in this repo."
  warn "Expected: commit.gpgsign=true, gpg.format=ssh, user.signingkey set"
  warn "Current: commit.gpgsign=${SIGNING:-<unset>}, gpg.format=${FORMAT:-<unset>}, user.signingkey=${SIGNKEY:-<unset>}"
  err "Refusing to proceed (ledger requires signed commits)."
  exit 1
fi

# Show status
info "Vault: $GOV_VAULT_DIR"
info "Branch: $(git branch --show-current)"
info "Remote: $(git remote get-url origin 2>/dev/null || echo '<no origin>')"

# Ensure clean worktree before running (optional but safer)
if [[ -n "$(git status --porcelain)" ]]; then
  warn "Working tree is not clean. Showing status:"
  git status --porcelain
  warn "Proceeding is risky because changes may mix with sync output."
  read -r -p "Continue anyway? (y/N) " cont
  [[ "$cont" == "y" || "$cont" == "Y" ]] || { info "Aborted."; exit 0; }
fi

# Always start with dry-run
info "Running canon → vault sync (dry-run)..."
set +e
"$SYNC_SCRIPT"
SYNC_RC=$?
set -e

if [[ $SYNC_RC -ne 0 ]]; then
  err "sync-canon.sh failed in dry-run (exit=$SYNC_RC)."
  exit $SYNC_RC
fi

if [[ $FORCE_DRY_RUN -eq 1 ]]; then
  ok "Dry-run completed. No changes applied."
  exit 0
fi

# Ask confirmation
echo ""
read -r -p "Apply these changes to the vault and create a signed commit? (y/N) " ans
if [[ "$ans" != "y" && "$ans" != "Y" ]]; then
  ok "Nothing applied. Exiting."
  exit 0
fi

# Apply changes + commit (script-owned)
info "Applying sync (--commit)..."
if [[ -n "$CUSTOM_MSG" ]]; then
  # Best effort: if script supports message, pass it; otherwise ignore.
  # If your sync script doesn't support it, it will just ignore/err.
  "$SYNC_SCRIPT" --commit --message "$CUSTOM_MSG" 2>/dev/null || "$SYNC_SCRIPT" --commit
else
  "$SYNC_SCRIPT" --commit
fi

# Orphan check (hard block)
info "Running orphan check..."
"$ORPHANS_SCRIPT" .

# Verify last commit is signed
info "Verifying last commit signature..."
LOG_OUT="$(git log --show-signature -1 || true)"
echo "$LOG_OUT" | grep -q "Good \"git\" signature" || {
  err "Last commit does not show a Good signature. Refusing to push."
  err "Output was:"
  echo "$LOG_OUT"
  exit 1
}
ok "Signature OK."

# Push (optional)
if [[ $NO_PUSH -eq 1 ]]; then
  ok "No-push mode: changes committed locally. Push manually when ready."
  exit 0
fi

info "Pushing to origin..."
git push origin "$(git branch --show-current)"
ok "Done."
